// Code was modified to define NATS on window.GLANCE instead of directly on window
// GD-22344 on pages with require.js, define function caused issues
!function(e,t){t((e=window.GLANCE).NATS={})}
(this,(function(e){"use strict";const t=new Uint8Array(0),s=new TextEncoder,r=new TextDecoder;function i(...e){const r=[];for(let t=0;t<e.length;t++)r.push(s.encode(e[t]));return 0===r.length?t:1===r.length?r[0]:function(...e){let t=0;for(let s=0;s<e.length;s++)t+=e[s].length;const s=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++)s.set(e[t],r),r+=e[t].length;return s}(...r)}function n(e){return e&&0!==e.length?r.decode(e):""}const o="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";function a(e){globalThis?.crypto?.getRandomValues?globalThis.crypto.getRandomValues(e):function(e){for(let t=0;t<e.length;t++)e[t]=Math.floor(255*Math.random())}(e)}class c{buf;seq;inc;constructor(){this.buf=new Uint8Array(22),this.init()}init(){this.setPre(),this.initSeqAndInc(),this.fillSeq()}initSeqAndInc(){this.seq=Math.floor(0xcfd41b9100000*Math.random()),this.inc=Math.floor(300*Math.random()+33)}setPre(){const e=new Uint8Array(12);a(e);for(let t=0;t<12;t++){const s=e[t]%36;this.buf[t]=o.charCodeAt(s)}}fillSeq(){let e=this.seq;for(let t=21;t>=12;t--)this.buf[t]=o.charCodeAt(e%36),e=Math.floor(e/36)}next(){return this.seq+=this.inc,this.seq>0xcfd41b9100000&&(this.setPre(),this.initSeqAndInc()),this.fillSeq(),String.fromCharCode.apply(String,this.buf)}reset(){this.init()}}const h=new c;var u,l,d;e.Events=void 0,(u=e.Events||(e.Events={})).Disconnect="disconnect",u.Reconnect="reconnect",u.Update="update",u.LDM="ldm",u.Error="error",e.DebugEvents=void 0,(l=e.DebugEvents||(e.DebugEvents={})).Reconnecting="reconnecting",l.PingTimer="pingTimer",l.StaleConnection="staleConnection",l.ClientInitiatedReconnect="client initiated reconnect",e.ErrorCode=void 0,(d=e.ErrorCode||(e.ErrorCode={})).ApiError="BAD API",d.BadAuthentication="BAD_AUTHENTICATION",d.BadCreds="BAD_CREDS",d.BadHeader="BAD_HEADER",d.BadJson="BAD_JSON",d.BadPayload="BAD_PAYLOAD",d.BadSubject="BAD_SUBJECT",d.Cancelled="CANCELLED",d.ConnectionClosed="CONNECTION_CLOSED",d.ConnectionDraining="CONNECTION_DRAINING",d.ConnectionRefused="CONNECTION_REFUSED",d.ConnectionTimeout="CONNECTION_TIMEOUT",d.Disconnect="DISCONNECT",d.InvalidOption="INVALID_OPTION",d.InvalidPayload="INVALID_PAYLOAD",d.MaxPayloadExceeded="MAX_PAYLOAD_EXCEEDED",d.NoResponders="503",d.NotFunction="NOT_FUNC",d.RequestError="REQUEST_ERROR",d.ServerOptionNotAvailable="SERVER_OPT_NA",d.SubClosed="SUB_CLOSED",d.SubDraining="SUB_DRAINING",d.Timeout="TIMEOUT",d.Tls="TLS",d.Unknown="UNKNOWN_ERROR",d.WssRequired="WSS_REQUIRED",d.JetStreamInvalidAck="JESTREAM_INVALID_ACK",d.JetStream404NoMessages="404",d.JetStream408RequestTimeout="408",d.JetStream409MaxAckPendingExceeded="409",d.JetStream409="409",d.JetStreamNotEnabled="503",d.JetStreamIdleHeartBeat="IDLE_HEARTBEAT",d.AuthorizationViolation="AUTHORIZATION_VIOLATION",d.AuthenticationExpired="AUTHENTICATION_EXPIRED",d.ProtocolError="NATS_PROTOCOL_ERR",d.PermissionsViolation="PERMISSIONS_VIOLATION",d.AuthenticationTimeout="AUTHENTICATION_TIMEOUT";class f{messages;constructor(){this.messages=new Map,this.messages.set(e.ErrorCode.InvalidPayload,"Invalid payload type - payloads can be 'binary', 'string', or 'json'"),this.messages.set(e.ErrorCode.BadJson,"Bad JSON"),this.messages.set(e.ErrorCode.WssRequired,"TLS is required, therefore a secure websocket connection is also required")}static getMessage(e){return p.getMessage(e)}getMessage(e){return this.messages.get(e)||e}}const p=new f;class m extends Error{name;message;code;permissionContext;chainedError;api_error;constructor(e,t,s){super(e),this.name="NatsError",this.message=e,this.code=t,this.chainedError=s}static errorForCode(e,t){const s=f.getMessage(e);return new m(s,e,t)}isAuthError(){return this.code===e.ErrorCode.AuthenticationExpired||this.code===e.ErrorCode.AuthorizationViolation}isAuthTimeout(){return this.code===e.ErrorCode.AuthenticationTimeout}isPermissionError(){return this.code===e.ErrorCode.PermissionsViolation}isProtocolError(){return this.code===e.ErrorCode.ProtocolError}isJetStreamError(){return void 0!==this.api_error}jsError(){return this.api_error?this.api_error:null}}var g,b,y;e.Match=void 0,(g=e.Match||(e.Match={}))[g.Exact=0]="Exact",g[g.CanonicalMIME=1]="CanonicalMIME",g[g.IgnoreCase=2]="IgnoreCase",e.RequestStrategy=void 0,(b=e.RequestStrategy||(e.RequestStrategy={})).Timer="timer",b.Count="count",b.JitterTimer="jitterTimer",b.SentinelMsg="sentinelMsg",e.ServiceResponseType=void 0,(y=e.ServiceResponseType||(e.ServiceResponseType={})).STATS="io.nats.micro.v1.stats_response",y.INFO="io.nats.micro.v1.info_response",y.PING="io.nats.micro.v1.ping_response";const _="Nats-Service-Error",w="Nats-Service-Error-Code";class v extends Error{code;constructor(e,t){super(t),this.code=e}static isServiceError(e){return null!==v.toServiceError(e)}static toServiceError(e){const t=e?.headers?.get(w)||"";if(""!==t){const s=parseInt(t)||400,r=e?.headers?.get(_)||"";return new v(s,r.length?r:t)}return null}}function S(e=""){if("string"!=typeof(e=e||"_INBOX"))throw new Error("prefix must be a string");return e.split(".").forEach((t=>{if("*"===t||">"===t)throw new Error(`inbox prefixes cannot have wildcards '${e}'`)})),`${e}.${h.next()}`}const E="127.0.0.1";var P;function C(e,...t){for(let s=0;s<t.length;s++){const r=t[s];Object.keys(r).forEach((function(t){e[t]=r[t]}))}return e}function x(e){return r.decode(e).replace(/\n/g,"␊").replace(/\r/g,"␍")}function A(t,s=!0){const r=s?m.errorForCode(e.ErrorCode.Timeout):null;let i,n;const o=new Promise(((s,o)=>{i={cancel:()=>{n&&clearTimeout(n)}},n=setTimeout((()=>{o(null===r?m.errorForCode(e.ErrorCode.Timeout):r)}),t)}));return Object.assign(o,i)}function k(e=0){return new Promise((t=>{setTimeout((()=>{t()}),e)}))}function j(){let e={};const t=new Promise(((t,s)=>{e={resolve:t,reject:s}}));return Object.assign(t,e)}function O(e){for(let t=e.length-1;t>0;t--){const s=Math.floor(Math.random()*(t+1));[e[t],e[s]]=[e[s],e[t]]}return e}e.ServiceVerb=void 0,(P=e.ServiceVerb||(e.ServiceVerb={})).PING="PING",P.STATS="STATS",P.INFO="INFO";class M{timers;measures;constructor(){this.timers=new Map,this.measures=new Map}mark(e){this.timers.set(e,performance.now())}measure(e,t,s){const r=this.timers.get(t);if(void 0===r)throw new Error(`${t} is not defined`);const i=this.timers.get(s);if(void 0===i)throw new Error(`${s} is not defined`);this.measures.set(e,i-r)}getEntries(){const e=[];return this.measures.forEach(((t,s)=>{e.push({name:s,duration:t})})),e}}function I(e=[0,250,250,500,500,3e3,5e3]){Array.isArray(e)||(e=[0,250,250,500,500,3e3,5e3]);const t=e.length-1;return{backoff(s){return 0===(r=s>t?e[t]:e[s])?0:Math.floor(r/2+Math.random()*r);var r}}}class N{buffers;byteLength;constructor(){this.buffers=[],this.byteLength=0}static concat(...e){let t=0;for(let s=0;s<e.length;s++)t+=e[s].length;const s=new Uint8Array(t);let r=0;for(let t=0;t<e.length;t++)s.set(e[t],r),r+=e[t].length;return s}static fromAscii(e){return e||(e=""),s.encode(e)}static toAscii(e){return r.decode(e)}reset(){this.buffers.length=0,this.byteLength=0}pack(){if(this.buffers.length>1){const e=new Uint8Array(this.byteLength);let t=0;for(let s=0;s<this.buffers.length;s++)e.set(this.buffers[s],t),t+=this.buffers[s].length;this.buffers.length=0,this.buffers.push(e)}}shift(){if(this.buffers.length){const e=this.buffers.shift();if(e)return this.byteLength-=e.length,e}return new Uint8Array(0)}drain(e){if(this.buffers.length){this.pack();const t=this.buffers.pop();if(t){const s=this.byteLength;(void 0===e||e>s)&&(e=s);const r=t.subarray(0,e);return s>e&&this.buffers.push(t.subarray(e)),this.byteLength=s-e,r}}return new Uint8Array(0)}fill(e,...t){e&&(this.buffers.push(e),this.byteLength+=e.length);for(let e=0;e<t.length;e++)t[e]&&t[e].length&&(this.buffers.push(t[e]),this.byteLength+=t[e].length)}peek(){return this.buffers.length?(this.pack(),this.buffers[0]):new Uint8Array(0)}size(){return this.byteLength}length(){return this.buffers.length}}let R;function $(){return void 0!==R&&void 0!==R.defaultPort?R.defaultPort:4222}function T(){return void 0!==R&&R.urlParseFn?R.urlParseFn:void 0}function q(){return void 0!==R&&R.dnsResolveFn?R.dnsResolveFn:void 0}const U="\r\n",L=N.fromAscii(U),F=new Uint8Array(L)[0],D=new Uint8Array(L)[1];function B(e){const t=function(e){for(let t=0;t<e.length;t++){const s=t+1;if(e.byteLength>s&&e[t]===F&&e[s]===D)return s+1}return 0}(e);if(t>0){const s=new Uint8Array(e).slice(0,t);return r.decode(s)}return""}const H=4,J=48,K=65,z=97;function G(e){return void 0!==function(e){for(let t=0;t<e.length;t++)switch(e[t]){case".":return V(e);case":":return W(e)}return}(e)}function V(e){const t=new Uint8Array(4);for(let s=0;s<4;s++){if(0===e.length)return;if(s>0){if("."!==e[0])return;e=e.substring(1)}const{n:r,c:i,ok:n}=Y(e);if(!n||r>255)return;e=e.substring(i),t[s]=r}return function(e,t,s,r){const i=new Uint8Array(16);return[0,0,0,0,0,0,0,0,0,0,255,255].forEach(((e,t)=>{i[t]=e})),i[12]=e,i[13]=t,i[14]=s,i[15]=r,i}(t[0],t[1],t[2],t[3])}function W(e){const t=new Uint8Array(16);let s=-1;if(e.length>=2&&":"===e[0]&&":"===e[1]&&(s=0,0===(e=e.substring(2)).length))return t;let r=0;for(;r<16;){const{n:i,c:n,ok:o}=X(e);if(!o||i>65535)return;if(n<e.length&&"."===e[n]){if(s<0&&12!=r)return;if(r+4>16)return;const i=V(e);if(void 0===i)return;t[r]=i[12],t[r+1]=i[13],t[r+2]=i[14],t[r+3]=i[15],e="",r+=H;break}if(t[r]=i>>8,t[r+1]=i,r+=2,0===(e=e.substring(n)).length)break;if(":"!==e[0]||1==e.length)return;if(":"===(e=e.substring(1))[0]){if(s>=0)return;if(s=r,0===(e=e.substring(1)).length)break}}if(0===e.length){if(r<16){if(s<0)return;const e=16-r;for(let i=r-1;i>=s;i--)t[i+e]=t[i];for(let r=s+e-1;r>=s;r--)t[r]=0}else if(s>=0)return;return t}}function Y(e){let t=0,s=0;for(t=0;t<e.length&&48<=e.charCodeAt(t)&&e.charCodeAt(t)<=57;t++)if(s=10*s+(e.charCodeAt(t)-J),s>=16777215)return{n:16777215,c:t,ok:!1};return 0===t?{n:0,c:0,ok:!1}:{n:s,c:t,ok:!0}}function X(e){let t=0,s=0;for(s=0;s<e.length;s++){if(48<=e.charCodeAt(s)&&e.charCodeAt(s)<=57)t*=16,t+=e.charCodeAt(s)-J;else if(97<=e.charCodeAt(s)&&e.charCodeAt(s)<=102)t*=16,t+=e.charCodeAt(s)-z+10;else{if(!(65<=e.charCodeAt(s)&&e.charCodeAt(s)<=70))break;t*=16,t+=e.charCodeAt(s)-K+10}if(t>=16777215)return{n:0,c:s,ok:!1}}return 0===s?{n:0,c:s,ok:!1}:{n:t,c:s,ok:!0}}function Q(e){return!function(e){return-1!==e.indexOf(".")||-1===e.indexOf("[")&&-1===e.indexOf("::")&&e.split(":").length<=2}(e)}class Z{src;listen;hostname;port;didConnect;reconnects;lastConnect;gossiped;tlsName;resolves;constructor(e,t=!1){this.src=e,this.tlsName="";const s=function(e){(e=e.trim()).match(/^(.*:\/\/)(.*)/m)&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2")),Q(e=function(e){const t="::FFFF:",s=e.toUpperCase().indexOf(t);if(-1!==s&&-1!==e.indexOf(".")){let t=e.substring(s+7);return t=t.replace("[",""),t.replace("]","")}return e}(e))&&-1===e.indexOf("[")&&(e=`[${e}]`);const t=Q(e)?e.match(/(]:)(\d+)/):e.match(/(:)(\d+)/),s=t&&3===t.length&&t[1]&&t[2]?parseInt(t[2]):4222,r=new URL(`${80===s?"https":"http"}://${e}`);r.port=`${s}`;let i=r.hostname;return"["===i.charAt(0)&&(i=i.substring(1,i.length-1)),{listen:r.host,hostname:i,port:s}}(e);this.listen=s.listen,this.hostname=s.hostname,this.port=s.port,this.didConnect=!1,this.reconnects=0,this.lastConnect=0,this.gossiped=t}toString(){return this.listen}async resolve(e){if(!e.fn)return[this];const t=[];if(G(this.hostname))return[this];{const s=await e.fn(this.hostname);e.debug&&console.log(`resolve ${this.hostname} = ${s.join(",")}`);for(const e of s){const s=80===this.port?"https":"http",r=new URL(`${s}://${Q(e)?"["+e+"]":e}`);r.port=`${this.port}`;const i=new Z(r.host,!1);i.tlsName=this.hostname,t.push(i)}}return e.randomize&&O(t),this.resolves=t,t}}class ee{firstSelect;servers;currentServer;tlsName;randomize;constructor(e=[],t={}){this.firstSelect=!0,this.servers=[],this.tlsName="",this.randomize=t.randomize||!1;const s=T();e&&(e.forEach((e=>{e=s?s(e):e,this.servers.push(new Z(e))})),this.randomize&&(this.servers=O(this.servers))),0===this.servers.length&&this.addServer(`${E}:${$()}`,!1),this.currentServer=this.servers[0]}clear(){this.servers.length=0}updateTLSName(){const e=this.getCurrentServer();G(e.hostname)||(this.tlsName=e.hostname,this.servers.forEach((e=>{e.gossiped&&(e.tlsName=this.tlsName)})))}getCurrentServer(){return this.currentServer}addServer(e,t=!1){const s=T();e=s?s(e):e;const r=new Z(e,t);G(r.hostname)&&(r.tlsName=this.tlsName),this.servers.push(r)}selectServer(){if(this.firstSelect)return this.firstSelect=!1,this.currentServer;const e=this.servers.shift();return e&&(this.servers.push(e),this.currentServer=e),e}removeCurrentServer(){this.removeServer(this.currentServer)}removeServer(e){if(e){const t=this.servers.indexOf(e);this.servers.splice(t,1)}}length(){return this.servers.length}next(){return this.servers.length?this.servers[0]:void 0}getServers(){return this.servers}update(e){const t=[];let s=[];const r=T(),i=new Map;e.connect_urls&&e.connect_urls.length>0&&e.connect_urls.forEach((e=>{e=r?r(e):e;const t=new Z(e,!0);i.set(e,t)}));const n=[];return this.servers.forEach(((e,t)=>{const s=e.listen;e.gossiped&&this.currentServer.listen!==s&&void 0===i.get(s)&&n.push(t),i.delete(s)})),n.reverse(),n.forEach((e=>{const t=this.servers.splice(e,1);s=s.concat(t[0].listen)})),i.forEach(((e,s)=>{this.servers.push(e),t.push(s)})),{added:t,deleted:s}}}class te{inflight;processed;received;noIterator;iterClosed;done;signal;yields;filtered;pendingFiltered;ingestionFilterFn;protocolFilterFn;dispatchedFn;ctx;_data;err;time;yielding;constructor(){this.inflight=0,this.filtered=0,this.pendingFiltered=0,this.processed=0,this.received=0,this.noIterator=!1,this.done=!1,this.signal=j(),this.yields=[],this.iterClosed=j(),this.time=0,this.yielding=!1}[Symbol.asyncIterator](){return this.iterate()}push(e){if(this.done)return;if("function"==typeof e)return this.yields.push(e),void this.signal.resolve();const{ingest:t,protocol:s}=this.ingestionFilterFn?this.ingestionFilterFn(e,this.ctx||this):{ingest:!0,protocol:!1};t&&(s&&(this.filtered++,this.pendingFiltered++),this.yields.push(e),this.signal.resolve())}async*iterate(){if(this.noIterator)throw new m("unsupported iterator",e.ErrorCode.ApiError);if(this.yielding)throw new m("already yielding",e.ErrorCode.ApiError);this.yielding=!0;try{for(;;){if(0===this.yields.length&&await this.signal,this.err)throw this.err;const e=this.yields;this.inflight=e.length,this.yields=[];for(let t=0;t<e.length;t++){if("function"==typeof e[t]){const s=e[t];try{s()}catch(e){throw e}if(this.err)throw this.err;continue}if(!this.protocolFilterFn||this.protocolFilterFn(e[t])){this.processed++;const s=Date.now();yield e[t],this.time=Date.now()-s,this.dispatchedFn&&e[t]&&this.dispatchedFn(e[t])}else this.pendingFiltered--;this.inflight--}if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=j())}}finally{this.stop()}}stop(e){this.done||(this.err=e,this.done=!0,this.signal.resolve(),this.iterClosed.resolve())}getProcessed(){return this.noIterator?this.received:this.processed}getPending(){return this.yields.length+this.inflight-this.pendingFiltered}getReceived(){return this.received-this.filtered}}function se(t){let s=!0;const r=new Array(t.length);for(let i=0;i<t.length;i++){let n=t.charCodeAt(i);if(58===n||n<33||n>126)throw new m(`'${t[i]}' is not a valid character for a header key`,e.ErrorCode.BadHeader);s&&97<=n&&n<=122?n-=32:!s&&65<=n&&n<=90&&(n+=32),r[i]=n,s=45==n}return String.fromCharCode(...r)}function re(e=0,t=""){if(0===e&&""!==t||e>0&&""===t)throw new Error("setting status requires both code and description");return new ne(e,t)}const ie="NATS/1.0";class ne{_code;headers;_description;constructor(e=0,t=""){this._code=e,this._description=t,this.headers=new Map}[Symbol.iterator](){return this.headers.entries()}size(){return this.headers.size}equals(e){if(e&&this.headers.size===e.headers.size&&this._code===e._code){for(const[t,s]of this.headers){const r=e.values(t);if(s.length!==r.length)return!1;const i=[...s].sort(),n=[...r].sort();for(let e=0;e<i.length;e++)if(i[e]!==n[e])return!1}return!0}return!1}static decode(e){const t=new ne,s=r.decode(e).split("\r\n"),i=s[0];if(i!==ie){let e=i.replace(ie,"").trim();if(e.length>0){t._code=parseInt(e,10),isNaN(t._code)&&(t._code=0);const s=t._code.toString();e=e.replace(s,""),t._description=e.trim()}}return s.length>=1&&s.slice(1).map((e=>{if(e){const s=e.indexOf(":");if(s>-1){const r=e.slice(0,s),i=e.slice(s+1).trim();t.append(r,i)}}})),t}toString(){if(0===this.headers.size&&0===this._code)return"";let e=ie;this._code>0&&""!==this._description&&(e+=` ${this._code} ${this._description}`);for(const[t,s]of this.headers)for(let r=0;r<s.length;r++)e=`${e}\r\n${t}: ${s[r]}`;return`${e}\r\n\r\n`}encode(){return s.encode(this.toString())}static validHeaderValue(t){if(/[\r\n]/.test(t))throw new m("invalid header value - \\r and \\n are not allowed.",e.ErrorCode.BadHeader);return t.trim()}keys(){const e=[];for(const t of this.headers.keys())e.push(t);return e}findKeys(t,s=e.Match.Exact){const r=this.keys();switch(s){case e.Match.Exact:return r.filter((e=>e===t));case e.Match.CanonicalMIME:return t=se(t),r.filter((e=>e===t));default:{const e=t.toLowerCase();return r.filter((t=>e===t.toLowerCase()))}}}get(t,s=e.Match.Exact){const r=this.findKeys(t,s);if(r.length){const e=this.headers.get(r[0]);if(e)return Array.isArray(e)?e[0]:e}return""}last(t,s=e.Match.Exact){const r=this.findKeys(t,s);if(r.length){const e=this.headers.get(r[0]);if(e)return Array.isArray(e)?e[e.length-1]:e}return""}has(t,s=e.Match.Exact){return this.findKeys(t,s).length>0}set(t,s,r=e.Match.Exact){this.delete(t,r),this.append(t,s,r)}append(t,s,r=e.Match.Exact){const i=se(t);r===e.Match.CanonicalMIME&&(t=i);const n=this.findKeys(t,r);t=n.length>0?n[0]:t;const o=ne.validHeaderValue(s);let a=this.headers.get(t);a||(a=[],this.headers.set(t,a)),a.push(o)}values(t,s=e.Match.Exact){const r=[];return this.findKeys(t,s).forEach((e=>{const t=this.headers.get(e);t&&r.push(...t)})),r}delete(t,s=e.Match.Exact){this.findKeys(t,s).forEach((e=>{this.headers.delete(e)}))}get hasError(){return this._code>=300}get status(){return`${this._code} ${this._description}`.trim()}toRecord(){const e={};return this.keys().forEach((t=>{e[t]=this.values(t)})),e}get code(){return this._code}get description(){return this._description}static fromRecord(e){const t=new ne;for(const s in e)t.headers.set(s,e[s]);return t}}function oe(){return{encode:e=>s.encode(e),decode:e=>r.decode(e)}}function ae(t){return{encode(t){try{return void 0===t&&(t=null),s.encode(JSON.stringify(t))}catch(t){throw m.errorForCode(e.ErrorCode.BadJson,t)}},decode(s){try{return JSON.parse(r.decode(s),t)}catch(t){throw m.errorForCode(e.ErrorCode.BadJson,t)}}}}function ce(t){return t&&0===t.data.length&&503===t.headers?.code?m.errorForCode(e.ErrorCode.NoResponders):null}class he{_headers;_msg;_rdata;_reply;_subject;publisher;static jc;constructor(e,t,s){this._msg=e,this._rdata=t,this.publisher=s}get subject(){return this._subject||(this._subject=r.decode(this._msg.subject)),this._subject}get reply(){return this._reply||(this._reply=r.decode(this._msg.reply)),this._reply}get sid(){return this._msg.sid}get headers(){if(this._msg.hdr>-1&&!this._headers){const e=this._rdata.subarray(0,this._msg.hdr);this._headers=ne.decode(e)}return this._headers}get data(){return this._rdata?this._msg.hdr>-1?this._rdata.subarray(this._msg.hdr):this._rdata:new Uint8Array(0)}respond(e=t,s){return!!this.reply&&(this.publisher.publish(this.reply,e,s),!0)}size(){return this._msg.subject.length+(this._msg.reply?.length||0)+(-1===this._msg.size?0:this._msg.size)}json(e){return ae(e).decode(this.data)}string(){return r.decode(this.data)}}class ue{baseInbox;reqs;constructor(){this.reqs=new Map}size(){return this.reqs.size}init(e){return this.baseInbox=`${S(e)}.`,this.baseInbox}add(e){isNaN(e.received)||(e.received=0),this.reqs.set(e.token,e)}get(e){return this.reqs.get(e)}cancel(e){this.reqs.delete(e.token)}getToken(e){const t=e.subject||"";return 0===t.indexOf(this.baseInbox)?t.substring(this.baseInbox.length):null}all(){return Array.from(this.reqs.values())}handleError(e,t){if(t&&t.permissionContext){if(e)return this.all().forEach((e=>{e.resolver(t,{})})),!0;const s=t.permissionContext;if("publish"===s.operation){const e=this.all().find((e=>e.requestSubject===s.subject));if(e)return e.resolver(t,{}),!0}}return!1}dispatcher(){return(e,t)=>{const s=this.getToken(t);if(s){const r=this.get(s);r&&(null===e&&t.headers&&(e=ce(t)),r.resolver(e,t))}}}close(){const t=m.errorForCode(e.ErrorCode.Timeout);this.reqs.forEach((e=>{e.resolver(t,{})}))}}class le{ph;interval;maxOut;timer;pendings;constructor(e,t,s){this.ph=e,this.interval=t,this.maxOut=s,this.pendings=[]}start(){this.cancel(),this._schedule()}cancel(e){this.timer&&(clearTimeout(this.timer),this.timer=void 0),this._reset(),e&&this.ph.disconnect()}_schedule(){this.timer=setTimeout((()=>{if(this.ph.dispatchStatus({type:e.DebugEvents.PingTimer,data:`${this.pendings.length+1}`}),this.pendings.length===this.maxOut)return void this.cancel(!0);const t=j();this.ph.flush(t).then((()=>{this._reset()})).catch((()=>{this.cancel()})),this.pendings.push(t),this._schedule()}),this.interval)}_reset(){this.pendings=this.pendings.filter((e=>(e.resolve(),!1)))}}class de extends Error{constructor(e){super(e),this.name="AssertionError"}}const fe=2**32-2;function pe(e,t,s=0){const r=t.byteLength-s;return e.byteLength>r&&(e=e.subarray(0,r)),t.set(e,s),e.byteLength}class me{_buf;_off;constructor(e){this._off=0,this._buf=null!=e?new Uint8Array(e):new Uint8Array(0)}bytes(e={copy:!0}){return!1===e.copy?this._buf.subarray(this._off):this._buf.slice(this._off)}empty(){return this._buf.byteLength<=this._off}get length(){return this._buf.byteLength-this._off}get capacity(){return this._buf.buffer.byteLength}truncate(e){if(0!==e){if(e<0||e>this.length)throw Error("bytes.Buffer: truncation out of range");this._reslice(this._off+e)}else this.reset()}reset(){this._reslice(0),this._off=0}_tryGrowByReslice(e){const t=this._buf.byteLength;return e<=this.capacity-t?(this._reslice(t+e),t):-1}_reslice(e){!function(e,t="Assertion failed."){if(!e)throw new de(t)}(e<=this._buf.buffer.byteLength),this._buf=new Uint8Array(this._buf.buffer,0,e)}readByte(){const e=new Uint8Array(1);return this.read(e)?e[0]:null}read(e){if(this.empty())return this.reset(),0===e.byteLength?0:null;const t=pe(this._buf.subarray(this._off),e);return this._off+=t,t}writeByte(e){return this.write(Uint8Array.of(e))}writeString(e){return this.write(s.encode(e))}write(e){const t=this._grow(e.byteLength);return pe(e,this._buf,t)}_grow(e){const t=this.length;0===t&&0!==this._off&&this.reset();const s=this._tryGrowByReslice(e);if(s>=0)return s;const r=this.capacity;if(e<=Math.floor(r/2)-t)pe(this._buf.subarray(this._off),this._buf);else{if(r+e>fe)throw new Error("The buffer cannot be grown beyond the maximum size.");{const t=new Uint8Array(Math.min(2*r+e,fe));pe(this._buf.subarray(this._off),t),this._buf=t}}return this._off=0,this._reslice(Math.min(t+e,fe)),t}grow(e){if(e<0)throw Error("Buffer._grow: negative count");const t=this._grow(e);this._reslice(t)}readFrom(e){let t=0;const s=new Uint8Array(32768);for(;;){const r=this.capacity-this.length<32768,i=r?s:new Uint8Array(this._buf.buffer,this.length),n=e.read(i);if(null===n)return t;r?this.write(i.subarray(0,n)):this._reslice(this.length+n),t+=n}}}var ge;function be(){const e={sid:-1,hdr:-1,size:-1};return e}!function(e){e[e.OK=0]="OK",e[e.ERR=1]="ERR",e[e.MSG=2]="MSG",e[e.INFO=3]="INFO",e[e.PING=4]="PING",e[e.PONG=5]="PONG"}(ge||(ge={}));class ye{dispatcher;state;as;drop;hdr;ma;argBuf;msgBuf;constructor(e){this.dispatcher=e,this.state=_e.OP_START,this.as=0,this.drop=0,this.hdr=0}parse(e){let t;for(t=0;t<e.length;t++){const s=e[t];switch(this.state){case _e.OP_START:switch(s){case we.M:case we.m:this.state=_e.OP_M,this.hdr=-1,this.ma=be();break;case we.H:case we.h:this.state=_e.OP_H,this.hdr=0,this.ma=be();break;case we.P:case we.p:this.state=_e.OP_P;break;case we.PLUS:this.state=_e.OP_PLUS;break;case we.MINUS:this.state=_e.OP_MINUS;break;case we.I:case we.i:this.state=_e.OP_I;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_H:switch(s){case we.M:case we.m:this.state=_e.OP_M;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_M:switch(s){case we.S:case we.s:this.state=_e.OP_MS;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_MS:switch(s){case we.G:case we.g:this.state=_e.OP_MSG;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_MSG:switch(s){case we.SPACE:case we.TAB:this.state=_e.OP_MSG_SPC;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_MSG_SPC:switch(s){case we.SPACE:case we.TAB:continue;default:this.state=_e.MSG_ARG,this.as=t}break;case _e.MSG_ARG:switch(s){case we.CR:this.drop=1;break;case we.NL:{const s=this.argBuf?this.argBuf.bytes():e.subarray(this.as,t-this.drop);this.processMsgArgs(s),this.drop=0,this.as=t+1,this.state=_e.MSG_PAYLOAD,t=this.as+this.ma.size-1;break}default:this.argBuf&&this.argBuf.writeByte(s)}break;case _e.MSG_PAYLOAD:if(this.msgBuf)if(this.msgBuf.length>=this.ma.size){const e=this.msgBuf.bytes({copy:!1});this.dispatcher.push({kind:ge.MSG,msg:this.ma,data:e}),this.argBuf=void 0,this.msgBuf=void 0,this.state=_e.MSG_END}else{let r=this.ma.size-this.msgBuf.length;const i=e.length-t;i<r&&(r=i),r>0?(this.msgBuf.write(e.subarray(t,t+r)),t=t+r-1):this.msgBuf.writeByte(s)}else t-this.as>=this.ma.size&&(this.dispatcher.push({kind:ge.MSG,msg:this.ma,data:e.subarray(this.as,t)}),this.argBuf=void 0,this.msgBuf=void 0,this.state=_e.MSG_END);break;case _e.MSG_END:if(s!==we.NL)continue;this.drop=0,this.as=t+1,this.state=_e.OP_START;break;case _e.OP_PLUS:switch(s){case we.O:case we.o:this.state=_e.OP_PLUS_O;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_PLUS_O:switch(s){case we.K:case we.k:this.state=_e.OP_PLUS_OK;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_PLUS_OK:if(s===we.NL)this.dispatcher.push({kind:ge.OK}),this.drop=0,this.state=_e.OP_START;break;case _e.OP_MINUS:switch(s){case we.E:case we.e:this.state=_e.OP_MINUS_E;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_MINUS_E:switch(s){case we.R:case we.r:this.state=_e.OP_MINUS_ER;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_MINUS_ER:switch(s){case we.R:case we.r:this.state=_e.OP_MINUS_ERR;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_MINUS_ERR:switch(s){case we.SPACE:case we.TAB:this.state=_e.OP_MINUS_ERR_SPC;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_MINUS_ERR_SPC:switch(s){case we.SPACE:case we.TAB:continue;default:this.state=_e.MINUS_ERR_ARG,this.as=t}break;case _e.MINUS_ERR_ARG:switch(s){case we.CR:this.drop=1;break;case we.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:ge.ERR,data:s}),this.drop=0,this.as=t+1,this.state=_e.OP_START;break}default:this.argBuf&&this.argBuf.write(Uint8Array.of(s))}break;case _e.OP_P:switch(s){case we.I:case we.i:this.state=_e.OP_PI;break;case we.O:case we.o:this.state=_e.OP_PO;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_PO:switch(s){case we.N:case we.n:this.state=_e.OP_PON;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_PON:switch(s){case we.G:case we.g:this.state=_e.OP_PONG;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_PONG:if(s===we.NL)this.dispatcher.push({kind:ge.PONG}),this.drop=0,this.state=_e.OP_START;break;case _e.OP_PI:switch(s){case we.N:case we.n:this.state=_e.OP_PIN;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_PIN:switch(s){case we.G:case we.g:this.state=_e.OP_PING;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_PING:if(s===we.NL)this.dispatcher.push({kind:ge.PING}),this.drop=0,this.state=_e.OP_START;break;case _e.OP_I:switch(s){case we.N:case we.n:this.state=_e.OP_IN;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_IN:switch(s){case we.F:case we.f:this.state=_e.OP_INF;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_INF:switch(s){case we.O:case we.o:this.state=_e.OP_INFO;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_INFO:switch(s){case we.SPACE:case we.TAB:this.state=_e.OP_INFO_SPC;break;default:throw this.fail(e.subarray(t))}break;case _e.OP_INFO_SPC:switch(s){case we.SPACE:case we.TAB:continue;default:this.state=_e.INFO_ARG,this.as=t}break;case _e.INFO_ARG:switch(s){case we.CR:this.drop=1;break;case we.NL:{let s;this.argBuf?(s=this.argBuf.bytes(),this.argBuf=void 0):s=e.subarray(this.as,t-this.drop),this.dispatcher.push({kind:ge.INFO,data:s}),this.drop=0,this.as=t+1,this.state=_e.OP_START;break}default:this.argBuf&&this.argBuf.writeByte(s)}break;default:throw this.fail(e.subarray(t))}}this.state!==_e.MSG_ARG&&this.state!==_e.MINUS_ERR_ARG&&this.state!==_e.INFO_ARG||this.argBuf||(this.argBuf=new me(e.subarray(this.as,t-this.drop))),this.state!==_e.MSG_PAYLOAD||this.msgBuf||(this.argBuf||this.cloneMsgArg(),this.msgBuf=new me(e.subarray(this.as)))}cloneMsgArg(){const e=this.ma.subject.length,t=this.ma.reply?this.ma.reply.length:0,s=new Uint8Array(e+t);s.set(this.ma.subject),this.ma.reply&&s.set(this.ma.reply,e),this.argBuf=new me(s),this.ma.subject=s.subarray(0,e),this.ma.reply&&(this.ma.reply=s.subarray(e))}processMsgArgs(e){if(this.hdr>=0)return this.processHeaderMsgArgs(e);const t=[];let s=-1;for(let r=0;r<e.length;r++){switch(e[r]){case we.SPACE:case we.TAB:case we.CR:case we.NL:s>=0&&(t.push(e.subarray(s,r)),s=-1);break;default:s<0&&(s=r)}}switch(s>=0&&t.push(e.subarray(s)),t.length){case 3:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.size=this.protoParseInt(t[2]);break;case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.size=this.protoParseInt(t[3]);break;default:throw this.fail(e,"processMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processMsgArgs Bad or Missing Sid Error");if(this.ma.size<0)throw this.fail(e,"processMsgArgs Bad or Missing Size Error")}fail(e,t=""){return t=t?`${t} [${this.state}]`:`parse error [${this.state}]`,new Error(`${t}: ${r.decode(e)}`)}processHeaderMsgArgs(e){const t=[];let s=-1;for(let r=0;r<e.length;r++){switch(e[r]){case we.SPACE:case we.TAB:case we.CR:case we.NL:s>=0&&(t.push(e.subarray(s,r)),s=-1);break;default:s<0&&(s=r)}}switch(s>=0&&t.push(e.subarray(s)),t.length){case 4:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=void 0,this.ma.hdr=this.protoParseInt(t[2]),this.ma.size=this.protoParseInt(t[3]);break;case 5:this.ma.subject=t[0],this.ma.sid=this.protoParseInt(t[1]),this.ma.reply=t[2],this.ma.hdr=this.protoParseInt(t[3]),this.ma.size=this.protoParseInt(t[4]);break;default:throw this.fail(e,"processHeaderMsgArgs Parse Error")}if(this.ma.sid<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Sid Error");if(this.ma.hdr<0||this.ma.hdr>this.ma.size)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Header Size Error");if(this.ma.size<0)throw this.fail(e,"processHeaderMsgArgs Bad or Missing Size Error")}protoParseInt(e){if(0===e.length)return-1;let t=0;for(let s=0;s<e.length;s++){if(e[s]<48||e[s]>57)return-1;t=10*t+(e[s]-48)}return t}}var _e,we,ve;function Se(e=""){const t=e.match(/(\d+).(\d+).(\d+)/);if(t)return{major:parseInt(t[1]),minor:parseInt(t[2]),micro:parseInt(t[3])};throw new Error(`'${e}' is not a semver value`)}function Ee(e,t){return e.major<t.major?-1:e.major>t.major?1:e.minor<t.minor?-1:e.minor>t.minor?1:e.micro<t.micro?-1:e.micro>t.micro?1:0}!function(e){e[e.OP_START=0]="OP_START",e[e.OP_PLUS=1]="OP_PLUS",e[e.OP_PLUS_O=2]="OP_PLUS_O",e[e.OP_PLUS_OK=3]="OP_PLUS_OK",e[e.OP_MINUS=4]="OP_MINUS",e[e.OP_MINUS_E=5]="OP_MINUS_E",e[e.OP_MINUS_ER=6]="OP_MINUS_ER",e[e.OP_MINUS_ERR=7]="OP_MINUS_ERR",e[e.OP_MINUS_ERR_SPC=8]="OP_MINUS_ERR_SPC",e[e.MINUS_ERR_ARG=9]="MINUS_ERR_ARG",e[e.OP_M=10]="OP_M",e[e.OP_MS=11]="OP_MS",e[e.OP_MSG=12]="OP_MSG",e[e.OP_MSG_SPC=13]="OP_MSG_SPC",e[e.MSG_ARG=14]="MSG_ARG",e[e.MSG_PAYLOAD=15]="MSG_PAYLOAD",e[e.MSG_END=16]="MSG_END",e[e.OP_H=17]="OP_H",e[e.OP_P=18]="OP_P",e[e.OP_PI=19]="OP_PI",e[e.OP_PIN=20]="OP_PIN",e[e.OP_PING=21]="OP_PING",e[e.OP_PO=22]="OP_PO",e[e.OP_PON=23]="OP_PON",e[e.OP_PONG=24]="OP_PONG",e[e.OP_I=25]="OP_I",e[e.OP_IN=26]="OP_IN",e[e.OP_INF=27]="OP_INF",e[e.OP_INFO=28]="OP_INFO",e[e.OP_INFO_SPC=29]="OP_INFO_SPC",e[e.INFO_ARG=30]="INFO_ARG"}(_e||(_e={})),function(e){e[e.CR="\r".charCodeAt(0)]="CR",e[e.E="E".charCodeAt(0)]="E",e[e.e="e".charCodeAt(0)]="e",e[e.F="F".charCodeAt(0)]="F",e[e.f="f".charCodeAt(0)]="f",e[e.G="G".charCodeAt(0)]="G",e[e.g="g".charCodeAt(0)]="g",e[e.H="H".charCodeAt(0)]="H",e[e.h="h".charCodeAt(0)]="h",e[e.I="I".charCodeAt(0)]="I",e[e.i="i".charCodeAt(0)]="i",e[e.K="K".charCodeAt(0)]="K",e[e.k="k".charCodeAt(0)]="k",e[e.M="M".charCodeAt(0)]="M",e[e.m="m".charCodeAt(0)]="m",e[e.MINUS="-".charCodeAt(0)]="MINUS",e[e.N="N".charCodeAt(0)]="N",e[e.n="n".charCodeAt(0)]="n",e[e.NL="\n".charCodeAt(0)]="NL",e[e.O="O".charCodeAt(0)]="O",e[e.o="o".charCodeAt(0)]="o",e[e.P="P".charCodeAt(0)]="P",e[e.p="p".charCodeAt(0)]="p",e[e.PLUS="+".charCodeAt(0)]="PLUS",e[e.R="R".charCodeAt(0)]="R",e[e.r="r".charCodeAt(0)]="r",e[e.S="S".charCodeAt(0)]="S",e[e.s="s".charCodeAt(0)]="s",e[e.SPACE=" ".charCodeAt(0)]="SPACE",e[e.TAB="\t".charCodeAt(0)]="TAB"}(we||(we={})),function(e){e.JS_KV="js_kv",e.JS_OBJECTSTORE="js_objectstore",e.JS_PULL_MAX_BYTES="js_pull_max_bytes",e.JS_NEW_CONSUMER_CREATE_API="js_new_consumer_create",e.JS_ALLOW_DIRECT="js_allow_direct",e.JS_MULTIPLE_CONSUMER_FILTER="js_multiple_consumer_filter",e.JS_SIMPLIFICATION="js_simplification",e.JS_STREAM_CONSUMER_METADATA="js_stream_consumer_metadata",e.JS_CONSUMER_FILTER_SUBJECTS="js_consumer_filter_subjects",e.JS_STREAM_FIRST_SEQ="js_stream_first_seq",e.JS_STREAM_SUBJECT_TRANSFORM="js_stream_subject_transform",e.JS_STREAM_SOURCE_SUBJECT_TRANSFORM="js_stream_source_subject_transform",e.JS_STREAM_COMPRESSION="js_stream_compression",e.JS_DEFAULT_CONSUMER_LIMITS="js_default_consumer_limits"}(ve||(ve={}));class Pe{server;features;disabled;constructor(e){this.features=new Map,this.disabled=[],this.update(e)}resetDisabled(){this.disabled.length=0,this.update(this.server)}disable(e){this.disabled.push(e),this.update(this.server)}isDisabled(e){return-1!==this.disabled.indexOf(e)}update(e){"string"==typeof e&&(e=Se(e)),this.server=e,this.set(ve.JS_KV,"2.6.2"),this.set(ve.JS_OBJECTSTORE,"2.6.3"),this.set(ve.JS_PULL_MAX_BYTES,"2.8.3"),this.set(ve.JS_NEW_CONSUMER_CREATE_API,"2.9.0"),this.set(ve.JS_ALLOW_DIRECT,"2.9.0"),this.set(ve.JS_MULTIPLE_CONSUMER_FILTER,"2.10.0"),this.set(ve.JS_SIMPLIFICATION,"2.9.4"),this.set(ve.JS_STREAM_CONSUMER_METADATA,"2.10.0"),this.set(ve.JS_CONSUMER_FILTER_SUBJECTS,"2.10.0"),this.set(ve.JS_STREAM_FIRST_SEQ,"2.10.0"),this.set(ve.JS_STREAM_SUBJECT_TRANSFORM,"2.10.0"),this.set(ve.JS_STREAM_SOURCE_SUBJECT_TRANSFORM,"2.10.0"),this.set(ve.JS_STREAM_COMPRESSION,"2.10.0"),this.set(ve.JS_DEFAULT_CONSUMER_LIMITS,"2.10.0"),this.disabled.forEach((e=>{this.features.delete(e)}))}set(e,t){this.features.set(e,{min:t,ok:Ee(this.server,Se(t))>=0})}get(e){return this.features.get(e)||{min:"unknown",ok:!1}}supports(e){return this.get(e)?.ok||!1}require(e){return"string"==typeof e&&(e=Se(e)),Ee(this.server,e)>=0}}!function(e){var t=function(e,t){this.hi=0|e,this.lo=0|t},s=function(e){var t,s=new Float64Array(16);if(e)for(t=0;t<e.length;t++)s[t]=e[t];return s},r=function(){throw new Error("no PRNG")},i=new Uint8Array(16),n=new Uint8Array(32);n[0]=9;var o=s(),a=s([1]),c=s([56129,1]),h=s([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),u=s([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),l=s([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),d=s([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),f=s([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function p(e,t){return e<<t|e>>>32-t}function m(e,t){var s=255&e[t+3];return(s=(s=s<<8|255&e[t+2])<<8|255&e[t+1])<<8|255&e[t+0]}function g(e,s){var r=e[s]<<24|e[s+1]<<16|e[s+2]<<8|e[s+3],i=e[s+4]<<24|e[s+5]<<16|e[s+6]<<8|e[s+7];return new t(r,i)}function b(e,t,s){var r;for(r=0;r<4;r++)e[t+r]=255&s,s>>>=8}function y(e,t,s){e[t]=s.hi>>24&255,e[t+1]=s.hi>>16&255,e[t+2]=s.hi>>8&255,e[t+3]=255&s.hi,e[t+4]=s.lo>>24&255,e[t+5]=s.lo>>16&255,e[t+6]=s.lo>>8&255,e[t+7]=255&s.lo}function _(e,t,s,r,i){var n,o=0;for(n=0;n<i;n++)o|=e[t+n]^s[r+n];return(1&o-1>>>8)-1}function w(e,t,s,r){return _(e,t,s,r,16)}function v(e,t,s,r){return _(e,t,s,r,32)}function S(e,t,s,r,i){var n,o,a,c=new Uint32Array(16),h=new Uint32Array(16),u=new Uint32Array(16),l=new Uint32Array(4);for(n=0;n<4;n++)h[5*n]=m(r,4*n),h[1+n]=m(s,4*n),h[6+n]=m(t,4*n),h[11+n]=m(s,16+4*n);for(n=0;n<16;n++)u[n]=h[n];for(n=0;n<20;n++){for(o=0;o<4;o++){for(a=0;a<4;a++)l[a]=h[(5*o+4*a)%16];for(l[1]^=p(l[0]+l[3]|0,7),l[2]^=p(l[1]+l[0]|0,9),l[3]^=p(l[2]+l[1]|0,13),l[0]^=p(l[3]+l[2]|0,18),a=0;a<4;a++)c[4*o+(o+a)%4]=l[a]}for(a=0;a<16;a++)h[a]=c[a]}if(i){for(n=0;n<16;n++)h[n]=h[n]+u[n]|0;for(n=0;n<4;n++)h[5*n]=h[5*n]-m(r,4*n)|0,h[6+n]=h[6+n]-m(t,4*n)|0;for(n=0;n<4;n++)b(e,4*n,h[5*n]),b(e,16+4*n,h[6+n])}else for(n=0;n<16;n++)b(e,4*n,h[n]+u[n]|0)}function E(e,t,s,r){return S(e,t,s,r,!1),0}function P(e,t,s,r){return S(e,t,s,r,!0),0}var C=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function x(e,t,s,r,i,n,o){var a,c,h=new Uint8Array(16),u=new Uint8Array(64);if(!i)return 0;for(c=0;c<16;c++)h[c]=0;for(c=0;c<8;c++)h[c]=n[c];for(;i>=64;){for(E(u,h,o,C),c=0;c<64;c++)e[t+c]=(s?s[r+c]:0)^u[c];for(a=1,c=8;c<16;c++)a=a+(255&h[c])|0,h[c]=255&a,a>>>=8;i-=64,t+=64,s&&(r+=64)}if(i>0)for(E(u,h,o,C),c=0;c<i;c++)e[t+c]=(s?s[r+c]:0)^u[c];return 0}function A(e,t,s,r,i){return x(e,t,null,0,s,r,i)}function k(e,t,s,r,i){var n=new Uint8Array(32);return P(n,r,i,C),A(e,t,s,r.subarray(16),n)}function j(e,t,s,r,i,n,o){var a=new Uint8Array(32);return P(a,n,o,C),x(e,t,s,r,i,n.subarray(16),a)}function O(e,t){var s,r=0;for(s=0;s<17;s++)r=r+(e[s]+t[s]|0)|0,e[s]=255&r,r>>>=8}var M=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function I(e,t,s,r,i,n){var o,a,c,h,u=new Uint32Array(17),l=new Uint32Array(17),d=new Uint32Array(17),f=new Uint32Array(17),p=new Uint32Array(17);for(c=0;c<17;c++)l[c]=d[c]=0;for(c=0;c<16;c++)l[c]=n[c];for(l[3]&=15,l[4]&=252,l[7]&=15,l[8]&=252,l[11]&=15,l[12]&=252,l[15]&=15;i>0;){for(c=0;c<17;c++)f[c]=0;for(c=0;c<16&&c<i;++c)f[c]=s[r+c];for(f[c]=1,r+=c,i-=c,O(d,f),a=0;a<17;a++)for(u[a]=0,c=0;c<17;c++)u[a]=0|u[a]+d[c]*(c<=a?l[a-c]:320*l[a+17-c]|0);for(a=0;a<17;a++)d[a]=u[a];for(h=0,c=0;c<16;c++)h=h+d[c]|0,d[c]=255&h,h>>>=8;for(h=h+d[16]|0,d[16]=3&h,h=5*(h>>>2)|0,c=0;c<16;c++)h=h+d[c]|0,d[c]=255&h,h>>>=8;h=h+d[16]|0,d[16]=h}for(c=0;c<17;c++)p[c]=d[c];for(O(d,M),o=0|-(d[16]>>>7),c=0;c<17;c++)d[c]^=o&(p[c]^d[c]);for(c=0;c<16;c++)f[c]=n[c+16];for(f[16]=0,O(d,f),c=0;c<16;c++)e[t+c]=d[c];return 0}function N(e,t,s,r,i,n){var o=new Uint8Array(16);return I(o,0,s,r,i,n),w(e,t,o,0)}function R(e,t,s,r,i){var n;if(s<32)return-1;for(j(e,0,t,0,s,r,i),I(e,16,e,32,s-32,e),n=0;n<16;n++)e[n]=0;return 0}function $(e,t,s,r,i){var n,o=new Uint8Array(32);if(s<32)return-1;if(k(o,0,32,r,i),0!==N(t,16,t,32,s-32,o))return-1;for(j(e,0,t,0,s,r,i),n=0;n<32;n++)e[n]=0;return 0}function T(e,t){var s;for(s=0;s<16;s++)e[s]=0|t[s]}function q(e){var t,s;for(s=0;s<16;s++)e[s]+=65536,t=Math.floor(e[s]/65536),e[(s+1)*(s<15?1:0)]+=t-1+37*(t-1)*(15===s?1:0),e[s]-=65536*t}function U(e,t,s){for(var r,i=~(s-1),n=0;n<16;n++)r=i&(e[n]^t[n]),e[n]^=r,t[n]^=r}function L(e,t){var r,i,n,o=s(),a=s();for(r=0;r<16;r++)a[r]=t[r];for(q(a),q(a),q(a),i=0;i<2;i++){for(o[0]=a[0]-65517,r=1;r<15;r++)o[r]=a[r]-65535-(o[r-1]>>16&1),o[r-1]&=65535;o[15]=a[15]-32767-(o[14]>>16&1),n=o[15]>>16&1,o[14]&=65535,U(a,o,1-n)}for(r=0;r<16;r++)e[2*r]=255&a[r],e[2*r+1]=a[r]>>8}function F(e,t){var s=new Uint8Array(32),r=new Uint8Array(32);return L(s,e),L(r,t),v(s,0,r,0)}function D(e){var t=new Uint8Array(32);return L(t,e),1&t[0]}function B(e,t){var s;for(s=0;s<16;s++)e[s]=t[2*s]+(t[2*s+1]<<8);e[15]&=32767}function H(e,t,s){var r;for(r=0;r<16;r++)e[r]=t[r]+s[r]|0}function J(e,t,s){var r;for(r=0;r<16;r++)e[r]=t[r]-s[r]|0}function K(e,t,s){var r,i,n=new Float64Array(31);for(r=0;r<31;r++)n[r]=0;for(r=0;r<16;r++)for(i=0;i<16;i++)n[r+i]+=t[r]*s[i];for(r=0;r<15;r++)n[r]+=38*n[r+16];for(r=0;r<16;r++)e[r]=n[r];q(e),q(e)}function z(e,t){K(e,t,t)}function G(e,t){var r,i=s();for(r=0;r<16;r++)i[r]=t[r];for(r=253;r>=0;r--)z(i,i),2!==r&&4!==r&&K(i,i,t);for(r=0;r<16;r++)e[r]=i[r]}function V(e,t){var r,i=s();for(r=0;r<16;r++)i[r]=t[r];for(r=250;r>=0;r--)z(i,i),1!==r&&K(i,i,t);for(r=0;r<16;r++)e[r]=i[r]}function W(e,t,r){var i,n,o=new Uint8Array(32),a=new Float64Array(80),h=s(),u=s(),l=s(),d=s(),f=s(),p=s();for(n=0;n<31;n++)o[n]=t[n];for(o[31]=127&t[31]|64,o[0]&=248,B(a,r),n=0;n<16;n++)u[n]=a[n],d[n]=h[n]=l[n]=0;for(h[0]=d[0]=1,n=254;n>=0;--n)U(h,u,i=o[n>>>3]>>>(7&n)&1),U(l,d,i),H(f,h,l),J(h,h,l),H(l,u,d),J(u,u,d),z(d,f),z(p,h),K(h,l,h),K(l,u,f),H(f,h,l),J(h,h,l),z(u,h),J(l,d,p),K(h,l,c),H(h,h,d),K(l,l,h),K(h,d,p),K(d,u,a),z(u,f),U(h,u,i),U(l,d,i);for(n=0;n<16;n++)a[n+16]=h[n],a[n+32]=l[n],a[n+48]=u[n],a[n+64]=d[n];var m=a.subarray(32),g=a.subarray(16);return G(m,m),K(g,g,m),L(e,g),0}function Y(e,t){return W(e,t,n)}function X(e,t){return r(t,32),Y(e,t)}function Q(e,t,s){var r=new Uint8Array(32);return W(r,s,t),P(e,i,r,C)}var Z=R,ee=$;function te(){var e,s,r,i=0,n=0,o=0,a=0,c=65535;for(r=0;r<arguments.length;r++)i+=(e=arguments[r].lo)&c,n+=e>>>16,o+=(s=arguments[r].hi)&c,a+=s>>>16;return new t((o+=(n+=i>>>16)>>>16)&c|(a+=o>>>16)<<16,i&c|n<<16)}function se(e,s){return new t(e.hi>>>s,e.lo>>>s|e.hi<<32-s)}function re(){var e,s=0,r=0;for(e=0;e<arguments.length;e++)s^=arguments[e].lo,r^=arguments[e].hi;return new t(r,s)}function ie(e,s){var r,i,n=32-s;return s<32?(r=e.hi>>>s|e.lo<<n,i=e.lo>>>s|e.hi<<n):s<64&&(r=e.lo>>>s|e.hi<<n,i=e.hi>>>s|e.lo<<n),new t(r,i)}function ne(e,s,r){var i=e.hi&s.hi^~e.hi&r.hi,n=e.lo&s.lo^~e.lo&r.lo;return new t(i,n)}function oe(e,s,r){var i=e.hi&s.hi^e.hi&r.hi^s.hi&r.hi,n=e.lo&s.lo^e.lo&r.lo^s.lo&r.lo;return new t(i,n)}function ae(e){return re(ie(e,28),ie(e,34),ie(e,39))}function ce(e){return re(ie(e,14),ie(e,18),ie(e,41))}function he(e){return re(ie(e,1),ie(e,8),se(e,7))}function ue(e){return re(ie(e,19),ie(e,61),se(e,6))}var le=[new t(1116352408,3609767458),new t(1899447441,602891725),new t(3049323471,3964484399),new t(3921009573,2173295548),new t(961987163,4081628472),new t(1508970993,3053834265),new t(2453635748,2937671579),new t(2870763221,3664609560),new t(3624381080,2734883394),new t(310598401,1164996542),new t(607225278,1323610764),new t(1426881987,3590304994),new t(1925078388,4068182383),new t(2162078206,991336113),new t(2614888103,633803317),new t(3248222580,3479774868),new t(3835390401,2666613458),new t(4022224774,944711139),new t(264347078,2341262773),new t(604807628,2007800933),new t(770255983,1495990901),new t(1249150122,1856431235),new t(1555081692,3175218132),new t(1996064986,2198950837),new t(2554220882,3999719339),new t(2821834349,766784016),new t(2952996808,2566594879),new t(3210313671,3203337956),new t(3336571891,1034457026),new t(3584528711,2466948901),new t(113926993,3758326383),new t(338241895,168717936),new t(666307205,1188179964),new t(773529912,1546045734),new t(1294757372,1522805485),new t(1396182291,2643833823),new t(1695183700,2343527390),new t(1986661051,1014477480),new t(2177026350,1206759142),new t(2456956037,344077627),new t(2730485921,1290863460),new t(2820302411,3158454273),new t(3259730800,3505952657),new t(3345764771,106217008),new t(3516065817,3606008344),new t(3600352804,1432725776),new t(4094571909,1467031594),new t(275423344,851169720),new t(430227734,3100823752),new t(506948616,1363258195),new t(659060556,3750685593),new t(883997877,3785050280),new t(958139571,3318307427),new t(1322822218,3812723403),new t(1537002063,2003034995),new t(1747873779,3602036899),new t(1955562222,1575990012),new t(2024104815,1125592928),new t(2227730452,2716904306),new t(2361852424,442776044),new t(2428436474,593698344),new t(2756734187,3733110249),new t(3204031479,2999351573),new t(3329325298,3815920427),new t(3391569614,3928383900),new t(3515267271,566280711),new t(3940187606,3454069534),new t(4118630271,4000239992),new t(116418474,1914138554),new t(174292421,2731055270),new t(289380356,3203993006),new t(460393269,320620315),new t(685471733,587496836),new t(852142971,1086792851),new t(1017036298,365543100),new t(1126000580,2618297676),new t(1288033470,3409855158),new t(1501505948,4234509866),new t(1607167915,987167468),new t(1816402316,1246189591)];function de(e,t,s){var r,i,n,o=[],a=[],c=[],h=[];for(i=0;i<8;i++)o[i]=c[i]=g(e,8*i);for(var u=0;s>=128;){for(i=0;i<16;i++)h[i]=g(t,8*i+u);for(i=0;i<80;i++){for(n=0;n<8;n++)a[n]=c[n];for(r=te(c[7],ce(c[4]),ne(c[4],c[5],c[6]),le[i],h[i%16]),a[7]=te(r,ae(c[0]),oe(c[0],c[1],c[2])),a[3]=te(a[3],r),n=0;n<8;n++)c[(n+1)%8]=a[n];if(i%16==15)for(n=0;n<16;n++)h[n]=te(h[n],h[(n+9)%16],he(h[(n+1)%16]),ue(h[(n+14)%16]))}for(i=0;i<8;i++)c[i]=te(c[i],o[i]),o[i]=c[i];u+=128,s-=128}for(i=0;i<8;i++)y(e,8*i,o[i]);return s}var fe=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function pe(e,s,r){var i,n=new Uint8Array(64),o=new Uint8Array(256),a=r;for(i=0;i<64;i++)n[i]=fe[i];for(de(n,s,r),r%=128,i=0;i<256;i++)o[i]=0;for(i=0;i<r;i++)o[i]=s[a-r+i];for(o[r]=128,o[(r=256-128*(r<112?1:0))-9]=0,y(o,r-8,new t(a/536870912|0,a<<3)),de(n,o,r),i=0;i<64;i++)e[i]=n[i];return 0}function me(e,t){var r=s(),i=s(),n=s(),o=s(),a=s(),c=s(),h=s(),l=s(),d=s();J(r,e[1],e[0]),J(d,t[1],t[0]),K(r,r,d),H(i,e[0],e[1]),H(d,t[0],t[1]),K(i,i,d),K(n,e[3],t[3]),K(n,n,u),K(o,e[2],t[2]),H(o,o,o),J(a,i,r),J(c,o,n),H(h,o,n),H(l,i,r),K(e[0],a,c),K(e[1],l,h),K(e[2],h,c),K(e[3],a,l)}function ge(e,t,s){var r;for(r=0;r<4;r++)U(e[r],t[r],s)}function be(e,t){var r=s(),i=s(),n=s();G(n,t[2]),K(r,t[0],n),K(i,t[1],n),L(e,i),e[31]^=D(r)<<7}function ye(e,t,s){var r,i;for(T(e[0],o),T(e[1],a),T(e[2],a),T(e[3],o),i=255;i>=0;--i)ge(e,t,r=s[i/8|0]>>(7&i)&1),me(t,e),me(e,e),ge(e,t,r)}function _e(e,t){var r=[s(),s(),s(),s()];T(r[0],l),T(r[1],d),T(r[2],a),K(r[3],l,d),ye(e,r,t)}function we(e,t,i){var n,o=new Uint8Array(64),a=[s(),s(),s(),s()];for(i||r(t,32),pe(o,t,32),o[0]&=248,o[31]&=127,o[31]|=64,_e(a,o),be(e,a),n=0;n<32;n++)t[n+32]=e[n];return 0}var ve=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function Se(e,t){var s,r,i,n;for(r=63;r>=32;--r){for(s=0,i=r-32,n=r-12;i<n;++i)t[i]+=s-16*t[r]*ve[i-(r-32)],s=Math.floor((t[i]+128)/256),t[i]-=256*s;t[i]+=s,t[r]=0}for(s=0,i=0;i<32;i++)t[i]+=s-(t[31]>>4)*ve[i],s=t[i]>>8,t[i]&=255;for(i=0;i<32;i++)t[i]-=s*ve[i];for(r=0;r<32;r++)t[r+1]+=t[r]>>8,e[r]=255&t[r]}function Ee(e){var t,s=new Float64Array(64);for(t=0;t<64;t++)s[t]=e[t];for(t=0;t<64;t++)e[t]=0;Se(e,s)}function Pe(e,t,r,i){var n,o,a=new Uint8Array(64),c=new Uint8Array(64),h=new Uint8Array(64),u=new Float64Array(64),l=[s(),s(),s(),s()];pe(a,i,32),a[0]&=248,a[31]&=127,a[31]|=64;var d=r+64;for(n=0;n<r;n++)e[64+n]=t[n];for(n=0;n<32;n++)e[32+n]=a[32+n];for(pe(h,e.subarray(32),r+32),Ee(h),_e(l,h),be(e,l),n=32;n<64;n++)e[n]=i[n];for(pe(c,e,r+64),Ee(c),n=0;n<64;n++)u[n]=0;for(n=0;n<32;n++)u[n]=h[n];for(n=0;n<32;n++)for(o=0;o<32;o++)u[n+o]+=c[n]*a[o];return Se(e.subarray(32),u),d}function Ce(e,t,r,i){var n,c=new Uint8Array(32),u=new Uint8Array(64),l=[s(),s(),s(),s()],d=[s(),s(),s(),s()];if(r<64)return-1;if(function(e,t){var r=s(),i=s(),n=s(),c=s(),u=s(),l=s(),d=s();return T(e[2],a),B(e[1],t),z(n,e[1]),K(c,n,h),J(n,n,e[2]),H(c,e[2],c),z(u,c),z(l,u),K(d,l,u),K(r,d,n),K(r,r,c),V(r,r),K(r,r,n),K(r,r,c),K(r,r,c),K(e[0],r,c),z(i,e[0]),K(i,i,c),F(i,n)&&K(e[0],e[0],f),z(i,e[0]),K(i,i,c),F(i,n)?-1:(D(e[0])===t[31]>>7&&J(e[0],o,e[0]),K(e[3],e[0],e[1]),0)}(d,i))return-1;for(n=0;n<r;n++)e[n]=t[n];for(n=0;n<32;n++)e[n+32]=i[n];if(pe(u,e,r),Ee(u),ye(l,d,u),_e(d,t.subarray(32)),me(l,d),be(c,l),r-=64,v(t,0,c,0)){for(n=0;n<r;n++)e[n]=0;return-1}for(n=0;n<r;n++)e[n]=t[n+64];return r}var xe=16,Ae=64,ke=32,je=64;function Oe(e,t){if(32!==e.length)throw new Error("bad key size");if(24!==t.length)throw new Error("bad nonce size")}function Me(){for(var e=0;e<arguments.length;e++)if(!(arguments[e]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function Ie(e){for(var t=0;t<e.length;t++)e[t]=0}e.lowlevel={crypto_core_hsalsa20:P,crypto_stream_xor:j,crypto_stream:k,crypto_stream_salsa20_xor:x,crypto_stream_salsa20:A,crypto_onetimeauth:I,crypto_onetimeauth_verify:N,crypto_verify_16:w,crypto_verify_32:v,crypto_secretbox:R,crypto_secretbox_open:$,crypto_scalarmult:W,crypto_scalarmult_base:Y,crypto_box_beforenm:Q,crypto_box_afternm:Z,crypto_box:function(e,t,s,r,i,n){var o=new Uint8Array(32);return Q(o,i,n),Z(e,t,s,r,o)},crypto_box_open:function(e,t,s,r,i,n){var o=new Uint8Array(32);return Q(o,i,n),ee(e,t,s,r,o)},crypto_box_keypair:X,crypto_hash:pe,crypto_sign:Pe,crypto_sign_keypair:we,crypto_sign_open:Ce,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:xe,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:Ae,crypto_sign_PUBLICKEYBYTES:ke,crypto_sign_SECRETKEYBYTES:je,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:s,D:h,L:ve,pack25519:L,unpack25519:B,M:K,A:H,S:z,Z:J,pow2523:V,add:me,set25519:T,modL:Se,scalarmult:ye,scalarbase:_e},e.randomBytes=function(e){var t=new Uint8Array(e);return r(t,e),t},e.secretbox=function(e,t,s){Me(e,t,s),Oe(s,t);for(var r=new Uint8Array(32+e.length),i=new Uint8Array(r.length),n=0;n<e.length;n++)r[n+32]=e[n];return R(i,r,r.length,t,s),i.subarray(xe)},e.secretbox.open=function(e,t,s){Me(e,t,s),Oe(s,t);for(var r=new Uint8Array(xe+e.length),i=new Uint8Array(r.length),n=0;n<e.length;n++)r[n+xe]=e[n];return r.length<32||0!==$(i,r,r.length,t,s)?null:i.subarray(32)},e.secretbox.keyLength=32,e.secretbox.nonceLength=24,e.secretbox.overheadLength=xe,e.scalarMult=function(e,t){if(Me(e,t),32!==e.length)throw new Error("bad n size");if(32!==t.length)throw new Error("bad p size");var s=new Uint8Array(32);return W(s,e,t),s},e.scalarMult.base=function(e){if(Me(e),32!==e.length)throw new Error("bad n size");var t=new Uint8Array(32);return Y(t,e),t},e.scalarMult.scalarLength=32,e.scalarMult.groupElementLength=32,e.box=function(t,s,r,i){var n=e.box.before(r,i);return e.secretbox(t,s,n)},e.box.before=function(e,t){Me(e,t),function(e,t){if(32!==e.length)throw new Error("bad public key size");if(32!==t.length)throw new Error("bad secret key size")}(e,t);var s=new Uint8Array(32);return Q(s,e,t),s},e.box.after=e.secretbox,e.box.open=function(t,s,r,i){var n=e.box.before(r,i);return e.secretbox.open(t,s,n)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var e=new Uint8Array(32),t=new Uint8Array(32);return X(e,t),{publicKey:e,secretKey:t}},e.box.keyPair.fromSecretKey=function(e){if(Me(e),32!==e.length)throw new Error("bad secret key size");var t=new Uint8Array(32);return Y(t,e),{publicKey:t,secretKey:new Uint8Array(e)}},e.box.publicKeyLength=32,e.box.secretKeyLength=32,e.box.sharedKeyLength=32,e.box.nonceLength=24,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(e,t){if(Me(e,t),t.length!==je)throw new Error("bad secret key size");var s=new Uint8Array(Ae+e.length);return Pe(s,e,e.length,t),s},e.sign.open=function(e,t){if(Me(e,t),t.length!==ke)throw new Error("bad public key size");var s=new Uint8Array(e.length),r=Ce(s,e,e.length,t);if(r<0)return null;for(var i=new Uint8Array(r),n=0;n<i.length;n++)i[n]=s[n];return i},e.sign.detached=function(t,s){for(var r=e.sign(t,s),i=new Uint8Array(Ae),n=0;n<i.length;n++)i[n]=r[n];return i},e.sign.detached.verify=function(e,t,s){if(Me(e,t,s),t.length!==Ae)throw new Error("bad signature size");if(s.length!==ke)throw new Error("bad public key size");var r,i=new Uint8Array(Ae+e.length),n=new Uint8Array(Ae+e.length);for(r=0;r<Ae;r++)i[r]=t[r];for(r=0;r<e.length;r++)i[r+Ae]=e[r];return Ce(n,i,i.length,s)>=0},e.sign.keyPair=function(){var e=new Uint8Array(ke),t=new Uint8Array(je);return we(e,t),{publicKey:e,secretKey:t}},e.sign.keyPair.fromSecretKey=function(e){if(Me(e),e.length!==je)throw new Error("bad secret key size");for(var t=new Uint8Array(ke),s=0;s<t.length;s++)t[s]=e[32+s];return{publicKey:t,secretKey:new Uint8Array(e)}},e.sign.keyPair.fromSeed=function(e){if(Me(e),32!==e.length)throw new Error("bad seed size");for(var t=new Uint8Array(ke),s=new Uint8Array(je),r=0;r<32;r++)s[r]=e[r];return we(t,s,!0),{publicKey:t,secretKey:s}},e.sign.publicKeyLength=ke,e.sign.secretKeyLength=je,e.sign.seedLength=32,e.sign.signatureLength=Ae,e.hash=function(e){Me(e);var t=new Uint8Array(64);return pe(t,e,e.length),t},e.hash.hashLength=64,e.verify=function(e,t){return Me(e,t),0!==e.length&&0!==t.length&&(e.length===t.length&&0===_(e,0,t,0,e.length))},e.setPRNG=function(e){r=e},function(){var t="undefined"!=typeof globalThis?globalThis.crypto||globalThis.msCrypto:null;if(t&&t.getRandomValues){e.setPRNG((function(e,s){var r,i=new Uint8Array(s);for(r=0;r<s;r+=65536)t.getRandomValues(i.subarray(r,r+Math.min(s-r,65536)));for(r=0;r<s;r++)e[r]=i[r];Ie(i)}))}else"undefined"!=typeof require&&(t=require("crypto"))&&t.randomBytes&&e.setPRNG((function(e,s){var r,i=t.randomBytes(s);for(r=0;r<s;r++)e[r]=i[r];Ie(i)}))}()}("undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl=globalThis.nacl||{});const Ce="undefined"!=typeof module&&module.exports?module.exports:globalThis.nacl,xe={fromSeed:Ce.sign.keyPair.fromSeed,sign:Ce.sign.detached,verify:Ce.sign.detached.verify,randomBytes:Ce.randomBytes};let Ae;function ke(){return Ae}const je=new Uint16Array([0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920]);class Oe{static checksum(e){let t=0;for(let s=0;s<e.byteLength;s++){let r=e[s];t=t<<8&65535^je[255&(t>>8^r)]}return t}static validate(e,t){return Oe.checksum(e)==t}}const Me="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";class Ie{static encode(e){let t=0,s=0,r=new Uint8Array(e),i=new Uint8Array(2*e.byteLength),n=0;for(let e=0;e<r.byteLength;e++)for(s=s<<8|r[e],t+=8;t>=5;){let e=s>>>t-5&31;i[n++]=Me.charAt(e).charCodeAt(0),t-=5}if(t>0){let e=s<<5-t&31;i[n++]=Me.charAt(e).charCodeAt(0)}return i.slice(0,n)}static decode(e){let t=0,s=0,r=0,i=new Uint8Array(e),n=new Uint8Array(5*i.byteLength/8|0);for(let e=0;e<i.byteLength;e++){let o=String.fromCharCode(i[e]),a=Me.indexOf(o);if(-1===a)throw new Error("Illegal Base32 character: "+i[e]);s=s<<5|a,t+=5,t>=8&&(n[r++]=s>>>t-8&255,t-=8)}return n.slice(0,r)}}class Ne extends Error{name;code;chainedError;constructor(e,t){super(e),this.name="NKeysError",this.code=e,this.chainedError=t}}var Re,$e;!function(e){e.InvalidPrefixByte="nkeys: invalid prefix byte",e.InvalidKey="nkeys: invalid key",e.InvalidPublicKey="nkeys: invalid public key",e.InvalidSeedLen="nkeys: invalid seed length",e.InvalidSeed="nkeys: invalid seed",e.InvalidEncoding="nkeys: invalid encoded key",e.InvalidSignature="nkeys: signature verification failed",e.CannotSign="nkeys: cannot sign, no private key available",e.PublicKeyOnly="nkeys: no seed or private key available",e.InvalidChecksum="nkeys: invalid checksum",e.SerializationError="nkeys: serialization error",e.ApiError="nkeys: api error",e.ClearedPair="nkeys: pair is cleared"}(Re||(Re={})),function(e){e[e.Seed=144]="Seed",e[e.Private=120]="Private",e[e.Operator=112]="Operator",e[e.Server=104]="Server",e[e.Cluster=16]="Cluster",e[e.Account=0]="Account",e[e.User=160]="User"}($e||($e={}));class Te{static isValidPublicPrefix(e){return e==$e.Server||e==$e.Operator||e==$e.Cluster||e==$e.Account||e==$e.User}static startsWithValidPrefix(e){let t=e[0];return"S"==t||"P"==t||"O"==t||"N"==t||"C"==t||"A"==t||"U"==t}static isValidPrefix(e){return-1!=this.parsePrefix(e)}static parsePrefix(e){switch(e){case $e.Seed:return $e.Seed;case $e.Private:return $e.Private;case $e.Operator:return $e.Operator;case $e.Server:return $e.Server;case $e.Cluster:return $e.Cluster;case $e.Account:return $e.Account;case $e.User:return $e.User;default:return-1}}}class qe{static encode(e,t){if(!(t&&t instanceof Uint8Array))throw new Ne(Re.SerializationError);if(!Te.isValidPrefix(e))throw new Ne(Re.InvalidPrefixByte);return qe._encode(!1,e,t)}static encodeSeed(e,t){if(!t)throw new Ne(Re.ApiError);if(!Te.isValidPublicPrefix(e))throw new Ne(Re.InvalidPrefixByte);if(32!==t.byteLength)throw new Ne(Re.InvalidSeedLen);return qe._encode(!0,e,t)}static decode(e,t){if(!Te.isValidPrefix(e))throw new Ne(Re.InvalidPrefixByte);const s=qe._decode(t);if(s[0]!==e)throw new Ne(Re.InvalidPrefixByte);return s.slice(1)}static decodeSeed(e){const t=qe._decode(e),s=qe._decodePrefix(t);if(s[0]!=$e.Seed)throw new Ne(Re.InvalidSeed);if(!Te.isValidPublicPrefix(s[1]))throw new Ne(Re.InvalidPrefixByte);return{buf:t.slice(2),prefix:s[1]}}static _encode(e,t,s){const r=e?2:1,i=s.byteLength,n=r+i,o=new Uint8Array(r+i+2);if(e){const e=qe._encodePrefix($e.Seed,t);o.set(e)}else o[0]=t;o.set(s,r);const a=Oe.checksum(o.slice(0,n));return new DataView(o.buffer).setUint16(n,a,!0),Ie.encode(o)}static _decode(e){if(e.byteLength<4)throw new Ne(Re.InvalidEncoding);let t;try{t=Ie.decode(e)}catch(e){throw new Ne(Re.InvalidEncoding,e)}const s=t.byteLength-2,r=new DataView(t.buffer).getUint16(s,!0),i=t.slice(0,s);if(!Oe.validate(i,r))throw new Ne(Re.InvalidChecksum);return i}static _encodePrefix(e,t){return new Uint8Array([e|t>>5,(31&t)<<3])}static _decodePrefix(e){const t=248&e[0],s=(7&e[0])<<5|(248&e[1])>>3;return new Uint8Array([t,s])}}class Ue{seed;constructor(e){this.seed=e}getRawSeed(){if(!this.seed)throw new Ne(Re.ClearedPair);return qe.decodeSeed(this.seed).buf}getSeed(){if(!this.seed)throw new Ne(Re.ClearedPair);return this.seed}getPublicKey(){if(!this.seed)throw new Ne(Re.ClearedPair);const e=qe.decodeSeed(this.seed),t=ke().fromSeed(this.getRawSeed()),s=qe.encode(e.prefix,t.publicKey);return(new TextDecoder).decode(s)}getPrivateKey(){if(!this.seed)throw new Ne(Re.ClearedPair);const e=ke().fromSeed(this.getRawSeed());return qe.encode($e.Private,e.secretKey)}sign(e){if(!this.seed)throw new Ne(Re.ClearedPair);const t=ke().fromSeed(this.getRawSeed());return ke().sign(e,t.secretKey)}verify(e,t){if(!this.seed)throw new Ne(Re.ClearedPair);const s=ke().fromSeed(this.getRawSeed());return ke().verify(e,t,s.publicKey)}clear(){this.seed&&(this.seed.fill(0),this.seed=void 0)}}function Le(e){const t=ke().randomBytes(32);let s=qe.encodeSeed(e,new Uint8Array(t));return new Ue(s)}class Fe{publicKey;constructor(e){this.publicKey=e}getPublicKey(){if(!this.publicKey)throw new Ne(Re.ClearedPair);return(new TextDecoder).decode(this.publicKey)}getPrivateKey(){if(!this.publicKey)throw new Ne(Re.ClearedPair);throw new Ne(Re.PublicKeyOnly)}getSeed(){if(!this.publicKey)throw new Ne(Re.ClearedPair);throw new Ne(Re.PublicKeyOnly)}sign(e){if(!this.publicKey)throw new Ne(Re.ClearedPair);throw new Ne(Re.CannotSign)}verify(e,t){if(!this.publicKey)throw new Ne(Re.ClearedPair);let s=qe._decode(this.publicKey);return ke().verify(e,t,s.slice(1))}clear(){this.publicKey&&(this.publicKey.fill(0),this.publicKey=void 0)}}Ae=xe;const De={createAccount:function(){return Le($e.Account)},createOperator:function(){return Le($e.Operator)},createPair:Le,createUser:function(){return Le($e.User)},fromPublic:function(e){const t=(new TextEncoder).encode(e),s=qe._decode(t),r=Te.parsePrefix(s[0]);if(Te.isValidPublicPrefix(r))return new Fe(t);throw new Ne(Re.InvalidPublicKey)},fromSeed:function(e){return qe.decodeSeed(e),new Ue(e)},NKeysError:Ne,NKeysErrorCode:Re,Prefix:$e,decode:function(e){const t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s},encode:function(e){return btoa(String.fromCharCode(...e))}};function Be(e,t){return()=>({user:"function"==typeof e?e():e,pass:"function"==typeof t?t():t})}function He(e){return()=>({auth_token:"function"==typeof e?e():e})}function Je(e){return t=>{const r="function"==typeof e?e():e,i=r?De.fromSeed(r):void 0,n=i?i.getPublicKey():"",o=s.encode(t||""),a=void 0!==i&&t?i.sign(o):void 0;return{nkey:n,sig:a?De.encode(a):""}}}function Ke(e,t){return s=>{const r="function"==typeof e?e():e,i=Je(t),{nkey:n,sig:o}=i(s);return{jwt:r,nkey:n,sig:o}}}const ze=12e4,Ge=2e3;function Ve(e){const t=[];return"function"==typeof e.authenticator&&t.push(e.authenticator),Array.isArray(e.authenticator)&&t.push(...e.authenticator),e.token&&t.push(He(e.token)),e.user&&t.push(Be(e.user,e.pass)),0===t.length?()=>{}:(s=t,e=>{let t={};return s.forEach((s=>{const r=s(e)||{};t=Object.assign(t,r)})),t});var s}function We(t){const s=`${E}:${$()}`;if((t=t||{servers:[s]}).servers=t.servers||[],"string"==typeof t.servers&&(t.servers=[t.servers]),t.servers.length>0&&t.port)throw new m("port and servers options are mutually exclusive",e.ErrorCode.InvalidOption);0===t.servers.length&&t.port&&(t.servers=[`${E}:${t.port}`]),t.servers&&0===t.servers.length&&(t.servers=[s]);const r=C({maxPingOut:2,maxReconnectAttempts:10,noRandomize:!1,pedantic:!1,pingInterval:ze,reconnect:!0,reconnectJitter:100,reconnectJitterTLS:1e3,reconnectTimeWait:Ge,tls:void 0,verbose:!1,waitOnFirstConnect:!1,ignoreAuthErrorAbort:!1},t);if(r.authenticator=Ve(r),["reconnectDelayHandler","authenticator"].forEach((t=>{if(r[t]&&"function"!=typeof r[t])throw new m(`${t} option should be a function`,e.ErrorCode.NotFunction)})),r.reconnectDelayHandler||(r.reconnectDelayHandler=()=>{let e=r.tls?r.reconnectJitterTLS:r.reconnectJitter;return e&&(e++,e=Math.floor(Math.random()*e)),r.reconnectTimeWait+e}),r.inboxPrefix)try{S(r.inboxPrefix)}catch(t){throw new m(t.message,e.ErrorCode.ApiError)}if(r.resolve&&"function"!=typeof q())throw new m("'resolve' is not supported on this client",e.ErrorCode.InvalidOption);return r}const Ye=/^INFO\s+([^\r\n]+)\r\n/i,Xe=i("PONG\r\n"),Qe=i("PING\r\n");class Ze{echo;no_responders;protocol;verbose;pedantic;jwt;nkey;sig;user;pass;auth_token;tls_required;name;lang;version;headers;constructor(e,t,s){this.protocol=1,this.version=e.version,this.lang=e.lang,this.echo=!t.noEcho&&void 0,this.verbose=t.verbose,this.pedantic=t.pedantic,this.tls_required=!!t.tls||void 0,this.name=t.name;C(this,(t&&"function"==typeof t.authenticator?t.authenticator(s):{})||{})}}class et extends te{sid;queue;draining;max;subject;drained;protocol;timer;info;cleanupFn;closed;requestSubject;constructor(e,t,s={}){super(),C(this,s),this.protocol=e,this.subject=t,this.draining=!1,this.noIterator="function"==typeof s.callback,this.closed=j();const r=!e.options?.noAsyncTraces;s.timeout&&(this.timer=A(s.timeout,r),this.timer.then((()=>{this.timer=void 0})).catch((e=>{this.stop(e),this.noIterator&&this.callback(e,{})}))),this.noIterator||this.iterClosed.then((()=>{this.closed.resolve(),this.unsubscribe()}))}setPrePostHandlers(e){if(this.noIterator){const t=this.callback,s=e.ingestionFilterFn?e.ingestionFilterFn:()=>({ingest:!0,protocol:!1}),r=e.protocolFilterFn?e.protocolFilterFn:()=>!0,i=e.dispatchedFn?e.dispatchedFn:()=>{};this.callback=(e,n)=>{const{ingest:o}=s(n);o&&r(n)&&(t(e,n),i(n))}}else this.protocolFilterFn=e.protocolFilterFn,this.dispatchedFn=e.dispatchedFn}callback(e,t){this.cancelTimeout(),e?this.stop(e):this.push(t)}close(){if(!this.isClosed()){this.cancelTimeout();const e=()=>{if(this.stop(),this.cleanupFn)try{this.cleanupFn(this,this.info)}catch(e){}this.closed.resolve()};this.noIterator?e():this.push(e)}}unsubscribe(e){this.protocol.unsubscribe(this,e)}cancelTimeout(){this.timer&&(this.timer.cancel(),this.timer=void 0)}drain(){return this.protocol.isClosed()?Promise.reject(m.errorForCode(e.ErrorCode.ConnectionClosed)):this.isClosed()?Promise.reject(m.errorForCode(e.ErrorCode.SubClosed)):(this.drained||(this.draining=!0,this.protocol.unsub(this),this.drained=this.protocol.flush(j()).then((()=>{this.protocol.subscriptions.cancel(this)})).catch((()=>{this.protocol.subscriptions.cancel(this)}))),this.drained)}isDraining(){return this.draining}isClosed(){return this.done}getSubject(){return this.subject}getMax(){return this.max}getID(){return this.sid}}class tt{mux;subs;sidCounter;constructor(){this.sidCounter=0,this.mux=null,this.subs=new Map}size(){return this.subs.size}add(e){return this.sidCounter++,e.sid=this.sidCounter,this.subs.set(e.sid,e),e}setMux(e){return this.mux=e,e}getMux(){return this.mux}get(e){return this.subs.get(e)}resub(e){return this.sidCounter++,this.subs.delete(e.sid),e.sid=this.sidCounter,this.subs.set(e.sid,e),e}all(){return Array.from(this.subs.values())}cancel(e){e&&(e.close(),this.subs.delete(e.sid))}handleError(e){if(e&&e.permissionContext){const t=e.permissionContext,s=this.all();let r;if("subscription"===t.operation&&(r=s.find((e=>e.subject===t.subject))),"publish"===t.operation&&(r=s.find((e=>e.requestSubject===t.subject))),r)return r.callback(e,{}),r.close(),this.subs.delete(r.sid),r!==this.mux}return!1}close(){this.subs.forEach((e=>{e.close()}))}}class st{connected;connectedOnce;infoReceived;info;muxSubscriptions;options;outbound;pongs;subscriptions;transport;noMorePublishing;connectError;publisher;_closed;closed;listeners;heartbeats;parser;outMsgs;inMsgs;outBytes;inBytes;pendingLimit;lastError;abortReconnect;servers;server;features;connectPromise;constructor(e,t){this._closed=!1,this.connected=!1,this.connectedOnce=!1,this.infoReceived=!1,this.noMorePublishing=!1,this.abortReconnect=!1,this.listeners=[],this.pendingLimit=32768,this.outMsgs=0,this.inMsgs=0,this.outBytes=0,this.inBytes=0,this.options=e,this.publisher=t,this.subscriptions=new tt,this.muxSubscriptions=new ue,this.outbound=new N,this.pongs=[],this.pendingLimit=e.pendingLimit||this.pendingLimit,this.features=new Pe({major:0,minor:0,micro:0}),this.connectPromise=null;const s="string"==typeof e.servers?[e.servers]:e.servers;this.servers=new ee(s,{randomize:!e.noRandomize}),this.closed=j(),this.parser=new ye(this),this.heartbeats=new le(this,this.options.pingInterval||ze,this.options.maxPingOut||2)}resetOutbound(){this.outbound.reset();const t=this.pongs;this.pongs=[];const s=m.errorForCode(e.ErrorCode.Disconnect);s.stack="",t.forEach((e=>{e.reject(s)})),this.parser=new ye(this),this.infoReceived=!1}dispatchStatus(e){this.listeners.forEach((t=>{t.push(e)}))}status(){const e=new te;return this.listeners.push(e),e}prepare(){this.transport&&this.transport.discard(),this.info=void 0,this.resetOutbound();const e=j();return e.catch((()=>{})),this.pongs.unshift(e),this.connectError=t=>{e.reject(t)},this.transport=function(){if(!R||"function"!=typeof R.factory)throw new Error("transport fn is not set");return R.factory()}(),this.transport.closed().then((async e=>{this.connected=!1,this.isClosed()||await this.disconnected(this.transport.closeError||this.lastError)})),e}disconnect(){this.dispatchStatus({type:e.DebugEvents.StaleConnection,data:""}),this.transport.disconnect()}reconnect(){return this.connected&&(this.dispatchStatus({type:e.DebugEvents.ClientInitiatedReconnect,data:""}),this.transport.disconnect()),Promise.resolve()}async disconnected(t){this.dispatchStatus({type:e.Events.Disconnect,data:this.servers.getCurrentServer().toString()}),this.options.reconnect?await this.dialLoop().then((()=>{this.dispatchStatus({type:e.Events.Reconnect,data:this.servers.getCurrentServer().toString()}),this.lastError?.code===e.ErrorCode.AuthenticationExpired&&(this.lastError=void 0)})).catch((e=>{this._close(e)})):await this._close(t)}async dial(e){const t=this.prepare();let s;try{s=A(this.options.timeout||2e4);const t=this.transport.connect(e,this.options);await Promise.race([t,s]),(async()=>{try{for await(const e of this.transport)this.parser.parse(e)}catch(e){console.log("reader closed",e)}})().then()}catch(e){t.reject(e)}try{await Promise.race([s,t]),s&&s.cancel(),this.connected=!0,this.connectError=void 0,this.sendSubscriptions(),this.connectedOnce=!0,this.server.didConnect=!0,this.server.reconnects=0,this.flushPending(),this.heartbeats.start()}catch(e){throw s&&s.cancel(),await this.transport.close(e),e}}async _doDial(t){const s=await t.resolve({fn:q(),debug:this.options.debug,randomize:!this.options.noRandomize});let r=null;for(const t of s)try{return r=null,this.dispatchStatus({type:e.DebugEvents.Reconnecting,data:t.toString()}),void await this.dial(t)}catch(e){r=e}throw r}dialLoop(){return null===this.connectPromise&&(this.connectPromise=this.dodialLoop(),this.connectPromise.then((()=>{})).catch((()=>{})).finally((()=>{this.connectPromise=null}))),this.connectPromise}async dodialLoop(){let t;for(;;){this._closed&&this.servers.clear();const s=this.options.reconnectDelayHandler?this.options.reconnectDelayHandler():Ge;let r=s;const i=this.selectServer();if(!i||this.abortReconnect)throw t||(this.lastError?this.lastError:m.errorForCode(e.ErrorCode.ConnectionRefused));const n=Date.now();if(0===i.lastConnect||i.lastConnect+s<=n){i.lastConnect=Date.now();try{await this._doDial(i);break}catch(e){if(t=e,!this.connectedOnce){if(this.options.waitOnFirstConnect)continue;this.servers.removeCurrentServer()}i.reconnects++;const s=this.options.maxReconnectAttempts||0;-1!==s&&i.reconnects>=s&&this.servers.removeCurrentServer()}}else r=Math.min(r,i.lastConnect+s-n),await k(r)}}static async connect(e,t){const s=new st(e,t);return await s.dialLoop(),s}static toError(t){const s=t?t.toLowerCase():"";if(-1!==s.indexOf("permissions violation")){const s=new m(t,e.ErrorCode.PermissionsViolation),r=t.match(/(Publish|Subscription) to "(\S+)"/);return r&&(s.permissionContext={operation:r[1].toLowerCase(),subject:r[2]}),s}return-1!==s.indexOf("authorization violation")?new m(t,e.ErrorCode.AuthorizationViolation):-1!==s.indexOf("user authentication expired")?new m(t,e.ErrorCode.AuthenticationExpired):-1!==s.indexOf("authentication timeout")?new m(t,e.ErrorCode.AuthenticationTimeout):new m(t,e.ErrorCode.ProtocolError)}processMsg(e,t){if(this.inMsgs++,this.inBytes+=t.length,!this.subscriptions.sidCounter)return;const s=this.subscriptions.get(e.sid);s&&(s.received+=1,s.callback&&s.callback(null,new he(e,t,this)),void 0!==s.max&&s.received>=s.max&&s.unsubscribe())}processError(t){const s=n(t),r=st.toError(s),i={type:e.Events.Error,data:r.code};if(r.isPermissionError()){let e=!1;if(r.permissionContext){i.permissionContext=r.permissionContext;const t=this.subscriptions.getMux();e=t?.subject===r.permissionContext.subject}this.subscriptions.handleError(r),this.muxSubscriptions.handleError(e,r),e&&this.subscriptions.setMux(null)}this.dispatchStatus(i),this.handleError(r)}handleError(e){e.isAuthError()?this.handleAuthError(e):(e.isProtocolError()||e.isAuthTimeout())&&(this.lastError=e),e.isPermissionError()||(this.lastError=e)}handleAuthError(e){this.lastError&&e.code===this.lastError.code&&!1===this.options.ignoreAuthErrorAbort&&(this.abortReconnect=!0),this.connectError?this.connectError(e):this.disconnect()}processPing(){this.transport.send(Xe)}processPong(){const e=this.pongs.shift();e&&e.resolve()}processInfo(t){const s=JSON.parse(n(t));this.info=s;const r=this.options&&this.options.ignoreClusterUpdates?void 0:this.servers.update(s);if(!this.infoReceived){this.features.update(Se(s.version)),this.infoReceived=!0,this.transport.isEncrypted()&&this.servers.updateTLSName();const{version:e,lang:t}=this.transport;try{const r=new Ze({version:e,lang:t},this.options,s.nonce);s.headers&&(r.headers=!0,r.no_responders=!0);const n=JSON.stringify(r);this.transport.send(i(`CONNECT ${n}${U}`)),this.transport.send(Qe)}catch(e){this._close(e)}}r&&this.dispatchStatus({type:e.Events.Update,data:r});void 0!==s.ldm&&s.ldm&&this.dispatchStatus({type:e.Events.LDM,data:this.servers.getCurrentServer().toString()})}push(e){switch(e.kind){case ge.MSG:{const{msg:t,data:s}=e;this.processMsg(t,s);break}case ge.OK:break;case ge.ERR:this.processError(e.data);break;case ge.PING:this.processPing();break;case ge.PONG:this.processPong();break;case ge.INFO:this.processInfo(e.data)}}sendCommand(e,...t){const s=this.outbound.length();let r;r="string"==typeof e?i(e):e,this.outbound.fill(r,...t),0===s?queueMicrotask((()=>{this.flushPending()})):this.outbound.size()>=this.pendingLimit&&this.flushPending()}publish(r,i=t,n){let o;if(i instanceof Uint8Array)o=i;else{if("string"!=typeof i)throw m.errorForCode(e.ErrorCode.BadPayload);o=s.encode(i)}let a=o.length;(n=n||{}).reply=n.reply||"";let c,h=t,u=0;if(n.headers){if(this.info&&!this.info.headers)throw new m("headers",e.ErrorCode.ServerOptionNotAvailable);h=n.headers.encode(),u=h.length,a=o.length+u}if(this.info&&a>this.info.max_payload)throw m.errorForCode(e.ErrorCode.MaxPayloadExceeded);this.outBytes+=a,this.outMsgs++,n.headers?(c=n.reply?`HPUB ${r} ${n.reply} ${u} ${a}\r\n`:`HPUB ${r} ${u} ${a}\r\n`,this.sendCommand(c,h,o,L)):(c=n.reply?`PUB ${r} ${n.reply} ${a}\r\n`:`PUB ${r} ${a}\r\n`,this.sendCommand(c,o,L))}request(e){return this.initMux(),this.muxSubscriptions.add(e),e}subscribe(e){return this.subscriptions.add(e),this._subunsub(e),e}_sub(e){e.queue?this.sendCommand(`SUB ${e.subject} ${e.queue} ${e.sid}\r\n`):this.sendCommand(`SUB ${e.subject} ${e.sid}\r\n`)}_subunsub(e){return this._sub(e),e.max&&this.unsubscribe(e,e.max),e}unsubscribe(e,t){this.unsub(e,t),(void 0===e.max||e.received>=e.max)&&this.subscriptions.cancel(e)}unsub(e,t){e&&!this.isClosed()&&(t?this.sendCommand(`UNSUB ${e.sid} ${t}\r\n`):this.sendCommand(`UNSUB ${e.sid}\r\n`),e.max=t)}resub(e,t){e&&!this.isClosed()&&(e.subject=t,this.subscriptions.resub(e),this._sub(e))}flush(e){return e||(e=j()),this.pongs.push(e),this.outbound.fill(Qe),this.flushPending(),e}sendSubscriptions(){const e=[];this.subscriptions.all().forEach((t=>{const s=t;s.queue?e.push(`SUB ${s.subject} ${s.queue} ${s.sid}${U}`):e.push(`SUB ${s.subject} ${s.sid}${U}`)})),e.length&&this.transport.send(i(e.join("")))}async _close(e){this._closed||(this.heartbeats.cancel(),this.connectError&&(this.connectError(e),this.connectError=void 0),this.muxSubscriptions.close(),this.subscriptions.close(),this.listeners.forEach((e=>{e.stop()})),this._closed=!0,await this.transport.close(e),await this.closed.resolve(e))}close(){return this._close()}isClosed(){return this._closed}drain(){const e=this.subscriptions.all(),t=[];return e.forEach((e=>{t.push(e.drain())})),Promise.all(t).then((async()=>(this.noMorePublishing=!0,await this.flush(),this.close()))).catch((()=>{}))}flushPending(){if(this.infoReceived&&this.connected&&this.outbound.size()){const e=this.outbound.drain();this.transport.send(e)}}initMux(){if(!this.subscriptions.getMux()){const e=this.muxSubscriptions.init(this.options.inboxPrefix),t=new et(this,`${e}*`);t.callback=this.muxSubscriptions.dispatcher(),this.subscriptions.setMux(t),this.subscribe(t)}}selectServer(){const e=this.servers.selectServer();if(void 0!==e)return this.server=e,this.server}getServer(){return this.server}}class rt{token;received;ctx;requestSubject;mux;constructor(e,t,s=!0){this.mux=e,this.requestSubject=t,this.received=0,this.token=h.next(),s&&(this.ctx=new Error)}}class it extends rt{callback;done;timer;max;opts;constructor(e,t,s={maxWait:1e3}){if(super(e,t),this.opts=s,"function"!=typeof this.opts.callback)throw new Error("callback is required");this.callback=this.opts.callback,this.max="number"==typeof s.maxMessages&&s.maxMessages>0?s.maxMessages:-1,this.done=j(),this.done.then((()=>{this.callback(null,null)})),this.timer=setTimeout((()=>{this.cancel()}),s.maxWait)}cancel(e){e&&this.callback(e,null),clearTimeout(this.timer),this.mux.cancel(this),this.done.resolve()}resolver(t,s){t?(this.ctx&&(t.stack+=`\n\n${this.ctx.stack}`),this.cancel(t)):(this.callback(null,s),this.opts.strategy===e.RequestStrategy.Count&&(this.max--,0===this.max&&this.cancel()),this.opts.strategy===e.RequestStrategy.JitterTimer&&(clearTimeout(this.timer),this.timer=setTimeout((()=>{this.cancel()}),this.opts.jitter||300)),this.opts.strategy===e.RequestStrategy.SentinelMsg&&s&&0===s.data.length&&this.cancel())}}class nt extends rt{deferred;timer;constructor(e,t,s={timeout:1e3},r=!0){super(e,t,r),this.deferred=j(),this.timer=A(s.timeout,r)}resolver(e,t){this.timer&&this.timer.cancel(),e?(this.ctx&&(e.stack+=`\n\n${this.ctx.stack}`),this.deferred.reject(e)):this.deferred.resolve(t),this.cancel()}cancel(t){this.timer&&this.timer.cancel(),this.mux.cancel(this),this.deferred.reject(t||m.errorForCode(e.ErrorCode.Cancelled))}}function ot(e){return ct("durable",e)}function at(e){return ct("stream",e)}function ct(e,t=""){if(""===t)throw Error(`${e} name required`);return[".","*",">","/","\\"," ","\t","\n","\r"].forEach((s=>{if(-1!==t.indexOf(s)){switch(s){case"\n":s="\\n";break;case"\r":s="\\r";break;case"\t":s="\\t"}throw Error(`invalid ${e} name - ${e} name cannot contain '${s}'`)}})),""}function ht(e,t=""){if(""===t)throw Error(`${e} name required`);const s=function(e=""){if(""===e)throw Error("name required");const t=/^[-\w]+$/g,s=e.match(t);if(null===s)for(const s of e.split("")){if(null===s.match(t))return`cannot contain '${s}'`}return""}(t);if(s.length)throw new Error(`invalid ${e} name - ${e} name ${s}`)}function ut(e){return 1e6*e}function lt(e){return Math.floor(e/1e6)}function dt(e){if(e.data.length>0)return!1;const t=e.headers;return!!t&&(t.code>=100&&t.code<200)}function ft(e){return dt(e)&&"Idle Heartbeat"===e.headers?.description}function pt(e){if(0!==e.data.length)return null;const t=e.headers;return t?gt(t.code,t.description):null}var mt;function gt(t,s=""){if(t<300)return null;switch(s=s.toLowerCase(),t){case 404:return new m(s,e.ErrorCode.JetStream404NoMessages);case 408:return new m(s,e.ErrorCode.JetStream408RequestTimeout);case 409:{const t=s.startsWith(mt.IdleHeartbeatMissed)?e.ErrorCode.JetStreamIdleHeartBeat:e.ErrorCode.JetStream409;return new m(s,t)}case 503:return m.errorForCode(e.ErrorCode.JetStreamNotEnabled,new Error(s));default:return""===s&&(s=e.ErrorCode.Unknown),new m(s,`${t}`)}}!function(e){e.MaxBatchExceeded="exceeded maxrequestbatch of",e.MaxExpiresExceeded="exceeded maxrequestexpires of",e.MaxBytesExceeded="exceeded maxrequestmaxbytes of",e.MaxMessageSizeExceeded="message size exceeds maxbytes",e.PushConsumer="consumer is push based",e.MaxWaitingExceeded="exceeded maxwaiting",e.IdleHeartbeatMissed="idle heartbeats missed",e.ConsumerDeleted="consumer deleted"}(mt||(mt={}));class bt{nc;opts;prefix;timeout;jc;constructor(e,t){this.nc=e,this.opts=function(e){return(e=e||{}).domain&&(e.apiPrefix=`$JS.${e.domain}.API`,delete e.domain),C({apiPrefix:"$JS.API",timeout:5e3},e)}(t),this._parseOpts(),this.prefix=this.opts.apiPrefix,this.timeout=this.opts.timeout,this.jc=ae()}getOptions(){return Object.assign({},this.opts)}_parseOpts(){let e=this.opts.apiPrefix;if(!e||0===e.length)throw new Error("invalid empty prefix");"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),this.opts.apiPrefix=e}async _request(e,s=null,r){(r=r||{}).timeout=this.timeout;let i=t;s&&(i=this.jc.encode(s));const n=await this.nc.request(e,i,r);return this.parseJsResponse(n)}async findStream(e){const t={subject:e},s=await this._request(`${this.prefix}.STREAM.NAMES`,t);if(!s.streams||1!==s.streams.length)throw new Error("no stream matches subject");return s.streams[0]}getConnection(){return this.nc}parseJsResponse(e){const t=this.jc.decode(e.data),s=t;if(s.error){const e=gt(s.error.code,s.error.description);if(null!==e)throw e.api_error=s.error,e}return t}}class yt{static encode(e){if("string"==typeof e)return btoa(e);const t=Array.from(e);return btoa(String.fromCharCode(...t))}static decode(e,t=!1){const s=atob(e);return t?Uint8Array.from(s,(e=>e.charCodeAt(0))):s}}class _t{static encode(e){return _t.toB64URLEncoding(yt.encode(e))}static decode(e,t=!1){return _t.decode(_t.fromB64URLEncoding(e),t)}static toB64URLEncoding(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}static fromB64URLEncoding(e){return e.replace(/_/g,"/").replace(/-/g,"+")}}var wt,vt,St,Et,Pt,Ct,xt,At,kt,jt,Ot,Mt,It;e.RetentionPolicy=void 0,(wt=e.RetentionPolicy||(e.RetentionPolicy={})).Limits="limits",wt.Interest="interest",wt.Workqueue="workqueue",e.DiscardPolicy=void 0,(vt=e.DiscardPolicy||(e.DiscardPolicy={})).Old="old",vt.New="new",e.StorageType=void 0,(St=e.StorageType||(e.StorageType={})).File="file",St.Memory="memory",e.DeliverPolicy=void 0,(Et=e.DeliverPolicy||(e.DeliverPolicy={})).All="all",Et.Last="last",Et.New="new",Et.StartSequence="by_start_sequence",Et.StartTime="by_start_time",Et.LastPerSubject="last_per_subject",e.AckPolicy=void 0,(Pt=e.AckPolicy||(e.AckPolicy={})).None="none",Pt.All="all",Pt.Explicit="explicit",Pt.NotSet="",e.ReplayPolicy=void 0,(Ct=e.ReplayPolicy||(e.ReplayPolicy={})).Instant="instant",Ct.Original="original",e.StoreCompression=void 0,(xt=e.StoreCompression||(e.StoreCompression={})).None="none",xt.S2="s2",function(e){e.CreateOrUpdate="",e.Update="update",e.Create="create"}(At||(At={})),e.AdvisoryKind=void 0,(kt=e.AdvisoryKind||(e.AdvisoryKind={})).API="api_audit",kt.StreamAction="stream_action",kt.ConsumerAction="consumer_action",kt.SnapshotCreate="snapshot_create",kt.SnapshotComplete="snapshot_complete",kt.RestoreCreate="restore_create",kt.RestoreComplete="restore_complete",kt.MaxDeliver="max_deliver",kt.Terminated="terminated",kt.Ack="consumer_ack",kt.StreamLeaderElected="stream_leader_elected",kt.StreamQuorumLost="stream_quorum_lost",kt.ConsumerLeaderElected="consumer_leader_elected",kt.ConsumerQuorumLost="consumer_quorum_lost",e.JsHeaders=void 0,(jt=e.JsHeaders||(e.JsHeaders={})).StreamSourceHdr="Nats-Stream-Source",jt.LastConsumerSeqHdr="Nats-Last-Consumer",jt.LastStreamSeqHdr="Nats-Last-Stream",jt.ConsumerStalledHdr="Nats-Consumer-Stalled",jt.MessageSizeHdr="Nats-Msg-Size",jt.RollupHdr="Nats-Rollup",jt.RollupValueSubject="sub",jt.RollupValueAll="all",jt.PendingMessagesHdr="Nats-Pending-Messages",jt.PendingBytesHdr="Nats-Pending-Bytes",function(e){e.LastValue="",e.AllHistory="history",e.UpdatesOnly="updates"}(Ot||(Ot={})),e.DirectMsgHeaders=void 0,(Mt=e.DirectMsgHeaders||(e.DirectMsgHeaders={})).Stream="Nats-Stream",Mt.Sequence="Nats-Sequence",Mt.TimeStamp="Nats-Time-Stamp",Mt.Subject="Nats-Subject",e.RepublishHeaders=void 0,(It=e.RepublishHeaders||(e.RepublishHeaders={})).Stream="Nats-Stream",It.Subject="Nats-Subject",It.Sequence="Nats-Sequence",It.LastSequence="Nats-Last-Sequence",It.Size="Nats-Msg-Size";const Nt="KV_";class Rt{config;ordered;mack;stream;callbackFn;max;qname;isBind;filters;constructor(t){this.stream="",this.mack=!1,this.ordered=!1,this.config=function(t,s={}){return Object.assign({name:t,deliver_policy:e.DeliverPolicy.All,ack_policy:e.AckPolicy.Explicit,ack_wait:ut(3e4),replay_policy:e.ReplayPolicy.Instant},s)}("",t||{})}getOpts(){const t={};if(t.config=Object.assign({},this.config),t.config.filter_subject&&(this.filterSubject(t.config.filter_subject),t.config.filter_subject=void 0),t.config.filter_subjects&&(t.config.filter_subjects?.forEach((e=>{this.filterSubject(e)})),t.config.filter_subjects=void 0),t.mack=this.mack,t.stream=this.stream,t.callbackFn=this.callbackFn,t.max=this.max,t.queue=this.qname,t.ordered=this.ordered,t.config.ack_policy=t.ordered?e.AckPolicy.None:t.config.ack_policy,t.isBind=t.isBind||!1,this.filters)switch(this.filters.length){case 0:break;case 1:t.config.filter_subject=this.filters[0];break;default:t.config.filter_subjects=this.filters}return t}description(e){return this.config.description=e,this}deliverTo(e){return this.config.deliver_subject=e,this}durable(e){return ot(e),this.config.durable_name=e,this}startSequence(t){if(t<=0)throw new Error("sequence must be greater than 0");return this.config.deliver_policy=e.DeliverPolicy.StartSequence,this.config.opt_start_seq=t,this}startTime(t){return this.config.deliver_policy=e.DeliverPolicy.StartTime,this.config.opt_start_time=t.toISOString(),this}deliverAll(){return this.config.deliver_policy=e.DeliverPolicy.All,this}deliverLastPerSubject(){return this.config.deliver_policy=e.DeliverPolicy.LastPerSubject,this}deliverLast(){return this.config.deliver_policy=e.DeliverPolicy.Last,this}deliverNew(){return this.config.deliver_policy=e.DeliverPolicy.New,this}startAtTimeDelta(e){return this.startTime(new Date(Date.now()-e)),this}headersOnly(){return this.config.headers_only=!0,this}ackNone(){return this.config.ack_policy=e.AckPolicy.None,this}ackAll(){return this.config.ack_policy=e.AckPolicy.All,this}ackExplicit(){return this.config.ack_policy=e.AckPolicy.Explicit,this}ackWait(e){return this.config.ack_wait=ut(e),this}maxDeliver(e){return this.config.max_deliver=e,this}filterSubject(e){return this.filters=this.filters||[],this.filters.push(e),this}replayInstantly(){return this.config.replay_policy=e.ReplayPolicy.Instant,this}replayOriginal(){return this.config.replay_policy=e.ReplayPolicy.Original,this}sample(e){if((e=Math.trunc(e))<0||e>100)throw new Error("value must be between 0-100");return this.config.sample_freq=`${e}%`,this}limit(e){return this.config.rate_limit_bps=e,this}maxWaiting(e){return this.config.max_waiting=e,this}maxAckPending(e){return this.config.max_ack_pending=e,this}idleHeartbeat(e){return this.config.idle_heartbeat=ut(e),this}flowControl(){return this.config.flow_control=!0,this}deliverGroup(e){return this.queue(e),this}manualAck(){return this.mack=!0,this}maxMessages(e){return this.max=e,this}callback(e){return this.callbackFn=e,this}queue(e){return this.qname=e,this.config.deliver_group=e,this}orderedConsumer(){return this.ordered=!0,this}bind(e,t){return this.stream=e,this.config.durable_name=t,this.isBind=!0,this}bindStream(e){return this.stream=e,this}inactiveEphemeralThreshold(e){return this.config.inactive_threshold=ut(e),this}maxPullBatch(e){return this.config.max_batch=e,this}maxPullRequestExpires(e){return this.config.max_expires=ut(e),this}memory(){return this.config.mem_storage=!0,this}numReplicas(e){return this.config.num_replicas=e,this}}function $t(e){return new Rt(e)}function Tt(e){return"function"==typeof e.getOpts}function qt(e){const t=e.length;let s=e.indexOf("=");-1===s&&(s=t);return[s,s===t?0:4-s%4]}const Ut=[],Lt=[],Ft="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";for(let e=0,t=64;e<t;++e)Ut[e]=Ft[e],Lt[Ft.charCodeAt(e)]=e;const{byteLength:Dt,toUint8Array:Bt,fromUint8Array:Ht}=function(e,t,s=!1){function r(e,t){return Math.floor(3*(e+t)/4-t)}function i(t,s,r){const i=new Array((r-s)/3);for(let o=s,a=0;o<r;o+=3)i[a++]=(n=(t[o]<<16)+(t[o+1]<<8)+t[o+2],e[n>>18&63]+e[n>>12&63]+e[n>>6&63]+e[63&n]);var n;return i.join("")}return{byteLength:e=>r.apply(null,qt(e)),toUint8Array(e){const[s,i]=qt(e),n=new Uint8Array(r(s,i)),o=i?s-4:s;let a,c,h=0;for(c=0;c<o;c+=4)a=t[e.charCodeAt(c)]<<18|t[e.charCodeAt(c+1)]<<12|t[e.charCodeAt(c+2)]<<6|t[e.charCodeAt(c+3)],n[h++]=a>>16&255,n[h++]=a>>8&255,n[h++]=255&a;return 2===i?(a=t[e.charCodeAt(c)]<<2|t[e.charCodeAt(c+1)]>>4,n[h++]=255&a):1===i&&(a=t[e.charCodeAt(c)]<<10|t[e.charCodeAt(c+1)]<<4|t[e.charCodeAt(c+2)]>>2,n[h++]=a>>8&255,n[h++]=255&a),n},fromUint8Array(t){const r=t.length,n=r%3,o=r-n,a=new Array(Math.ceil(o/16383)+(n?1:0));let c,h,u=0;for(let e=0;e<o;e+=16383)c=e+16383,a[u++]=i(t,e,c>o?o:c);return 1===n?(h=t[o],a[u]=e[h>>2]+e[h<<4&63],s||(a[u]+="==")):2===n&&(h=t[o]<<8|255&t[o+1],a[u]=e[h>>10]+e[h>>4&63]+e[h<<2&63],s||(a[u]+="=")),a.join("")}}}(Ut,Lt,!0),Jt=new TextDecoder,Kt=new TextEncoder;function zt(e,t="utf8"){if(/^utf-?8$/i.test(t))return Kt.encode(e);if(/^base64$/i.test(t))return Bt(e);if(/^hex(?:adecimal)?$/i.test(t))return function(e){const t=e.length;if(t%2||!/^[0-9a-fA-F]+$/.test(e))throw new TypeError("Invalid hex string.");e=e.toLowerCase();const s=new Uint8Array(Math.floor(t/2)),r=t/2;for(let t=0;t<r;++t)s[t]=parseInt(e.substr(2*t,2),16);return s}(e);throw new TypeError("Unsupported string encoding.")}class Gt{hashSize=32;_buf;_bufIdx;_count;_K;_H;_finalized;constructor(){this._buf=new Uint8Array(64),this._K=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),this.init()}init(){return this._H=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),this._bufIdx=0,this._count=new Uint32Array(2),this._buf.fill(0),this._finalized=!1,this}update(e,t){if(null===e)throw new TypeError("msg must be a string or Uint8Array.");"string"==typeof e&&(e=zt(e,t));for(let t=0,s=e.length;t<s;t++)this._buf[this._bufIdx++]=e[t],64===this._bufIdx&&(this._transform(),this._bufIdx=0);const s=this._count;return(s[0]+=e.length<<3)<e.length<<3&&s[1]++,s[1]+=e.length>>>29,this}digest(e){if(this._finalized)throw new Error("digest has already been called.");this._finalized=!0;const t=this._buf;let s=this._bufIdx;for(t[s++]=128;56!==s;)64===s&&(this._transform(),s=0),t[s++]=0;const r=this._count;t[56]=r[1]>>>24&255,t[57]=r[1]>>>16&255,t[58]=r[1]>>>8&255,t[59]=r[1]>>>0&255,t[60]=r[0]>>>24&255,t[61]=r[0]>>>16&255,t[62]=r[0]>>>8&255,t[63]=r[0]>>>0&255,this._transform();const i=new Uint8Array(32);for(let e=0;e<8;e++)i[0+(e<<2)]=this._H[e]>>>24&255,i[1+(e<<2)]=this._H[e]>>>16&255,i[2+(e<<2)]=this._H[e]>>>8&255,i[3+(e<<2)]=this._H[e]>>>0&255;return this.init(),e?function(e,t="utf8"){if(/^utf-?8$/i.test(t))return Jt.decode(e);if(/^base64$/i.test(t))return Ht(e);if(/^hex(?:adecimal)?$/i.test(t))return function(e){return e.reduce(((e,t)=>`${e}${t<16?"0":""}${t.toString(16)}`),"")}(e);throw new TypeError("Unsupported string encoding.")}(i,e):i}_transform(){const e=this._H;let t=e[0],s=e[1],r=e[2],i=e[3],n=e[4],o=e[5],a=e[6],c=e[7];const h=new Uint32Array(16);let u;for(u=0;u<16;u++)h[u]=this._buf[3+(u<<2)]|this._buf[2+(u<<2)]<<8|this._buf[1+(u<<2)]<<16|this._buf[u<<2]<<24;for(u=0;u<64;u++){let e;if(u<16)e=h[u];else{let t=h[u+1&15],s=h[u+14&15];e=h[15&u]=(t>>>7^t>>>18^t>>>3^t<<25^t<<14)+(s>>>17^s>>>19^s>>>10^s<<15^s<<13)+h[15&u]+h[u+9&15]|0}e=e+c+(n>>>6^n>>>11^n>>>25^n<<26^n<<21^n<<7)+(a^n&(o^a))+this._K[u]|0,c=a,a=o,o=n,n=i+e,i=r,r=s,s=t,t=e+(s&r^i&(s^r))+(s>>>2^s>>>13^s>>>22^s<<30^s<<19^s<<10)|0}e[0]=e[0]+t|0,e[1]=e[1]+s|0,e[2]=e[2]+r|0,e[3]=e[3]+i|0,e[4]=e[4]+n|0,e[5]=e[5]+o|0,e[6]=e[6]+a|0,e[7]=e[7]+c|0}}class Vt{err;offset;pageInfo;subject;jsm;filter;payload;constructor(e,t,s,r){if(!e)throw new Error("subject is required");this.subject=e,this.jsm=s,this.offset=0,this.pageInfo={},this.filter=t,this.payload=r||{}}async next(){if(this.err)return[];if(this.pageInfo&&this.offset>=this.pageInfo.total)return[];const e={offset:this.offset};this.payload&&Object.assign(e,this.payload);try{const t=await this.jsm._request(this.subject,e,{timeout:this.jsm.timeout});this.pageInfo=t,this.offset+=this.countResponse(t);return this.filter(t)}catch(e){throw this.err=e,e}}countResponse(e){switch(e?.type){case"io.nats.jetstream.api.v1.stream_names_response":case"io.nats.jetstream.api.v1.stream_list_response":return e.streams.length;case"io.nats.jetstream.api.v1.consumer_list_response":return e.consumers.length;default:return console.error(`jslister.ts: unknown API response for paged output: ${e?.type}`),e.streams?.length||0}return 0}async*[Symbol.asyncIterator](){let e=await this.next();for(;e.length>0;){for(const t of e)yield t;e=await this.next()}}}class Wt extends bt{constructor(e,t){super(e,t)}async add(e,t,s=At.Create){if(at(e),t.deliver_group&&t.flow_control)throw new Error("jetstream flow control is not supported with queue groups");if(t.deliver_group&&t.idle_heartbeat)throw new Error("jetstream idle heartbeat is not supported with queue groups");const r={};r.config=t,r.stream_name=e,r.action=s,r.config.durable_name&&ot(r.config.durable_name);const i=this.nc;let{min:n,ok:o}=i.features.get(ve.JS_NEW_CONSUMER_CREATE_API);const a=""===t.name?void 0:t.name;if(a&&!o)throw new Error(`consumer 'name' requires server ${n}`);if(a)try{ct("name",a)}catch(e){const t=e.message,s=t.indexOf("cannot contain");if(-1!==s)throw new Error(`consumer 'name' ${t.substring(s)}`);throw e}let c,h="";if(Array.isArray(t.filter_subjects)){const{min:e,ok:t}=i.features.get(ve.JS_MULTIPLE_CONSUMER_FILTER);if(!t)throw new Error(`consumer 'filter_subjects' requires server ${e}`);o=!1}if(t.metadata){const{min:e,ok:t}=i.features.get(ve.JS_STREAM_CONSUMER_METADATA);if(!t)throw new Error(`consumer 'metadata' requires server ${e}`)}if(o&&(h=t.name??t.durable_name??""),""!==h){let s=t.filter_subject??void 0;">"===s&&(s=void 0),c=void 0!==s?`${this.prefix}.CONSUMER.CREATE.${e}.${h}.${s}`:`${this.prefix}.CONSUMER.CREATE.${e}.${h}`}else c=t.durable_name?`${this.prefix}.CONSUMER.DURABLE.CREATE.${e}.${t.durable_name}`:`${this.prefix}.CONSUMER.CREATE.${e}`;return await this._request(c,r)}async update(e,t,s){const r=await this.info(e,t),i=s;return this.add(e,Object.assign(r.config,i),At.Update)}async info(e,t){at(e),ot(t);return await this._request(`${this.prefix}.CONSUMER.INFO.${e}.${t}`)}async delete(e,t){at(e),ot(t);return(await this._request(`${this.prefix}.CONSUMER.DELETE.${e}.${t}`)).success}list(e){at(e);const t=`${this.prefix}.CONSUMER.LIST.${e}`;return new Vt(t,(e=>e.consumers),this)}}const Yt=Uint8Array.of(43,65,67,75),Xt=Uint8Array.of(45,78,65,75),Qt=Uint8Array.of(43,87,80,73),Zt=Uint8Array.of(43,78,88,84),es=Uint8Array.of(43,84,69,82,77),ts=Uint8Array.of(32);function ss(e){return new rs(e)}class rs{msg;di;didAck;constructor(e){this.msg=e,this.didAck=!1}get subject(){return this.msg.subject}get sid(){return this.msg.sid}get data(){return this.msg.data}get headers(){return this.msg.headers}get info(){return this.di||(this.di=function(e){const t=e.split(".");if(9===t.length&&t.splice(2,0,"_",""),t.length<11||"$JS"!==t[0]||"ACK"!==t[1])throw new Error("not js message");const s={};return s.domain="_"===t[2]?"":t[2],s.account_hash=t[3],s.stream=t[4],s.consumer=t[5],s.redeliveryCount=parseInt(t[6],10),s.redelivered=s.redeliveryCount>1,s.streamSequence=parseInt(t[7],10),s.deliverySequence=parseInt(t[8],10),s.timestampNanos=parseInt(t[9],10),s.pending=parseInt(t[10],10),s}(this.reply)),this.di}get redelivered(){return this.info.redeliveryCount>1}get reply(){return this.msg.reply||""}get seq(){return this.info.streamSequence}doAck(e){this.didAck||(this.didAck=!this.isWIP(e),this.msg.respond(e))}isWIP(e){return 4===e.length&&e[0]===Qt[0]&&e[1]===Qt[1]&&e[2]===Qt[2]&&e[3]===Qt[3]}async ackAck(){if(!this.didAck&&(this.didAck=!0,this.msg.reply)){const e=this.msg.publisher,t=!e.options?.noAsyncTraces,s=new nt(e.muxSubscriptions,this.msg.reply,{timeout:1e3},t);e.request(s);try{e.publish(this.msg.reply,Yt,{reply:`${e.muxSubscriptions.baseInbox}${s.token}`})}catch(e){s.cancel(e)}try{return await Promise.race([s.timer,s.deferred]),!0}catch(e){s.cancel(e)}}return!1}ack(){this.doAck(Yt)}nak(e){let t=Xt;e&&(t=oe().encode(`-NAK ${JSON.stringify({delay:ut(e)})}`)),this.doAck(t)}working(){this.doAck(Qt)}next(e,t={batch:1}){const s={};s.batch=t.batch||1,s.no_wait=t.no_wait||!1,t.expires&&t.expires>0&&(s.expires=ut(t.expires));const r=ae().encode(s),i=N.concat(Zt,ts,r),n=e?{reply:e}:void 0;this.msg.respond(i,n)}term(e=""){let t=es;e?.length>0&&(t=oe().encode(`+TERM ${e}`)),this.doAck(t)}json(){return this.msg.json()}string(){return this.msg.string()}}function is(t,s,r=!1){if(!0===r&&!t)throw m.errorForCode(e.ErrorCode.ApiError,new Error(`${s} is not a function`));if(t&&"function"!=typeof t)throw m.errorForCode(e.ErrorCode.ApiError,new Error(`${s} is not a function`))}class ns extends te{sub;adapter;subIterDone;constructor(e,t,s){super(),is(s.adapter,"adapter",!0),this.adapter=s.adapter,s.callback&&is(s.callback,"callback"),this.noIterator="function"==typeof s.callback,s.ingestionFilterFn&&(is(s.ingestionFilterFn,"ingestionFilterFn"),this.ingestionFilterFn=s.ingestionFilterFn),s.protocolFilterFn&&(is(s.protocolFilterFn,"protocolFilterFn"),this.protocolFilterFn=s.protocolFilterFn),s.dispatchedFn&&(is(s.dispatchedFn,"dispatchedFn"),this.dispatchedFn=s.dispatchedFn),s.cleanupFn&&is(s.cleanupFn,"cleanupFn");let r=(e,t)=>{this.callback(e,t)};if(s.callback){const e=s.callback;r=(t,s)=>{const[r,i]=this.adapter(t,s);if(r)return void e(r,null);const{ingest:n}=this.ingestionFilterFn?this.ingestionFilterFn(i,this):{ingest:!0};if(n){(!this.protocolFilterFn||this.protocolFilterFn(i))&&(e(r,i),this.dispatchedFn&&i&&this.dispatchedFn(i))}}}const{max:i,queue:n,timeout:o}=s,a={queue:n,timeout:o,callback:r};i&&i>0&&(a.max=i),this.sub=e.subscribe(t,a),s.cleanupFn&&(this.sub.cleanupFn=s.cleanupFn),this.noIterator||this.iterClosed.then((()=>{this.unsubscribe()})),this.subIterDone=j(),Promise.all([this.sub.closed,this.iterClosed]).then((()=>{this.subIterDone.resolve()})).catch((()=>{this.subIterDone.resolve()})),(async e=>{await e.closed,this.stop()})(this.sub).then().catch()}unsubscribe(e){this.sub.unsubscribe(e)}drain(){return this.sub.drain()}isDraining(){return this.sub.isDraining()}isClosed(){return this.sub.isClosed()}callback(e,t){this.sub.cancelTimeout();const[s,r]=this.adapter(e,t);s&&this.stop(s),r&&this.push(r)}getSubject(){return this.sub.getSubject()}getReceived(){return this.sub.getReceived()}getProcessed(){return this.sub.getProcessed()}getPending(){return this.sub.getPending()}getID(){return this.sub.getID()}getMax(){return this.sub.getMax()}get closed(){return this.sub.closed}}class os{interval;maxOut;cancelAfter;timer;autoCancelTimer;last;missed;count;callback;constructor(e,t,s={maxOut:2}){this.interval=e,this.maxOut=s?.maxOut||2,this.cancelAfter=s?.cancelAfter||0,this.last=Date.now(),this.missed=0,this.count=0,this.callback=t,this._schedule()}cancel(){this.autoCancelTimer&&clearTimeout(this.autoCancelTimer),this.timer&&clearInterval(this.timer),this.timer=0,this.autoCancelTimer=0}work(){this.last=Date.now(),this.missed=0}_change(e,t=0,s=2){this.interval=e,this.maxOut=s,this.cancelAfter=t,this.restart()}restart(){this.cancel(),this._schedule()}_schedule(){this.cancelAfter>0&&(this.autoCancelTimer=setTimeout((()=>{this.cancel()}),this.cancelAfter)),this.timer=setInterval((()=>{if(this.count++,Date.now()-this.last>this.interval&&this.missed++,this.missed>=this.maxOut)try{!0===this.callback(this.missed)&&this.cancel()}catch(e){console.log(e)}}),this.interval)}}var as,cs,hs,us;!function(e){e[e.Unset=-1]="Unset",e[e.Consume=0]="Consume",e[e.Fetch=1]="Fetch"}(as||(as={})),e.ConsumerEvents=void 0,(cs=e.ConsumerEvents||(e.ConsumerEvents={})).HeartbeatsMissed="heartbeats_missed",cs.ConsumerNotFound="consumer_not_found",cs.OrderedConsumerRecreated="ordered_consumer_recreated",e.ConsumerDebugEvents=void 0,(hs=e.ConsumerDebugEvents||(e.ConsumerDebugEvents={})).DebugEvent="debug",hs.Discard="discard",hs.Next="next";class ls extends te{consumer;opts;sub;monitor;pending;inbox;refilling;stack;pong;callback;timeout;cleanupHandler;listeners;statusIterator;forOrderedConsumer;resetHandler;constructor(e,t,s=!1){super(),this.consumer=e,this.opts=this.parseOptions(t,s),this.callback=t.callback||null,this.noIterator="function"==typeof this.callback,this.monitor=null,this.pong=null,this.pending={msgs:0,bytes:0,requests:0},this.refilling=s,this.stack=(new Error).stack.split("\n").slice(1).join("\n"),this.timeout=null,this.inbox=S(e.api.nc.options.inboxPrefix),this.listeners=[],this.forOrderedConsumer=!1,this.start()}start(){const{max_messages:t,max_bytes:s,idle_heartbeat:r,threshold_bytes:i,threshold_messages:n}=this.opts;this.closed().then((()=>{if(this.cleanupHandler)try{this.cleanupHandler()}catch(e){}}));const{sub:o}=this;o&&o.unsubscribe(),this.sub=this.consumer.api.nc.subscribe(this.inbox,{callback:(r,o)=>{if(r)return void this.stop();this.monitor?.work();if(o.subject===this.inbox){if(ft(o))return;const t=o.headers?.code,s=o.headers?.description?.toLowerCase()||"unknown",{msgsLeft:r,bytesLeft:i}=this.parseDiscard(o.headers);if(r>0||i>0)this.pending.msgs-=r,this.pending.bytes-=i,this.pending.requests--,this.notify(e.ConsumerDebugEvents.Discard,{msgsLeft:r,bytesLeft:i});else{const r=()=>{const e=new m(s,`${t}`);return e.stack+=`\n\n${this.stack}`,e};if(400===t){const e=r();this._push((()=>{this.stop(e)}))}else if(409===t&&"consumer deleted"===s){const e=r();this.stop(e)}else this.notify(e.ConsumerDebugEvents.DebugEvent,`${t} ${s}`)}}else this._push(ss(o)),this.received++,this.pending.msgs&&this.pending.msgs--,this.pending.bytes&&(this.pending.bytes-=o.size());if(0===this.pending.msgs&&0===this.pending.bytes&&(this.pending.requests=0),this.refilling){if(t&&this.pending.msgs<=n||s&&this.pending.bytes<=i){const e=this.pullOptions();this.pull(e)}}else 0===this.pending.requests&&this._push((()=>{this.stop()}))}}),this.sub.closed.then((()=>{this.sub.draining&&this._push((()=>{this.stop()}))})),r&&(this.monitor=new os(r,(t=>(this.notify(e.ConsumerEvents.HeartbeatsMissed,t),this.resetPending().then((()=>{})).catch((()=>{})),!1)),{maxOut:2})),(async()=>{const t=this.consumer.api.nc.status();this.statusIterator=t;for await(const s of t)switch(s.type){case e.Events.Disconnect:this.monitor?.cancel();break;case e.Events.Reconnect:this.resetPending().then((e=>{e&&this.monitor?.restart()})).catch((()=>{}))}})(),this.pull(this.pullOptions())}_push(e){if(this.callback){const t="function"==typeof e?e:null;try{t?t():this.callback(e)}catch(e){this.stop(e)}}else super.push(e)}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach((s=>{s.done||s.push({type:e,data:t})}))})()}async resetPending(){let t=0;const s=I();let r=0;for(;;){if(this.consumer.api.nc.isClosed())return console.error("aborting resetPending - connection is closed"),!1;try{return await this.consumer.info(),t=0,this.pending.msgs=0,this.pending.bytes=0,this.pending.requests=0,this.pull(this.pullOptions()),!0}catch(i){if("consumer not found"===i.message){if(t++,this.notify(e.ConsumerEvents.ConsumerNotFound,t),this.resetHandler)try{this.resetHandler()}catch(e){}if(this.forOrderedConsumer)return!1}else t=0;const n=s.backoff(r);await Promise.race([k(n),this.consumer.api.nc.closed()]),r++}}}pull(t){this.pending.bytes+=t.max_bytes??0,this.pending.msgs+=t.batch??0,this.pending.requests++;const s=this.consumer.api.nc;this._push((()=>{s.publish(`${this.consumer.api.prefix}.CONSUMER.MSG.NEXT.${this.consumer.stream}.${this.consumer.name}`,this.consumer.api.jc.encode(t),{reply:this.inbox}),this.notify(e.ConsumerDebugEvents.Next,t)}))}pullOptions(){return{batch:this.opts.max_messages-this.pending.msgs,max_bytes:this.opts.max_bytes-this.pending.bytes,idle_heartbeat:ut(this.opts.idle_heartbeat),expires:ut(this.opts.expires)}}parseDiscard(t){const s={msgsLeft:0,bytesLeft:0},r=t?.get(e.JsHeaders.PendingMessagesHdr);r&&(s.msgsLeft=parseInt(r));const i=t?.get(e.JsHeaders.PendingBytesHdr);return i&&(s.bytesLeft=parseInt(i)),s}trackTimeout(e){this.timeout=e}close(){return this.stop(),this.iterClosed}closed(){return this.iterClosed}clearTimers(){this.monitor?.cancel(),this.monitor=null,this.timeout?.cancel(),this.timeout=null}setCleanupHandler(e){this.cleanupHandler=e}stop(e){this.sub?.unsubscribe(),this.clearTimers(),this.statusIterator?.stop(),this._push((()=>{super.stop(e),this.listeners.forEach((e=>{e.stop()}))}))}parseOptions(e,t=!1){const s=e||{};if(s.max_messages=s.max_messages||0,s.max_bytes=s.max_bytes||0,0!==s.max_messages&&0!==s.max_bytes)throw new Error("only specify one of max_messages or max_bytes");if(0===s.max_messages&&(s.max_messages=100),s.expires=s.expires||3e4,s.expires<1e3)throw new Error("expires should be at least 1000ms");if(s.idle_heartbeat=s.idle_heartbeat||s.expires/2,s.idle_heartbeat=s.idle_heartbeat>3e4?3e4:s.idle_heartbeat,t){const e=Math.round(.75*s.max_messages)||1;s.threshold_messages=s.threshold_messages||e;const t=Math.round(.75*s.max_bytes)||1;s.threshold_bytes=s.threshold_bytes||t}return s}status(){const e=new te;return this.listeners.push(e),Promise.resolve(e)}}class ds extends te{src;listeners;constructor(){super(),this.listeners=[]}setSource(e){this.src&&(this.src.resetHandler=void 0,this.src.setCleanupHandler(),this.src.stop()),this.src=e,this.src.setCleanupHandler((()=>{this.close().catch()})),(async()=>{const e=await this.src.status();for await(const t of e)this.notify(t.type,t.data)})().catch((()=>{}))}notify(e,t){this.listeners.length>0&&(()=>{this.listeners.forEach((s=>{s.done||s.push({type:e,data:t})}))})()}stop(e){this.src?.stop(e),super.stop(e),this.listeners.forEach((e=>{e.stop()}))}close(){return this.stop(),this.iterClosed}status(){const e=new te;return this.listeners.push(e),Promise.resolve(e)}}class fs{api;_info;stream;name;constructor(e,t){this.api=e,this._info=t,this.stream=t.stream_name,this.name=t.name}consume(e={max_messages:100,expires:3e4}){return Promise.resolve(new ls(this,e,!0))}fetch(e={max_messages:100,expires:3e4}){const t=new ls(this,e,!1),s=A(Math.round(1.05*t.opts.expires));return t.closed().then((()=>{s.cancel()})),s.catch((()=>{t.close().catch()})),t.trackTimeout(s),Promise.resolve(t)}next(t={expires:3e4}){const s=j(),r=t;r.max_messages=1;const i=new ls(this,r,!1),n=Math.round(1.05*i.opts.expires);n>=6e4&&(async()=>{for await(const t of await i.status())if(t.type===e.ConsumerEvents.HeartbeatsMissed&&t.data>=2){s.reject(new Error("consumer missed heartbeats"));break}})().catch(),(async()=>{for await(const e of i){s.resolve(e);break}})().catch();const o=A(n);return i.closed().then((()=>{s.resolve(null),o.cancel()})).catch((e=>{s.reject(e)})),o.catch((e=>{s.resolve(null),i.close().catch()})),i.trackTimeout(o),s}delete(){const{stream_name:e,name:t}=this._info;return this.api.delete(e,t)}info(e=!1){if(e)return Promise.resolve(this._info);const{stream_name:t,name:s}=this._info;return this.api.info(t,s).then((e=>(this._info=e,this._info)))}}class ps{api;consumerOpts;consumer;opts;cursor;stream;namePrefix;serial;currentConsumer;userCallback;iter;type;startSeq;constructor(e,t,s={}){this.api=e,this.stream=t,this.cursor={stream_seq:1,deliver_seq:0},this.namePrefix=h.next(),this.serial=0,this.currentConsumer=null,this.userCallback=null,this.iter=null,this.type=as.Unset,this.consumerOpts=s,this.startSeq=this.consumerOpts.opt_start_seq||0,this.cursor.stream_seq=this.startSeq>0?this.startSeq-1:0}getConsumerOpts(t){this.serial++;t=0===t?1:t;const s={name:`${this.namePrefix}_${this.serial}`,deliver_policy:e.DeliverPolicy.StartSequence,opt_start_seq:t,ack_policy:e.AckPolicy.None,inactive_threshold:ut(3e5),num_replicas:1};return!0===this.consumerOpts.headers_only&&(s.headers_only=!0),Array.isArray(this.consumerOpts.filterSubjects)&&(s.filter_subjects=this.consumerOpts.filterSubjects),"string"==typeof this.consumerOpts.filterSubjects&&(s.filter_subject=this.consumerOpts.filterSubjects),t===this.startSeq+1&&(s.deliver_policy=this.consumerOpts.deliver_policy||e.DeliverPolicy.StartSequence,this.consumerOpts.deliver_policy!==e.DeliverPolicy.LastPerSubject&&this.consumerOpts.deliver_policy!==e.DeliverPolicy.New&&this.consumerOpts.deliver_policy!==e.DeliverPolicy.Last||(delete s.opt_start_seq,s.deliver_policy=this.consumerOpts.deliver_policy),s.deliver_policy===e.DeliverPolicy.LastPerSubject&&void 0===s.filter_subjects&&void 0===s.filter_subject&&(s.filter_subject=">"),this.consumerOpts.opt_start_time&&(delete s.opt_start_seq,s.deliver_policy=e.DeliverPolicy.StartTime,s.opt_start_time=this.consumerOpts.opt_start_time),this.consumerOpts.inactive_threshold&&(s.inactive_threshold=ut(this.consumerOpts.inactive_threshold))),s}async resetConsumer(t=0){this.consumer?.delete().catch((()=>{})),t=0===t?1:t,this.cursor.deliver_seq=0;const s=this.getConsumerOpts(t);s.max_deliver=1,s.mem_storage=!0;const r=I();let i;for(let n=0;;n++)try{i=await this.api.add(this.stream,s),this.iter?.notify(e.ConsumerEvents.OrderedConsumerRecreated,i.name);break}catch(e){if(0===t&&n>=30)throw e;await k(r.backoff(n+1))}return i}internalHandler(e){return t=>{if(this.serial!==e)return;const s=t.info.deliverySequence;s===this.cursor.deliver_seq+1?(this.cursor.deliver_seq=s,this.cursor.stream_seq=t.info.streamSequence,this.userCallback?this.userCallback(t):this.iter?.push(t)):this.reset(this.opts)}}async reset(e={max_messages:100,expires:3e4},t=!1){this.currentConsumer=await this.resetConsumer(this.cursor.stream_seq+1),null===this.iter&&(this.iter=new ds),this.consumer=new fs(this.api,this.currentConsumer);e.callback=this.internalHandler(this.serial);let s=null;if(this.type===as.Fetch&&t)s=await this.consumer.fetch(e);else{if(this.type!==as.Consume)return Promise.reject("reset called with unset consumer type");s=await this.consumer.consume(e)}const r=s;return r.forOrderedConsumer=!0,r.resetHandler=()=>{this.reset(this.opts)},this.iter.setSource(r),this.iter}consume(e={max_messages:100,expires:3e4}){if(this.type===as.Fetch)return Promise.reject(new Error("ordered consumer initialized as fetch"));if(this.type===as.Consume)return Promise.reject(new Error("ordered consumer doesn't support concurrent consume"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=as.Consume,this.opts=e,this.reset(e)}fetch(e={max_messages:100,expires:3e4}){if(this.type===as.Consume)return Promise.reject(new Error("ordered consumer already initialized as consume"));if(!1===this.iter?.done)return Promise.reject(new Error("ordered consumer doesn't support concurrent fetch"));const{callback:t}=e;return t&&(this.userCallback=t),this.type=as.Fetch,this.opts=e,this.iter=new ds,this.reset(e,!0)}async next(e={expires:3e4}){const t=j(),s=e;s.max_messages=1,s.callback=e=>{this.userCallback=null,t.resolve(e)};return(await this.fetch(s)).iterClosed.then((()=>{t.resolve(null)})).catch((e=>{t.reject(e)})),t}delete(){return this.currentConsumer?this.api.delete(this.stream,this.currentConsumer.name).then((e=>Promise.resolve(e))).catch((e=>Promise.reject(e))).finally((()=>{this.currentConsumer=null})):Promise.resolve(!1)}async info(e){return null==this.currentConsumer?(this.currentConsumer=await this.resetConsumer(this.serial),Promise.resolve(this.currentConsumer)):e&&this.currentConsumer?Promise.resolve(this.currentConsumer):this.api.info(this.stream,this.currentConsumer.name)}}function ms(e){if(void 0===e)return;const{domain:t}=e;if(void 0===t)return e;const s=Object.assign({},e);if(delete s.domain,""===t)return s;if(s.external)throw new Error("domain and external are both set");return s.external={api:`$JS.${t}.API`},s}const gs="OBJ_";class bs{api;notified;constructor(e){this.api=e,this.notified=!1}checkVersion(){const e=this.api.nc.features.get(ve.JS_SIMPLIFICATION);return e.ok?Promise.resolve():Promise.reject(new Error(`consumers framework is only supported on servers ${e.min} or better`))}async get(e,t={}){return"object"==typeof t?this.ordered(e,t):(await this.checkVersion(),this.api.info(e,t).then((e=>void 0!==e.config.deliver_subject?Promise.reject(new Error("push consumer not supported")):new fs(this.api,e))).catch((e=>Promise.reject(e))))}async ordered(e,t){await this.checkVersion();const s=this.api;return new Ms(s.nc,s.opts).info(e).then((s=>Promise.resolve(new ps(this.api,e,t)))).catch((e=>Promise.reject(e)))}}class ys{api;_info;constructor(e,t){this.api=e,this._info=t}get name(){return this._info.config.name}alternates(){return this.info().then((e=>e.alternates?e.alternates:[]))}async best(){if(await this.info(),this._info.alternates){const e=await this.api.info(this._info.alternates[0].name);return new ys(this.api,e)}return this}info(e=!1,t){return e?Promise.resolve(this._info):this.api.info(this.name,t).then((e=>(this._info=e,this._info)))}getConsumer(e){return new bs(new Wt(this.api.nc,this.api.opts)).get(this.name,e)}getMessage(e){return this.api.getMessage(this.name,e)}deleteMessage(e,t){return this.api.deleteMessage(this.name,e,t)}}const _s="KV-Operation",ws=/^[-/=.\w]+$/,vs=/^[-/=.>*\w]+$/,Ss=/^[-\w]+$/;function Es(e){if(e.startsWith(".")||e.endsWith(".")||!ws.test(e))throw new Error(`invalid key: ${e}`)}function Ps(e){if(e.startsWith(".")||e.endsWith(".")||!vs.test(e))throw new Error(`invalid key: ${e}`)}function Cs(e){if(e.startsWith(".")||e.endsWith("."))throw new Error(`invalid key: ${e}`);const t=e.split(".");let s=!1;for(let r=0;r<t.length;r++)switch(t[r]){case"*":s=!0;break;case">":if(r!==t.length-1)throw new Error(`invalid key: ${e}`);s=!0}return s}function xs(e){if(!Ss.test(e))throw new Error(`invalid bucket name: ${e}`)}!function(e){e.MsgIdHdr="Nats-Msg-Id",e.ExpectedStreamHdr="Nats-Expected-Stream",e.ExpectedLastSeqHdr="Nats-Expected-Last-Sequence",e.ExpectedLastMsgIdHdr="Nats-Expected-Last-Msg-Id",e.ExpectedLastSubjectSequenceHdr="Nats-Expected-Last-Subject-Sequence"}(us||(us={}));class As{js;jsm;stream;bucket;direct;codec;prefix;editPrefix;useJsPrefix;_prefixLen;constructor(e,t,s){xs(e),this.js=t,this.jsm=s,this.bucket=e,this.prefix="$KV",this.editPrefix="",this.useJsPrefix=!1,this._prefixLen=0}static async create(e,t,s={}){xs(t);const r=await e.jetstreamManager(),i=new As(t,e,r);return await i.init(s),i}static async bind(e,t,s={}){const r=await e.jetstreamManager(),i=await r.streams.info(`${Nt}${t}`);xs(i.config.name);const n=new As(t,e,r);return Object.assign(n,i),n.codec=s.codec||{key:{encode:e=>e,decode:e=>e},value:{encode:e=>e,decode:e=>e}},n.direct=i.config.allow_direct??!1,n.initializePrefixes(i),n}async init(t={}){const s=Object.assign({replicas:1,history:1,timeout:2e3,maxBucketSize:-1,maxValueSize:-1,codec:{key:{encode:e=>e,decode:e=>e},value:{encode:e=>e,decode:e=>e}},storage:e.StorageType.File},t);this.codec=s.codec;const r={};this.stream=r.name=t.streamName??this.bucketName(),r.retention=e.RetentionPolicy.Limits,r.max_msgs_per_subject=s.history,s.maxBucketSize&&(s.max_bytes=s.maxBucketSize),s.max_bytes&&(r.max_bytes=s.max_bytes),r.max_msg_size=s.maxValueSize,r.storage=s.storage;const i=t.placementCluster??"";if(i&&(t.placement={},t.placement.cluster=i,t.placement.tags=[]),t.placement&&(r.placement=t.placement),t.republish&&(r.republish=t.republish),t.description&&(r.description=t.description),t.mirror){const e=Object.assign({},t.mirror);e.name.startsWith(Nt)||(e.name=`${Nt}${e.name}`),r.mirror=e,r.mirror_direct=!0}else if(t.sources){const e=t.sources.map((e=>{const t=Object.assign({},e);t.name.startsWith(Nt)||(t.name=`${Nt}${t.name}`)}));r.sources=e}else r.subjects=[this.subjectForBucket()];t.metadata&&(r.metadata=t.metadata),"boolean"==typeof t.compression&&(r.compression=t.compression?e.StoreCompression.S2:e.StoreCompression.None);const n=this.js.nc,o=n.getServerVersion(),a=!!o&&Ee(o,Se("2.7.2"))>=0;r.discard=a?e.DiscardPolicy.New:e.DiscardPolicy.Old;const{ok:c,min:h}=n.features.get(ve.JS_ALLOW_DIRECT);if(!c&&!0===t.allow_direct){const e=o?`${o.major}.${o.minor}.${o.micro}`:"unknown";return Promise.reject(new Error(`allow_direct is not available on server version ${e} - requires ${h}`))}let u;t.allow_direct="boolean"==typeof t.allow_direct?t.allow_direct:c,r.allow_direct=t.allow_direct,this.direct=r.allow_direct,r.num_replicas=s.replicas,s.ttl&&(r.max_age=ut(s.ttl)),r.allow_rollup_hdrs=!0;try{u=await this.jsm.streams.info(r.name),u.config.allow_direct||!0!==this.direct||(this.direct=!1)}catch(e){if("stream not found"!==e.message)throw e;u=await this.jsm.streams.add(r)}this.initializePrefixes(u)}initializePrefixes(e){this._prefixLen=0,this.prefix=`$KV.${this.bucket}`,this.useJsPrefix="$JS.API"!==this.js.apiPrefix;const{mirror:t}=e.config;if(t){let e=t.name;if(e.startsWith(Nt)&&(e=e.substring(3)),t.external&&""!==t.external.api){const s=t.name.substring(3);this.useJsPrefix=!1,this.prefix=`$KV.${s}`,this.editPrefix=`${t.external.api}.$KV.${e}`}else this.editPrefix=this.prefix}}bucketName(){return this.stream??`${Nt}${this.bucket}`}subjectForBucket(){return`${this.prefix}.${this.bucket}.>`}subjectForKey(e,t=!1){const s=[];return t?(this.useJsPrefix&&s.push(this.js.apiPrefix),""!==this.editPrefix?s.push(this.editPrefix):s.push(this.prefix)):this.prefix&&s.push(this.prefix),s.push(e),s.join(".")}fullKeyName(e){return""!==this.prefix?`${this.prefix}.${e}`:`$KV.${this.bucket}.${e}`}get prefixLen(){return 0===this._prefixLen&&(this._prefixLen=this.prefix.length+1),this._prefixLen}encodeKey(e){const t=[];for(const s of e.split("."))switch(s){case">":case"*":t.push(s);break;default:t.push(this.codec.key.encode(s))}return t.join(".")}decodeKey(e){const t=[];for(const s of e.split("."))switch(s){case">":case"*":t.push(s);break;default:t.push(this.codec.key.decode(s))}return t.join(".")}validateKey=Es;validateSearchKey=Ps;hasWildcards=Cs;close(){return Promise.resolve()}dataLen(t,s){const r=s&&s.get(e.JsHeaders.MessageSizeHdr)||"";return""!==r?parseInt(r,10):t.length}smToEntry(e){return new Rs(this.bucket,this.prefixLen,e)}jmToEntry(e){const t=this.decodeKey(e.subject.substring(this.prefixLen));return new $s(this.bucket,t,e)}async create(e,t){let s;try{const s=await this.put(e,t,{previousSeq:0});return Promise.resolve(s)}catch(e){if(s=e,10071!==e?.api_error?.err_code)return Promise.reject(e)}let r=0;try{const i=await this.get(e);return"DEL"===i?.operation||"PURGE"===i?.operation?(r=null!==i?i.revision:0,this.update(e,t,r)):Promise.reject(s)}catch(e){return Promise.reject(e)}}update(e,t,s){if(s<=0)throw new Error("version must be greater than 0");return this.put(e,t,{previousSeq:s})}async put(e,t,s={}){const r=this.encodeKey(e);this.validateKey(r);const i={};if(void 0!==s.previousSeq){const e=re();i.headers=e,e.set(us.ExpectedLastSubjectSequenceHdr,`${s.previousSeq}`)}try{return(await this.js.publish(this.subjectForKey(r,!0),t,i)).seq}catch(e){const t=e;return t.isJetStreamError()?(t.message=t.api_error?.description,t.code=`${t.api_error?.code}`,Promise.reject(t)):Promise.reject(e)}}async get(t,s){const r=this.encodeKey(t);this.validateKey(r);let i,n={last_by_subj:this.subjectForKey(r)};s&&s.revision>0&&(n={seq:s.revision});try{if(this.direct){const e=this.jsm.direct;i=await e.getMessage(this.bucketName(),n)}else i=await this.jsm.streams.getMessage(this.bucketName(),n);const e=this.smToEntry(i);return e.key!==r?null:e}catch(t){if(t.code===e.ErrorCode.JetStream404NoMessages)return null;throw t}}purge(e){return this._deleteOrPurge(e,"PURGE")}delete(e){return this._deleteOrPurge(e,"DEL")}async purgeDeletes(e=18e5){const t=j(),s=[],r=await this.watch({key:">",initializedFn:()=>{t.resolve()}});(async()=>{for await(const e of r)"DEL"!==e.operation&&"PURGE"!==e.operation||s.push(e)})().then(),await t,r.stop();const i=Date.now()-e,n=s.map((e=>{const t=this.subjectForKey(e.key);return e.created.getTime()>=i?this.jsm.streams.purge(this.stream,{filter:t,keep:1}):this.jsm.streams.purge(this.stream,{filter:t,keep:0})})),o=await Promise.all(n);return o.unshift({success:!0,purged:0}),o.reduce(((e,t)=>(e.purged+=t.purged,e)))}async _deleteOrPurge(e,t){if(!this.hasWildcards(e))return this._doDeleteOrPurge(e,t);const s=await this.keys(e),r=[];for await(const e of s)r.push(this._doDeleteOrPurge(e,t)),100===r.length&&(await Promise.all(r),r.length=0);r.length>0&&await Promise.all(r)}async _doDeleteOrPurge(s,r){const i=this.encodeKey(s);this.validateKey(i);const n=re();n.set(_s,r),"PURGE"===r&&n.set(e.JsHeaders.RollupHdr,e.JsHeaders.RollupValueSubject),await this.js.publish(this.subjectForKey(i,!0),t,{headers:n})}_buildCC(t,s,r={}){const i=this.encodeKey(t);this.validateSearchKey(t);let n=e.DeliverPolicy.LastPerSubject;return s===Ot.AllHistory&&(n=e.DeliverPolicy.All),s===Ot.UpdatesOnly&&(n=e.DeliverPolicy.New),Object.assign({deliver_policy:n,ack_policy:e.AckPolicy.None,filter_subject:this.fullKeyName(i),flow_control:!0,idle_heartbeat:ut(5e3)},r)}remove(e){return this.purge(e)}async history(e={}){const t=e.key??">",s=new te,r={};let i;r.headers_only=e.headers_only||!1,i=()=>{s.stop()};let n=0;const o=this._buildCC(t,Ot.AllHistory,r),a=o.filter_subject,c=$t(o);c.bindStream(this.stream),c.orderedConsumer(),c.callback(((e,t)=>{if(e)s.stop(e);else if(t){const e=this.jmToEntry(t);s.push(e),s.received++,(i&&n>0&&s.received>=n||0===t.info.pending)&&(s.push(i),i=void 0)}}));const h=await this.js.subscribe(a,c);if(i){const{info:{last:e}}=h,t=e.num_pending+e.delivered.consumer_seq;if(0===t||s.received>=t)try{i()}catch(e){s.stop(e)}finally{i=void 0}else n=t}return s._data=h,s.iterClosed.then((()=>{h.unsubscribe()})),h.closed.then((()=>{s.stop()})).catch((e=>{s.stop(e)})),s}async watch(e={}){const t=e.key??">",s=new te,r={};r.headers_only=e.headers_only||!1;let i=Ot.LastValue;e.include===Ot.AllHistory?i=Ot.AllHistory:e.include===Ot.UpdatesOnly&&(i=Ot.UpdatesOnly);const n=!0===e.ignoreDeletes;let o=e.initializedFn,a=0;const c=this._buildCC(t,i,r),h=c.filter_subject,u=$t(c);u.bindStream(this.stream),u.orderedConsumer(),u.callback(((e,t)=>{if(e)s.stop(e);else if(t){const e=this.jmToEntry(t);if(n&&"DEL"===e.operation)return;s.push(e),s.received++,o&&(a>0&&s.received>=a||0===t.info.pending)&&(s.push(o),o=void 0)}}));const l=await this.js.subscribe(h,u);if(o){const{info:{last:e}}=l,t=e.num_pending+e.delivered.consumer_seq;if(0===t||s.received>=t)try{o()}catch(e){s.stop(e)}finally{o=void 0}else a=t}return s._data=l,s.iterClosed.then((()=>{l.unsubscribe()})),l.closed.then((()=>{s.stop()})).catch((e=>{s.stop(e)})),s}async keys(e=">"){const t=new te,s=this._buildCC(e,Ot.LastValue,{headers_only:!0}),r=s.filter_subject,i=$t(s);i.bindStream(this.stream),i.orderedConsumer();const n=await this.js.subscribe(r,i);(async()=>{for await(const e of n){const s=e.headers?.get(_s);if("DEL"!==s&&"PURGE"!==s){const s=this.decodeKey(e.subject.substring(this.prefixLen));t.push(s)}0===e.info.pending&&n.unsubscribe()}})().then((()=>{t.stop()})).catch((e=>{t.stop(e)}));return 0===n.info.last.num_pending&&n.unsubscribe(),t}purgeBucket(e){return this.jsm.streams.purge(this.bucketName(),e)}destroy(){return this.jsm.streams.delete(this.bucketName())}async status(){const e=this.js.nc,t=e.info?.cluster??"",s=this.bucketName(),r=await this.jsm.streams.info(s);return new ks(r,t)}}class ks{si;cluster;constructor(e,t=""){this.si=e,this.cluster=t}get bucket(){return this.si.config.name.startsWith(Nt)?this.si.config.name.substring(3):this.si.config.name}get values(){return this.si.state.messages}get history(){return this.si.config.max_msgs_per_subject}get ttl(){return lt(this.si.config.max_age)}get bucket_location(){return this.cluster}get backingStore(){return this.si.config.storage}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get description(){return this.si.config.description??""}get maxBucketSize(){return this.si.config.max_bytes}get maxValueSize(){return this.si.config.max_msg_size}get max_bytes(){return this.si.config.max_bytes}get placement(){return this.si.config.placement||{cluster:"",tags:[]}}get placementCluster(){return this.si.config.placement?.cluster??""}get republish(){return this.si.config.republish??{src:"",dest:""}}get streamInfo(){return this.si}get size(){return this.si.state.bytes}get metadata(){return this.si.config.metadata??{}}get compression(){return!!this.si.config.compression&&this.si.config.compression!==e.StoreCompression.None}}const js="SHA-256=";class Os{si;backingStore;constructor(e){this.si=e,this.backingStore="JetStream"}get bucket(){return(e=this.si.config.name).startsWith(gs)?e.substring(4):e;var e}get description(){return this.si.config.description??""}get ttl(){return this.si.config.max_age}get storage(){return this.si.config.storage}get replicas(){return this.si.config.num_replicas}get sealed(){return this.si.config.sealed}get size(){return this.si.state.bytes}get streamInfo(){return this.si}get metadata(){return this.si.config.metadata}get compression(){return!!this.si.config.compression&&this.si.config.compression!==e.StoreCompression.None}}class Ms extends bt{constructor(e,t){super(e,t)}checkStreamConfigVersions(e){const t=this.nc;if(e.metadata){const{min:e,ok:s}=t.features.get(ve.JS_STREAM_CONSUMER_METADATA);if(!s)throw new Error(`stream 'metadata' requires server ${e}`)}if(e.first_seq){const{min:e,ok:s}=t.features.get(ve.JS_STREAM_FIRST_SEQ);if(!s)throw new Error(`stream 'first_seq' requires server ${e}`)}if(e.subject_transform){const{min:e,ok:s}=t.features.get(ve.JS_STREAM_SUBJECT_TRANSFORM);if(!s)throw new Error(`stream 'subject_transform' requires server ${e}`)}if(e.compression){const{min:e,ok:s}=t.features.get(ve.JS_STREAM_COMPRESSION);if(!s)throw new Error(`stream 'compression' requires server ${e}`)}if(e.consumer_limits){const{min:e,ok:s}=t.features.get(ve.JS_DEFAULT_CONSUMER_LIMITS);if(!s)throw new Error(`stream 'consumer_limits' requires server ${e}`)}function s(e,s){if((s.subject_transforms?.length||0)>0){const{min:s,ok:r}=t.features.get(ve.JS_STREAM_SOURCE_SUBJECT_TRANSFORM);if(!r)throw new Error(`${e} 'subject_transforms' requires server ${s}`)}}e.sources&&e.sources.forEach((e=>{s("stream sources",e)})),e.mirror&&s("stream mirror",e.mirror)}async add(e={}){this.checkStreamConfigVersions(e),at(e.name),e.mirror=ms(e.mirror),e.sources=e.sources?.map(ms);const t=await this._request(`${this.prefix}.STREAM.CREATE.${e.name}`,e);return this._fixInfo(t),t}async delete(e){at(e);return(await this._request(`${this.prefix}.STREAM.DELETE.${e}`)).success}async update(e,t={}){if("object"==typeof e){const s=e;e=s.name,t=s,console.trace("[33m >> streams.update(config: StreamConfig) api changed to streams.update(name: string, config: StreamUpdateConfig) - this shim will be removed - update your code.  [0m")}this.checkStreamConfigVersions(t),at(e);const s=await this.info(e),r=Object.assign(s.config,t);r.mirror=ms(r.mirror),r.sources=r.sources?.map(ms);const i=await this._request(`${this.prefix}.STREAM.UPDATE.${e}`,r);return this._fixInfo(i),i}async info(e,t){at(e);const s=`${this.prefix}.STREAM.INFO.${e}`;let r=await this._request(s,t),{total:i,limit:n}=r,o=r.state.subjects?Object.getOwnPropertyNames(r.state.subjects).length:1;if(i&&i>o){const e=[r],a=t||{};let c=0;for(;i>o;){c++,a.offset=n*c;const t=await this._request(s,a);i=t.total,e.push(t);const r=Object.getOwnPropertyNames(t.state.subjects).length;if(o+=r,r<n)break}let h={};for(let t=0;t<e.length;t++)r=e[t],r.state.subjects&&(h=Object.assign(h,r.state.subjects));r.offset=0,r.total=0,r.limit=0,r.state.subjects=h}return this._fixInfo(r),r}list(e=""){const t=e?.length?{subject:e}:{},s=`${this.prefix}.STREAM.LIST`;return new Vt(s,(e=>{const t=e;return t.streams.forEach((e=>{this._fixInfo(e)})),t.streams}),this,t)}_fixInfo(e){e.config.sealed=e.config.sealed||!1,e.config.deny_delete=e.config.deny_delete||!1,e.config.deny_purge=e.config.deny_purge||!1,e.config.allow_rollup_hdrs=e.config.allow_rollup_hdrs||!1}async purge(e,t){if(t){const{keep:e,seq:s}=t;if("number"==typeof e&&"number"==typeof s)throw new Error("can specify one of keep or seq")}at(e);return await this._request(`${this.prefix}.STREAM.PURGE.${e}`,t)}async deleteMessage(e,t,s=!0){at(e);const r={seq:t};s||(r.no_erase=!0);return(await this._request(`${this.prefix}.STREAM.MSG.DELETE.${e}`,r)).success}async getMessage(e,t){at(e);const s=await this._request(`${this.prefix}.STREAM.MSG.GET.${e}`,t);return new Is(s)}find(e){return this.findStream(e)}listKvs(){const e=`${this.prefix}.STREAM.LIST`;return new Vt(e,(e=>{const t=e.streams.filter((e=>e.config.name.startsWith(Nt)));t.forEach((e=>{this._fixInfo(e)}));let s="";t.length&&(s=this.nc.info?.cluster??"");return t.map((e=>new ks(e,s)))}),this)}listObjectStores(){const e=`${this.prefix}.STREAM.LIST`;return new Vt(e,(e=>{const t=e.streams.filter((e=>e.config.name.startsWith(gs)));t.forEach((e=>{this._fixInfo(e)}));return t.map((e=>new Os(e)))}),this)}names(e=""){const t=e?.length?{subject:e}:{},s=`${this.prefix}.STREAM.NAMES`;return new Vt(s,(e=>e.streams),this,t)}async get(e){const t=await this.info(e);return Promise.resolve(new ys(this,t))}}class Is{_header;smr;static jc;constructor(e){this.smr=e}get subject(){return this.smr.message.subject}get seq(){return this.smr.message.seq}get timestamp(){return this.smr.message.time}get time(){return new Date(Date.parse(this.timestamp))}get data(){return this.smr.message.data?this._parse(this.smr.message.data):t}get header(){if(!this._header)if(this.smr.message.hdrs){const e=this._parse(this.smr.message.hdrs);this._header=ne.decode(e)}else this._header=re();return this._header}_parse(e){const t=atob(e),s=t.length,r=new Uint8Array(s);for(let e=0;e<s;e++)r[e]=t.charCodeAt(e);return r}json(e){return ae(e).decode(this.data)}string(){return r.decode(this.data)}}class Ns{api;constructor(e){this.api=e}get(e){return this.api.info(e).then((e=>new ys(this.api,e)))}}class Rs{bucket;sm;prefixLen;constructor(e,t,s){this.bucket=e,this.prefixLen=t,this.sm=s}get key(){return this.sm.subject.substring(this.prefixLen)}get value(){return this.sm.data}get delta(){return 0}get created(){return this.sm.time}get revision(){return this.sm.seq}get operation(){return this.sm.header.get(_s)||"PUT"}get length(){const t=this.sm.header.get(e.JsHeaders.MessageSizeHdr)||"";return""!==t?parseInt(t,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class $s{bucket;key;sm;constructor(e,t,s){this.bucket=e,this.key=t,this.sm=s}get value(){return this.sm.data}get created(){return new Date(lt(this.sm.info.timestampNanos))}get revision(){return this.sm.seq}get operation(){return this.sm.headers?.get(_s)||"PUT"}get delta(){return this.sm.info.pending}get length(){const t=this.sm.headers?.get(e.JsHeaders.MessageSizeHdr)||"";return""!==t?parseInt(t,10):this.sm.data.length}json(){return this.sm.json()}string(){return this.sm.string()}}class Ts{info;hdrs;constructor(e){this.info=e}get name(){return this.info.name}get description(){return this.info.description??""}get headers(){return this.hdrs||(this.hdrs=ne.fromRecord(this.info.headers||{})),this.hdrs}get options(){return this.info.options}get bucket(){return this.info.bucket}get chunks(){return this.info.chunks}get deleted(){return this.info.deleted??!1}get digest(){return this.info.digest}get mtime(){return this.info.mtime}get nuid(){return this.info.nuid}get size(){return this.info.size}get revision(){return this.info.revision}get metadata(){return this.info.metadata||{}}isLink(){return void 0!==this.info.options?.link&&null!==this.info.options?.link}}function qs(e){const t={name:e.name,description:e.description??"",options:e.options,metadata:e.metadata};if(e.headers){const s=e.headers;t.headers=s.toRecord()}return t}class Us{jsm;js;stream;name;constructor(e,t,s){this.name=e,this.jsm=t,this.js=s}_checkNotEmpty(e){return e&&0!==e.length?{name:e}:{name:e,error:new Error("name cannot be empty")}}async info(e){const t=await this.rawInfo(e);return t?new Ts(t):null}async list(){const e=[],t=await this.watch({ignoreDeletes:!0,includeHistory:!0});for await(const s of t){if(null===s)break;e.push(s)}return Promise.resolve(e)}async rawInfo(e){const{name:t,error:s}=this._checkNotEmpty(e);if(s)return Promise.reject(s);const r=this._metaSubject(t);try{const e=await this.jsm.streams.getMessage(this.stream,{last_by_subj:r}),t=ae().decode(e.data);return t.revision=e.seq,t}catch(e){return"404"===e.code?null:Promise.reject(e)}}async _si(e){try{return await this.jsm.streams.info(this.stream,e)}catch(e){return"404"===e.code?null:Promise.reject(e)}}async seal(){let e=await this._si();return null===e?Promise.reject(new Error("object store not found")):(e.config.sealed=!0,e=await this.jsm.streams.update(this.stream,e.config),Promise.resolve(new Os(e)))}async status(e){const t=await this._si(e);return null===t?Promise.reject(new Error("object store not found")):Promise.resolve(new Os(t))}destroy(){return this.jsm.streams.delete(this.stream)}async _put(t,s,r){const i=this.js.getOptions();(r=r||{timeout:i.timeout}).timeout=r.timeout||i.timeout,r.previousRevision=r.previousRevision??void 0;const{timeout:n,previousRevision:o}=r,a=this.js.nc.info,c=a?.max_payload||1024;(t=t||{}).options=t.options||{};let u=t.options?.max_chunk_size||131072;u=u>c?c:u,t.options.max_chunk_size=u;const l=await this.info(t.name),{name:d,error:f}=this._checkNotEmpty(t.name);if(f)return Promise.reject(f);const p=h.next(),m=this._chunkSubject(p),g=this._metaSubject(d),b=Object.assign({bucket:this.name,nuid:p,size:0,chunks:0},qs(t)),y=j(),_=[],w=new N;try{const r=s?s.getReader():null,i=new Gt;for(;;){const{done:s,value:a}=r?await r.read():{done:!0,value:void 0};if(s){if(w.size()>0){const e=w.drain();i.update(e),b.chunks++,b.size+=e.length,_.push(this.js.publish(m,e,{timeout:n}))}await Promise.all(_),_.length=0,b.mtime=(new Date).toISOString();const t=i.digest("base64"),s=t.length%3,r=s>0?"=".repeat(s):"";b.digest=`${js}${t}${r}`,b.deleted=!1;const a=re();"number"==typeof o&&a.set(us.ExpectedLastSubjectSequenceHdr,`${o}`),a.set(e.JsHeaders.RollupHdr,e.JsHeaders.RollupValueSubject);const c=await this.js.publish(g,ae().encode(b),{headers:a,timeout:n});if(b.revision=c.seq,l)try{await this.jsm.streams.purge(this.stream,{filter:`$O.${this.name}.C.${l.nuid}`})}catch(e){}y.resolve(new Ts(b));break}if(a)for(w.fill(a);w.size()>u;){b.chunks++,b.size+=u;const e=w.drain(t.options.max_chunk_size);i.update(e),_.push(this.js.publish(m,e,{timeout:n}))}}}catch(e){await this.jsm.streams.purge(this.stream,{filter:m}),y.reject(e)}return y}putBlob(e,t,s){return null===t&&(t=new Uint8Array(0)),this.put(e,function(e){return new ReadableStream({pull(t){t.enqueue(e),t.close()}})}(t),s)}put(e,t,s){return e?.options?.link?Promise.reject(new Error("link cannot be set when putting the object in bucket")):this._put(e,t,s)}async getBlob(e){const t=await this.get(e);if(null===t)return Promise.resolve(null);const s=await Promise.all([t.error,async function(e){const t=new N,s=e.getReader();for(;;){const{done:e,value:r}=await s.read();if(e)return t.drain();r&&r.length&&t.fill(r)}}(t.data)]);return s[0]?Promise.reject(s[0]):Promise.resolve(s[1])}async get(e){const t=await this.rawInfo(e);if(null===t)return Promise.resolve(null);if(t.deleted)return Promise.resolve(null);if(t.options&&t.options.link){const e=t.options.link.name||"";if(""===e)throw new Error("link is a bucket");return(t.options.link.bucket!==this.name?await Us.create(this.js,t.options.link.bucket):this).get(e)}const s=j(),r={info:new Ts(t),error:s};if(0===t.size)return r.data=new ReadableStream({pull(e){e.enqueue(new Uint8Array(0)),e.close()}}),s.resolve(null),Promise.resolve(r);let i;const n=$t();n.orderedConsumer();const o=new Gt,a=`$O.${this.name}.C.${t.nuid}`,c=await this.js.subscribe(a,n);return(async()=>{for await(const e of c)if(e.data.length>0&&(o.update(e.data),i.enqueue(e.data)),0===e.info.pending){const e=o.digest("base64"),s=e.length%3,r=s>0?"=".repeat(s):"",n=`${js}${e}${r}`;n!==t.digest?i.error(new Error(`received a corrupt object, digests do not match received: ${t.digest} calculated ${n}`)):i.close(),c.unsubscribe()}})().then((()=>{s.resolve()})).catch((e=>{i.error(e),s.reject(e)})),r.data=new ReadableStream({start(e){i=e},cancel(){c.unsubscribe()}}),r}linkStore(e,t){if(!(t instanceof Us))return Promise.reject("bucket required");const s=t,{name:r,error:i}=this._checkNotEmpty(e);if(i)return Promise.reject(i);const n={name:r,options:{link:{bucket:s.name}}};return this._put(n,null)}async link(e,t){const{name:s,error:r}=this._checkNotEmpty(e);if(r)return Promise.reject(r);if(t.deleted)return Promise.reject(new Error("src object is deleted"));if(t.isLink())return Promise.reject(new Error("src object is a link"));const i=await this.rawInfo(e);if(null!==i&&!i.deleted)return Promise.reject(new Error("an object already exists with that name"));const n={bucket:t.bucket,name:t.name},o={name:s,bucket:t.bucket,options:{link:n}};await this.js.publish(this._metaSubject(e),JSON.stringify(o));const a=await this.info(e);return Promise.resolve(a)}async delete(t){const s=await this.rawInfo(t);if(null===s)return Promise.resolve({purged:0,success:!1});s.deleted=!0,s.size=0,s.chunks=0,s.digest="";const r=ae(),i=re();return i.set(e.JsHeaders.RollupHdr,e.JsHeaders.RollupValueSubject),await this.js.publish(this._metaSubject(s.name),r.encode(s),{headers:i}),this.jsm.streams.purge(this.stream,{filter:this._chunkSubject(s.nuid)})}async update(e,t={}){const s=await this.rawInfo(e);if(null===s)return Promise.reject(new Error("object not found"));if(s.deleted)return Promise.reject(new Error("cannot update meta for a deleted object"));t.name=t.name??s.name;const{name:r,error:i}=this._checkNotEmpty(t.name);if(i)return Promise.reject(i);if(e!==t.name){const e=await this.info(t.name);if(e&&!e.deleted)return Promise.reject(new Error("an object already exists with that name"))}t.name=r;const n=Object.assign({},s,qs(t)),o=await this.js.publish(this._metaSubject(n.name),JSON.stringify(n));return e!==t.name&&await this.jsm.streams.purge(this.stream,{filter:this._metaSubject(e)}),Promise.resolve(o)}async watch(e={}){e.includeHistory=e.includeHistory??!1,e.ignoreDeletes=e.ignoreDeletes??!1;let t=!1;const s=new te,r=this._metaSubjectAll();try{await this.jsm.streams.getMessage(this.stream,{last_by_subj:r})}catch(e){"404"===e.code?(s.push(null),t=!0):s.stop(e)}const i=ae(),n=$t();n.orderedConsumer(),e.includeHistory?n.deliverLastPerSubject():(t=!0,n.deliverNew()),n.callback(((r,n)=>{if(r)s.stop(r);else if(null!==n){const r=i.decode(n.data);r.deleted&&!0===e.ignoreDeletes||s.push(r),0!==n.info?.pending||t||(t=!0,s.push(null))}}));const o=await this.js.subscribe(r,n);return s._data=o,s.iterClosed.then((()=>{o.unsubscribe()})),o.closed.then((()=>{s.stop()})).catch((e=>{s.stop(e)})),s}_chunkSubject(e){return`$O.${this.name}.C.${e}`}_metaSubject(e){return`$O.${this.name}.M.${_t.encode(e)}`}_metaSubjectAll(){return`$O.${this.name}.M.>`}async init(t={}){try{this.stream=(xs(s=this.name),`${gs}${s}`)}catch(e){return Promise.reject(e)}var s;const r=t?.ttl||0;delete t.ttl;const i=Object.assign({max_age:r},t);i.name=this.stream,i.allow_direct=!0,i.allow_rollup_hdrs=!0,i.discard=e.DiscardPolicy.New,i.subjects=[`$O.${this.name}.C.>`,`$O.${this.name}.M.>`],t.placement&&(i.placement=t.placement),t.metadata&&(i.metadata=t.metadata),"boolean"==typeof t.compression&&(i.compression=t.compression?e.StoreCompression.S2:e.StoreCompression.None);try{await this.jsm.streams.info(i.name)}catch(e){"stream not found"===e.message&&await this.jsm.streams.add(i)}}static async create(e,t,s={}){const r=await e.jetstreamManager(),i=new Us(t,r,e);return await i.init(s),Promise.resolve(i)}}class Ls{js;jsm;constructor(e){this.js=e}kv(e,t={}){const s=this.js,{ok:r,min:i}=s.nc.features.get(ve.JS_KV);return r?t.bindOnly?As.bind(this.js,e):As.create(this.js,e,t):Promise.reject(new Error(`kv is only supported on servers ${i} or better`))}os(e,t={}){if("function"!=typeof crypto?.subtle?.digest)return Promise.reject(new Error("objectstore: unable to calculate hashes - crypto.subtle.digest with sha256 support is required"));const s=this.js,{ok:r,min:i}=s.nc.features.get(ve.JS_OBJECTSTORE);return r?Us.create(this.js,e,t):Promise.reject(new Error(`objectstore is only supported on servers ${i} or better`))}}class Fs extends bt{consumers;streams;consumerAPI;streamAPI;constructor(e,t){super(e,t),this.consumerAPI=new Wt(e,t),this.streamAPI=new Ms(e,t),this.consumers=new bs(this.consumerAPI),this.streams=new Ns(this.streamAPI)}jetstreamManager(e){const t=Object.assign({checkAPI:e},this.opts);return this.nc.jetstreamManager(t)}get apiPrefix(){return this.prefix}get views(){return new Ls(this)}async publish(s,r=t,i){(i=i||{}).expect=i.expect||{};const n=i?.headers||re();i&&(i.msgID&&n.set(us.MsgIdHdr,i.msgID),i.expect.lastMsgID&&n.set(us.ExpectedLastMsgIdHdr,i.expect.lastMsgID),i.expect.streamName&&n.set(us.ExpectedStreamHdr,i.expect.streamName),"number"==typeof i.expect.lastSequence&&n.set(us.ExpectedLastSeqHdr,`${i.expect.lastSequence}`),"number"==typeof i.expect.lastSubjectSequence&&n.set(us.ExpectedLastSubjectSequenceHdr,`${i.expect.lastSubjectSequence}`));const o=i.timeout||this.timeout,a={};o&&(a.timeout=o),i&&(a.headers=n);let c,{retries:h,retry_delay:u}=i;h=h||1,u=u||250;for(let e=0;e<h;e++)try{c=await this.nc.request(s,r,a);break}catch(t){if(!("503"===t.code&&e+1<h))throw t;await k(u)}const l=this.parseJsResponse(c);if(""===l.stream)throw m.errorForCode(e.ErrorCode.JetStreamInvalidAck);return l.duplicate=!!l.duplicate&&l.duplicate,l}async pull(e,t,s=0){at(e),ot(t);let r=this.timeout;s>r&&(r=s);const i={batch:1,no_wait:0===(s=s<0?0:ut(s)),expires:s},n=await this.nc.request(`${this.prefix}.CONSUMER.MSG.NEXT.${e}.${t}`,this.jc.encode(i),{noMux:!0,timeout:r}),o=pt(n);if(o)throw o;return ss(n)}fetch(t,s,r={}){at(t),ot(s);let i=null;const n=(r.max_bytes??0)>0;let o=0;const a=n?r.max_bytes:0;let c=null;const h={};if(h.batch=r.batch||1,a){const e=this.nc.features.get(ve.JS_PULL_MAX_BYTES);if(!e.ok)throw new Error(`max_bytes is only supported on servers ${e.min} or better`);h.max_bytes=a}h.no_wait=r.no_wait||!1,h.no_wait&&h.expires&&(h.expires=0);const u=r.expires||0;if(u&&(h.expires=ut(u)),0===u&&!1===h.no_wait)throw new Error("expires or no_wait is required");const l=r.idle_heartbeat||0;l&&(h.idle_heartbeat=ut(l),!0===r.delay_heartbeat&&(h.idle_heartbeat=ut(4*l)));const d=new te,f=h.batch;let p=0;d.protocolFilterFn=(e,t=!1)=>!ft(e.msg)||(c?.work(),!1),d.dispatchedFn=e=>{if(e){if(n&&(o+=e.data.length),p++,i&&0===e.info.pending)return;(1===d.getPending()&&0===e.info.pending||f===p||a>0&&o>=a)&&d.stop()}};const g=S(this.nc.options.inboxPrefix),b=this.nc.subscribe(g,{max:r.batch,callback:(e,t)=>{null===e&&(e=pt(t)),null!==e?(i&&(i.cancel(),i=null),!function(e){return"string"==typeof e.code}(e)?d.stop(e):d.stop(null===Ks(e)?void 0:e)):(c?.work(),d.received++,d.push(ss(t)))}});return u&&(i=A(u),i.catch((()=>{b.isClosed()||(b.drain().catch((()=>{})),i=null),c&&c.cancel()}))),(async()=>{try{l&&(c=new os(l,(t=>(d.push((()=>{d.err=new m(`${mt.IdleHeartbeatMissed}: ${t}`,e.ErrorCode.JetStreamIdleHeartBeat)})),!0))))}catch(e){}await b.closed,null!==i&&(i.cancel(),i=null),c&&c.cancel(),d.stop()})().catch(),this.nc.publish(`${this.prefix}.CONSUMER.MSG.NEXT.${t}.${s}`,this.jc.encode(h),{reply:g}),d}async pullSubscribe(t,s=$t()){const r=await this._processOptions(t,s);if(r.ordered)throw new Error("pull subscribers cannot be be ordered");if(r.config.deliver_subject)throw new Error("consumer info specifies deliver_subject - pull consumers cannot have deliver_subject set");const i=r.config.ack_policy;if(i===e.AckPolicy.None||i===e.AckPolicy.All)throw new Error("ack policy for pull consumers must be explicit");const n=this._buildTypedSubscriptionOpts(r),o=new Bs(this,r.deliver,n);o.info=r;try{await this._maybeCreateConsumer(r)}catch(e){throw o.unsubscribe(),e}return o}async subscribe(e,t=$t()){const s=await this._processOptions(e,t);if(!s.isBind&&!s.config.deliver_subject)throw new Error("push consumer requires deliver_subject");const r=this._buildTypedSubscriptionOpts(s),i=new Ds(this,s.deliver,r);i.info=s;try{await this._maybeCreateConsumer(s)}catch(e){throw i.unsubscribe(),e}return i._maybeSetupHbMonitoring(),i}async _processOptions(t,s=$t()){const r=Tt(s)?s.getOpts():s;if(r.isBind=!!Tt(s)&&s.isBind,r.flow_control={heartbeat_count:0,fc_count:0,consumer_restarts:0},r.ordered){if(r.ordered_consumer_sequence={stream_seq:0,delivery_seq:0},r.config.ack_policy!==e.AckPolicy.NotSet&&r.config.ack_policy!==e.AckPolicy.None)throw new m("ordered consumer: ack_policy can only be set to 'none'",e.ErrorCode.ApiError);if(r.config.durable_name&&r.config.durable_name.length>0)throw new m("ordered consumer: durable_name cannot be set",e.ErrorCode.ApiError);if(r.config.deliver_subject&&r.config.deliver_subject.length>0)throw new m("ordered consumer: deliver_subject cannot be set",e.ErrorCode.ApiError);if(void 0!==r.config.max_deliver&&r.config.max_deliver>1)throw new m("ordered consumer: max_deliver cannot be set",e.ErrorCode.ApiError);if(r.config.deliver_group&&r.config.deliver_group.length>0)throw new m("ordered consumer: deliver_group cannot be set",e.ErrorCode.ApiError);r.config.deliver_subject=S(this.nc.options.inboxPrefix),r.config.ack_policy=e.AckPolicy.None,r.config.max_deliver=1,r.config.flow_control=!0,r.config.idle_heartbeat=r.config.idle_heartbeat||ut(5e3),r.config.ack_wait=ut(792e5),r.config.mem_storage=!0,r.config.num_replicas=1}if(r.config.ack_policy===e.AckPolicy.NotSet&&(r.config.ack_policy=e.AckPolicy.All),r.api=this,r.config=r.config||{},r.stream=r.stream?r.stream:await this.findStream(t),r.attached=!1,r.config.durable_name)try{const e=await this.consumerAPI.info(r.stream,r.config.durable_name);if(e){if(e.config.filter_subject&&e.config.filter_subject!==t)throw new Error("subject does not match consumer");const s=r.config.deliver_group??"";if(""===s&&!0===e.push_bound)throw new Error("duplicate subscription");const i=e.config.deliver_group??"";if(s!==i)throw""===i?new Error("durable requires no queue group"):new Error(`durable requires queue group '${i}'`);r.last=e,r.config=e.config,r.attached=!0,r.config.durable_name||(r.name=e.name)}}catch(e){if("404"!==e.code)throw e}return r.attached||void 0!==r.config.filter_subject||void 0!==r.config.filter_subjects||(r.config.filter_subject=t),r.deliver=r.config.deliver_subject||S(this.nc.options.inboxPrefix),r}_buildTypedSubscriptionOpts(t){const s={};return s.adapter=void 0===t.callbackFn?Js:Hs,s.ingestionFilterFn=Fs.ingestionFn(t.ordered),s.protocolFilterFn=(e,t=!1)=>{const s=e;return!dt(s.msg)||(t||s.msg.respond(),!1)},t.mack||t.config.ack_policy===e.AckPolicy.None||(s.dispatchedFn=zs),t.callbackFn&&(s.callback=t.callbackFn),s.max=t.max||0,s.queue=t.queue,s}async _maybeCreateConsumer(t){if(t.attached)return;if(t.isBind)throw new Error(`unable to bind - durable consumer ${t.config.durable_name} doesn't exist in ${t.stream}`);t.config=Object.assign({deliver_policy:e.DeliverPolicy.All,ack_policy:e.AckPolicy.Explicit,ack_wait:ut(3e4),replay_policy:e.ReplayPolicy.Instant},t.config);const s=await this.consumerAPI.add(t.stream,t.config);if(Array.isArray(t.config.filter_subjects&&!Array.isArray(s.config.filter_subjects)))throw new Error("jetstream server doesn't support consumers with multiple filter subjects");t.name=s.name,t.config=s.config,t.last=s}static ingestionFn(e){return(t,s)=>{const r=s;if(!t)return{ingest:!1,protocol:!1};const i=t;if(pt(i.msg)||r.monitor?.work(),ft(i.msg)){const t=!e||r._checkHbOrderConsumer(i.msg);return e||r.info.flow_control.heartbeat_count++,{ingest:t,protocol:!0}}if(dt(i.msg))return r.info.flow_control.fc_count++,{ingest:!0,protocol:!0};return{ingest:!e||r._checkOrderedConsumer(t),protocol:!1}}}}class Ds extends ns{js;monitor;constructor(e,t,s){super(e.nc,t,s),this.js=e,this.monitor=null,this.sub.closed.then((()=>{this.monitor&&this.monitor.cancel()}))}set info(e){this.sub.info=e}get info(){return this.sub.info}_resetOrderedConsumer(t){if(null===this.info||this.sub.isClosed())return;const s=S(this.js.nc.options.inboxPrefix);this.js.nc._resub(this.sub,s);const r=this.info;r.ordered_consumer_sequence.delivery_seq=0,r.flow_control.heartbeat_count=0,r.flow_control.fc_count=0,r.flow_control.consumer_restarts++,r.deliver=s,r.config.deliver_subject=s,r.config.deliver_policy=e.DeliverPolicy.StartSequence,r.config.opt_start_seq=t;const i={};i.stream_name=this.info.stream,i.config=r.config;const n=`${r.api.prefix}.CONSUMER.CREATE.${r.stream}`;this.js._request(n,i).then((e=>{const t=e;this.info.config=t.config,this.info.name=t.name})).catch((s=>{const i=new m(`unable to recreate ordered consumer ${r.stream} at seq ${t}`,e.ErrorCode.RequestError,s);this.sub.callback(i,{})}))}_maybeSetupHbMonitoring(){const e=this.info?.config?.idle_heartbeat||0;e&&this._setupHbMonitoring(lt(e))}_setupHbMonitoring(e,s=0){const r={cancelAfter:0,maxOut:2};s&&(r.cancelAfter=s);const i=this.sub;this.monitor=new os(e,(e=>{const s=function(e,s,r){const i=re(e,s),n=new he({hdr:1,sid:0,size:0},t,{});return n._headers=i,n._subject=r,n}(409,`${mt.IdleHeartbeatMissed}: ${e}`,this.sub.subject),r=this.info?.ordered;if(r){if(!this.js.nc.protocol.connected)return!1;const e=this.info?.ordered_consumer_sequence?.stream_seq||0;return this._resetOrderedConsumer(e+1),!1}return this.sub.callback(null,s),!i.noIterator}),r)}_checkHbOrderConsumer(t){const s=t.headers.get(e.JsHeaders.ConsumerStalledHdr);if(""!==s){this.js.nc.publish(s)}const r=parseInt(t.headers.get(e.JsHeaders.LastConsumerSeqHdr),10),i=this.info.ordered_consumer_sequence;return this.info.flow_control.heartbeat_count++,r!==i.delivery_seq&&this._resetOrderedConsumer(i.stream_seq+1),!1}_checkOrderedConsumer(e){const t=this.info.ordered_consumer_sequence,s=e.info.streamSequence,r=e.info.deliverySequence;return r!=t.delivery_seq+1?(this._resetOrderedConsumer(t.stream_seq+1),!1):(t.delivery_seq=r,t.stream_seq=s,!0)}async destroy(){this.isClosed()||await this.drain();const e=this.sub.info,t=e.config.durable_name||e.name,s=`${e.api.prefix}.CONSUMER.DELETE.${e.stream}.${t}`;await e.api._request(s)}async consumerInfo(){const e=this.sub.info,t=e.config.durable_name||e.name,s=`${e.api.prefix}.CONSUMER.INFO.${e.stream}.${t}`,r=await e.api._request(s);return e.last=r,r}}class Bs extends Ds{constructor(e,t,s){super(e,t,s)}pull(e={batch:1}){const{stream:t,config:s,name:r}=this.sub.info,i=s.durable_name??r,n={};if(n.batch=e.batch||1,n.no_wait=e.no_wait||!1,(e.max_bytes??0)>0){const t=this.js.nc.features.get(ve.JS_PULL_MAX_BYTES);if(!t.ok)throw new Error(`max_bytes is only supported on servers ${t.min} or better`);n.max_bytes=e.max_bytes}let o=0;e.expires&&e.expires>0&&(o=e.expires,n.expires=ut(o));let a=0;if(e.idle_heartbeat&&e.idle_heartbeat>0&&(a=e.idle_heartbeat,n.idle_heartbeat=ut(a)),a&&0===o)throw new Error("idle_heartbeat requires expires");if(a>o)throw new Error("expires must be greater than idle_heartbeat");if(this.info){this.monitor&&this.monitor.cancel(),o&&a&&(this.monitor?this.monitor._change(a,o):this._setupHbMonitoring(a,o));const e=this.info.api,s=`${e.prefix}.CONSUMER.MSG.NEXT.${t}.${i}`,r=this.sub.subject;e.nc.publish(s,e.jc.encode(n),{reply:r})}}}function Hs(e,t){return e||(e=pt(t))?[e,null]:[null,ss(t)]}function Js(e,t){if(e)return[e,null];const s=pt(t);return null!==s?[Ks(s),null]:[null,ss(t)]}function Ks(t){if(null!==t)switch(t.code){case e.ErrorCode.JetStream404NoMessages:case e.ErrorCode.JetStream408RequestTimeout:return null;case e.ErrorCode.JetStream409:return(s=t).code===e.ErrorCode.JetStream409&&void 0!==[mt.MaxBatchExceeded,mt.MaxExpiresExceeded,mt.MaxBytesExceeded,mt.MaxMessageSizeExceeded,mt.PushConsumer,mt.IdleHeartbeatMissed,mt.ConsumerDeleted].find((e=>-1!==s.message.indexOf(e)))?t:null;default:return t}var s;return null}function zs(e){e&&e.ack()}class Gs extends bt{constructor(e,t){super(e,t)}async getMessage(e,s){at(e);let r=s;const{last_by_subj:i}=r;i&&(r=null);const n=r?this.jc.encode(r):t,o=this.opts.apiPrefix||"$JS.API",a=i?`${o}.DIRECT.GET.${e}.${i}`:`${o}.DIRECT.GET.${e}`,c=await this.nc.request(a,n),h=pt(c);if(h)return Promise.reject(h);const u=new Vs(c);return Promise.resolve(u)}}class Vs{data;header;static jc;constructor(e){if(!e.headers)throw new Error("headers expected");this.data=e.data,this.header=e.headers}get subject(){return this.header.last(e.DirectMsgHeaders.Subject)}get seq(){const t=this.header.last(e.DirectMsgHeaders.Sequence);return"string"==typeof t?parseInt(t):0}get time(){return new Date(Date.parse(this.timestamp))}get timestamp(){return this.header.last(e.DirectMsgHeaders.TimeStamp)}get stream(){return this.header.last(e.DirectMsgHeaders.Stream)}json(e){return ae(e).decode(this.data)}string(){return r.decode(this.data)}}class Ws extends bt{streams;consumers;direct;constructor(e,t){super(e,t),this.streams=new Ms(e,t),this.consumers=new Wt(e,t),this.direct=new Gs(e,t)}async getAccountInfo(){return await this._request(`${this.prefix}.INFO`)}jetstream(){return this.nc.jetstream(this.getOptions())}advisories(){const e=new te;return this.nc.subscribe("$JS.EVENT.ADVISORY.>",{callback:(t,s)=>{if(t)throw t;try{const t=this.parseJsResponse(s),r=t.type.split("."),i=r[r.length-1];e.push({kind:i,data:t})}catch(t){e.stop(t)}}}),e}}class Ys{msg;constructor(e){this.msg=e}get data(){return this.msg.data}get sid(){return this.msg.sid}get subject(){return this.msg.subject}get reply(){return this.msg.reply||""}get headers(){return this.msg.headers}respond(e,t){return this.msg.respond(e,t)}respondError(e,t,s,r){return(r=r||{}).headers=r.headers||re(),r.headers?.set(w,`${e}`),r.headers?.set(_,t),this.msg.respond(s,r)}json(e){return this.msg.json(e)}string(){return this.msg.string()}}class Xs{subject;queue;srv;constructor(e,t="",s=""){""!==t&&function(e,t){if(-1!==t.indexOf(" "))throw new Error(`${e} cannot contain spaces: '${t}'`);t.split(".").forEach((s=>{if(">"===s)throw new Error(`${e} name cannot contain internal '>': '${t}'`)}))}("service group",t);let r="";if(e instanceof Qs)this.srv=e,r="";else{if(!(e instanceof Xs))throw new Error("unknown ServiceGroup type");{const t=e;this.srv=t.srv,""===s&&""!==t.queue&&(s=t.queue),r=t.subject}}this.subject=this.calcSubject(r,t),this.queue=s}calcSubject(e,t=""){return""===t?e:""!==e?`${e}.${t}`:t}addEndpoint(e="",t){const s="function"==typeof(t=t||{subject:e})?{handler:t,subject:e}:t;ht("endpoint",e);let{subject:r,handler:i,metadata:n,queue:o}=s;r=r||e,o=o||this.queue,function(e,t){if(""===t)throw new Error(`${e} cannot be empty`);if(-1!==t.indexOf(" "))throw new Error(`${e} cannot contain spaces: '${t}'`);const s=t.split(".");s.forEach(((r,i)=>{if(">"===r&&i!==s.length-1)throw new Error(`${e} cannot have internal '>': '${t}'`)}))}("endpoint subject",r),r=this.calcSubject(this.subject,r);const a={name:e,subject:r,queue:o,handler:i,metadata:n};return this.srv._addEndpoint(a)}addGroup(e="",t=""){return new Xs(this,e,t)}}class Qs{nc;_id;config;handlers;internal;_stopped;_done;started;static controlSubject(e,t="",s="",r){const i=r??"$SRV";return""===t&&""===s?`${i}.${e}`:(ht("control subject name",t),""!==s?(ht("control subject id",s),`${i}.${e}.${t}.${s}`):`${i}.${e}.${t}`)}constructor(e,t={name:"",version:""}){this.nc=e,this.config=Object.assign({},t),this.config.queue||(this.config.queue="q"),ht("name",this.config.name),ht("queue",this.config.queue),Se(this.config.version),this._id=h.next(),this.internal=[],this._done=j(),this._stopped=!1,this.handlers=[],this.started=(new Date).toISOString(),this.reset(),this.nc.closed().then((()=>{this.close().catch()})).catch((e=>{this.close(e).catch()}))}get subjects(){return this.handlers.filter((e=>!1===e.internal)).map((e=>e.subject))}get id(){return this._id}get name(){return this.config.name}get description(){return this.config.description??""}get version(){return this.config.version}get metadata(){return this.config.metadata}errorToHeader(e){const t=re();if(e instanceof v){const s=e;t.set(_,s.message),t.set(w,`${s.code}`)}else t.set(_,e.message),t.set(w,"500");return t}setupHandler(e,s=!1){const r=s?"":e.queue?e.queue:this.config.queue,{name:i,subject:n,handler:o}=e,a=e;a.internal=s,s&&this.internal.push(a),a.stats=new Zs(i,n,r),a.queue=r;const c=o?(e,s)=>{if(e)return void this.close(e);const r=Date.now();try{o(e,new Ys(s))}catch(e){a.stats.countError(e),s?.respond(t,{headers:this.errorToHeader(e)})}finally{a.stats.countLatency(r)}}:void 0;return a.sub=this.nc.subscribe(n,{callback:c,queue:r}),a.sub.closed.then((()=>{this._stopped||this.close(new Error(`required subscription ${e.subject} stopped`)).catch()})).catch((t=>{if(!this._stopped){const s=new Error(`required subscription ${e.subject} errored: ${t.message}`);s.stack=t.stack,this.close(s).catch()}})),a}info(){return{type:e.ServiceResponseType.INFO,name:this.name,id:this.id,version:this.version,description:this.description,metadata:this.metadata,endpoints:this.endpoints()}}endpoints(){return this.handlers.map((e=>{const{subject:t,metadata:s,name:r,queue:i}=e;return{subject:t,metadata:s,name:r,queue_group:i}}))}async stats(){const t=[];for(const e of this.handlers){if("function"==typeof this.config.statsHandler)try{e.stats.data=await this.config.statsHandler(e)}catch(t){e.stats.countError(t)}t.push(e.stats.stats(e.qi))}return{type:e.ServiceResponseType.STATS,name:this.name,id:this.id,version:this.version,started:this.started,metadata:this.metadata,endpoints:t}}addInternalHandler(e,t){const s=`${e}`.toUpperCase();this._doAddInternalHandler(`${s}-all`,e,t),this._doAddInternalHandler(`${s}-kind`,e,t,this.name),this._doAddInternalHandler(`${s}`,e,t,this.name,this.id)}_doAddInternalHandler(e,t,s,r="",i=""){const n={};n.name=e,n.subject=Qs.controlSubject(t,r,i),n.handler=s,this.setupHandler(n,!0)}start(){const t=ae(),s=t.encode(this.ping());return this.addInternalHandler(e.ServiceVerb.PING,((e,t)=>e?(this.close(e).then().catch(),Promise.reject(e)):(t.respond(s),Promise.resolve()))),this.addInternalHandler(e.ServiceVerb.STATS,((e,s)=>e?(this.close(e),Promise.reject(e)):this.stats().then((e=>(s?.respond(t.encode(e)),Promise.resolve()))))),this.addInternalHandler(e.ServiceVerb.INFO,((e,s)=>e?(this.close(e),Promise.reject(e)):(s?.respond(t.encode(this.info())),Promise.resolve()))),this.handlers.forEach((e=>{const{subject:t}=e;"string"==typeof t&&null!==e.handler&&this.setupHandler(e)})),Promise.resolve(this)}close(e){if(this._stopped)return this._done;this._stopped=!0;let t=[];return this.nc.isClosed()||(t=this.handlers.concat(this.internal).map((e=>e.sub.drain()))),Promise.allSettled(t).then((()=>{this._done.resolve(e||null)})),this._done}get stopped(){return this._done}get isStopped(){return this._stopped}stop(e){return this.close(e)}ping(){return{type:e.ServiceResponseType.PING,name:this.name,id:this.id,version:this.version,metadata:this.metadata}}reset(){if(this.started=(new Date).toISOString(),this.handlers)for(const e of this.handlers)e.stats.reset(e.qi)}addGroup(e,t){return new Xs(this,e,t)}addEndpoint(e,t){return new Xs(this).addEndpoint(e,t)}_addEndpoint(e){const t=new te;t.noIterator="function"==typeof e.handler,t.noIterator||(e.handler=(e,s)=>{e?this.stop(e).catch():t.push(new Ys(s))},t.iterClosed.then((()=>{this.close().catch()})));const s=this.setupHandler(e,!1);return s.qi=t,this.handlers.push(s),t}}class Zs{name;subject;average_processing_time;num_requests;processing_time;num_errors;last_error;data;metadata;queue;constructor(e,t,s=""){this.name=e,this.subject=t,this.average_processing_time=0,this.num_errors=0,this.num_requests=0,this.processing_time=0,this.queue=s}reset(e){this.num_requests=0,this.processing_time=0,this.average_processing_time=0,this.num_errors=0,this.last_error=void 0,this.data=void 0;const t=e;t&&(t.time=0,t.processed=0)}countLatency(e){this.num_requests++,this.processing_time+=ut(Date.now()-e),this.average_processing_time=Math.round(this.processing_time/this.num_requests)}countError(e){this.num_errors++,this.last_error=e.message}_stats(){const{name:e,subject:t,average_processing_time:s,num_errors:r,num_requests:i,processing_time:n,last_error:o,data:a,queue:c}=this;return{name:e,subject:t,average_processing_time:s,num_errors:r,num_requests:i,processing_time:n,last_error:o,data:a,queue_group:c}}stats(e){const t=e;return!1===t?.noIterator&&(this.processing_time=t.time,this.num_requests=t.processed,this.average_processing_time=this.processing_time>0&&this.num_requests>0?this.processing_time/this.num_requests:0),this._stats()}}class er{nc;prefix;opts;constructor(t,s={strategy:e.RequestStrategy.JitterTimer,maxWait:2e3},r){this.nc=t,this.prefix=r,this.opts=s}ping(t="",s=""){return this.q(e.ServiceVerb.PING,t,s)}stats(t="",s=""){return this.q(e.ServiceVerb.STATS,t,s)}info(t="",s=""){return this.q(e.ServiceVerb.INFO,t,s)}async q(e,s="",r=""){const i=new te,n=ae(),o=Qs.controlSubject(e,s,r,this.prefix),a=await this.nc.requestMany(o,t,this.opts);return(async()=>{for await(const e of a)try{const t=n.decode(e.data);i.push(t)}catch(e){i.push((()=>{i.stop(e)}))}i.push((()=>{i.stop()}))})().catch((e=>{i.stop(e)})),i}}class tr{options;protocol;draining;listeners;_services;constructor(e){this.draining=!1,this.options=We(e),this.listeners=[]}static connect(e={}){return new Promise(((t,s)=>{const r=new tr(e);st.connect(r.options,r).then((e=>{r.protocol=e,async function(){for await(const t of e.status())r.listeners.forEach((e=>{e.push(t)}))}(),t(r)})).catch((e=>{s(e)}))}))}closed(){return this.protocol.closed}async close(){await this.protocol.close()}_check(t,s,r){if(this.isClosed())throw m.errorForCode(e.ErrorCode.ConnectionClosed);if(s&&this.isDraining())throw m.errorForCode(e.ErrorCode.ConnectionDraining);if(r&&this.protocol.noMorePublishing)throw m.errorForCode(e.ErrorCode.ConnectionDraining);if(0===(t=t||"").length)throw m.errorForCode(e.ErrorCode.BadSubject)}publish(e,t,s){this._check(e,!1,!0),this.protocol.publish(e,t,s)}subscribe(e,t={}){this._check(e,!0,!1);const s=new et(this.protocol,e,t);return this.protocol.subscribe(s),s}_resub(e,t,s){this._check(t,!0,!1);const r=e;r.max=s,s&&(r.max=s+r.received),this.protocol.resub(r,t)}requestMany(s,r=t,i={maxWait:1e3,maxMessages:-1}){const n=!this.protocol.options.noAsyncTraces;try{this._check(s,!0,!0)}catch(e){return Promise.reject(e)}if(i.strategy=i.strategy||e.RequestStrategy.Timer,i.maxWait=i.maxWait||1e3,i.maxWait<1)return Promise.reject(new m("timeout",e.ErrorCode.InvalidOption));const o=new te;function a(e){o.push((()=>{o.stop(e)}))}function c(e,t){e||null===t?a(null===e?void 0:e):o.push(t)}if(i.noMux){const t=n?(new Error).stack:null;let h="number"==typeof i.maxMessages&&i.maxMessages>0?i.maxMessages:-1;const u=this.subscribe(S(this.options.inboxPrefix),{callback:(s,r)=>{if(0===r?.data?.length&&r?.headers?.status===e.ErrorCode.NoResponders&&(s=m.errorForCode(e.ErrorCode.NoResponders)),s)return t&&(s.stack+=`\n\n${t}`),void l(s);c(null,r),i.strategy===e.RequestStrategy.Count&&(h--,0===h&&l()),i.strategy===e.RequestStrategy.JitterTimer&&(f(),d=setTimeout((()=>{l()}),300)),i.strategy===e.RequestStrategy.SentinelMsg&&r&&0===r.data.length&&l()}});u.closed.then((()=>{a()})).catch((e=>{o.stop(e)}));const l=e=>{e&&o.push((()=>{throw e})),f(),u.drain().then((()=>{a()})).catch((e=>{a()}))};o.iterClosed.then((()=>{f(),u?.unsubscribe()})).catch((e=>{f(),u?.unsubscribe()}));try{this.publish(s,r,{reply:u.getSubject()})}catch(e){l(e)}let d=setTimeout((()=>{l()}),i.maxWait);const f=()=>{d&&clearTimeout(d)}}else{const e=i;e.callback=c,o.iterClosed.then((()=>{t.cancel()})).catch((e=>{t.cancel(e)}));const t=new it(this.protocol.muxSubscriptions,s,e);this.protocol.request(t);try{this.publish(s,r,{reply:`${this.protocol.muxSubscriptions.baseInbox}${t.token}`,headers:i.headers})}catch(e){t.cancel(e)}}return Promise.resolve(o)}request(t,s,r={timeout:1e3,noMux:!1}){try{this._check(t,!0,!0)}catch(e){return Promise.reject(e)}const i=!this.protocol.options.noAsyncTraces;if(r.timeout=r.timeout||1e3,r.timeout<1)return Promise.reject(new m("timeout",e.ErrorCode.InvalidOption));if(!r.noMux&&r.reply)return Promise.reject(new m("reply can only be used with noMux",e.ErrorCode.InvalidOption));if(r.noMux){const n=r.reply?r.reply:S(this.options.inboxPrefix),o=j(),a=i?new Error:null;return this.subscribe(n,{max:1,timeout:r.timeout,callback:(t,s)=>{t?(a&&t.code!==e.ErrorCode.Timeout&&(t.stack+=`\n\n${a.stack}`),o.reject(t)):(t=ce(s))?(a&&(t.stack+=`\n\n${a.stack}`),o.reject(t)):o.resolve(s)}}).requestSubject=t,this.protocol.publish(t,s,{reply:n,headers:r.headers}),o}{const e=new nt(this.protocol.muxSubscriptions,t,r,i);this.protocol.request(e);try{this.publish(t,s,{reply:`${this.protocol.muxSubscriptions.baseInbox}${e.token}`,headers:r.headers})}catch(t){e.cancel(t)}const n=Promise.race([e.timer,e.deferred]);return n.catch((()=>{e.cancel()})),n}}flush(){return this.isClosed()?Promise.reject(m.errorForCode(e.ErrorCode.ConnectionClosed)):this.protocol.flush()}drain(){return this.isClosed()?Promise.reject(m.errorForCode(e.ErrorCode.ConnectionClosed)):this.isDraining()?Promise.reject(m.errorForCode(e.ErrorCode.ConnectionDraining)):(this.draining=!0,this.protocol.drain())}isClosed(){return this.protocol.isClosed()}isDraining(){return this.draining}getServer(){const e=this.protocol.getServer();return e?e.listen:""}status(){const e=new te;return e.iterClosed.then((()=>{const t=this.listeners.indexOf(e);this.listeners.splice(t,1)})),this.listeners.push(e),e}get info(){return this.protocol.isClosed()?void 0:this.protocol.info}stats(){return{inBytes:this.protocol.inBytes,outBytes:this.protocol.outBytes,inMsgs:this.protocol.inMsgs,outMsgs:this.protocol.outMsgs}}async jetstreamManager(t={}){const s=new Ws(this,t);if(!1!==t.checkAPI)try{await s.getAccountInfo()}catch(t){const s=t;throw s.code===e.ErrorCode.NoResponders&&(s.code=e.ErrorCode.JetStreamNotEnabled),s}return s}jetstream(e={}){return new Fs(this,e)}getServerVersion(){const e=this.info;return e?Se(e.version):void 0}async rtt(){if(!this.protocol._closed&&!this.protocol.connected)throw m.errorForCode(e.ErrorCode.Disconnect);const t=Date.now();return await this.flush(),Date.now()-t}get features(){return this.protocol.features}get services(){return this._services||(this._services=new sr(this)),this._services}reconnect(){return this.isClosed()?Promise.reject(m.errorForCode(e.ErrorCode.ConnectionClosed)):this.isDraining()?Promise.reject(m.errorForCode(e.ErrorCode.ConnectionDraining)):this.protocol.reconnect()}}class sr{nc;constructor(e){this.nc=e}add(e){try{return new Qs(this.nc,e).start()}catch(e){return Promise.reject(e)}}client(e,t){return new er(this.nc,e,t)}}class rr{name;duration;date;payload;msgs;lang;version;bytes;asyncRequests;min;max;constructor(e,t){this.name=e,this.duration=t,this.date=Date.now(),this.payload=0,this.msgs=0,this.bytes=0}toString(){const e=this.duration/1e3,t=Math.round(this.msgs/e),s=this.asyncRequests?"asyncRequests":"";let r="";return this.max&&(r=`${this.min}/${this.max}`),`${this.name}${s?" [asyncRequests]":""} ${o=t,o.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")} msgs/sec - [${e.toFixed(2)} secs] ~ ${i=this.bytes,n=e,`${function(e,t=!1){const s=t?1e3:1024,r=t?["k","M","G","T","P","E"]:["K","M","G","T","P","E"],i=t?"iB":"B";if(e<s)return`${e.toFixed(2)} ${i}`;const n=parseInt(Math.log(e)/Math.log(s)+""),o=parseInt(n-1+"");return`${(e/Math.pow(s,n)).toFixed(2)} ${r[o]}${i}`}(i/n)}/sec`} ${r}`;var i,n,o}toCsv(){return`"${this.name}",${new Date(this.date).toISOString()},${this.lang},${this.version},${this.msgs},${this.payload},${this.bytes},${this.duration},${!!this.asyncRequests&&this.asyncRequests}\n`}static header(){return"Test,Date,Lang,Version,Count,MsgPayload,Bytes,Millis,Async\n"}}class ir{version;lang;closeError;connected;done;socket;options;socketClosed;encrypted;peeked;yields;signal;closedNotification;constructor(){this.version="1.19.1",this.lang="nats.ws",this.connected=!1,this.done=!1,this.socketClosed=!1,this.encrypted=!1,this.peeked=!1,this.yields=[],this.signal=j(),this.closedNotification=j()}async connect(t,s){const r=j();if(s.tls)return r.reject(new m("tls",e.ErrorCode.InvalidOption)),r;this.options=s;const i=t.src;if(s.wsFactory){const{socket:e,encrypted:r}=await s.wsFactory(t.src,s);this.socket=e,this.encrypted=r}else this.encrypted=0===i.indexOf("wss://"),this.socket=new WebSocket(i);return this.socket.binaryType="arraybuffer",this.socket.onopen=()=>{this.isDiscarded()},this.socket.onmessage=t=>{if(this.isDiscarded())return;if(this.yields.push(new Uint8Array(t.data)),this.peeked)return void this.signal.resolve();const i=N.concat(...this.yields),n=B(i);if(""!==n){const t=Ye.exec(n);if(!t)return s.debug&&console.error("!!!",x(i)),void r.reject(new Error("unexpected response from server"));try{!function(t,s){const{proto:r,tls_required:i,tls_available:n}=t;if((void 0===r||r<1)&&s.noEcho)throw new m("noEcho",e.ErrorCode.ServerOptionNotAvailable);const o=i||n||!1;if(s.tls&&!o)throw new m("tls",e.ErrorCode.ServerOptionNotAvailable)}(JSON.parse(t[1]),this.options),this.peeked=!0,this.connected=!0,this.signal.resolve(),r.resolve()}catch(e){return void r.reject(e)}}},this.socket.onclose=e=>{if(this.isDiscarded())return;let t;this.socketClosed=!0,this.done||(e.wasClean||(t=new Error(e.reason)),this._closed(t))},this.socket.onerror=t=>{if(this.isDiscarded())return;const s=t,i=new m(s.message,e.ErrorCode.Unknown,new Error(s.error));r.reject(i)},r}disconnect(){this._closed(void 0,!0)}async _closed(e,t=!0){if(!this.isDiscarded()&&this.connected&&!this.done){if(this.closeError=e,!e)for(;!this.socketClosed&&this.socket.bufferedAmount>0;)await k(100);this.done=!0;try{this.socket.close(e?1002:1e3,e?e.message:void 0)}catch(e){}t&&this.closedNotification.resolve(e)}}get isClosed(){return this.done}[Symbol.asyncIterator](){return this.iterate()}async*iterate(){for(;;){if(this.isDiscarded())return;0===this.yields.length&&await this.signal;const e=this.yields;this.yields=[];for(let t=0;t<e.length;t++)this.options.debug&&console.info(`> ${x(e[t])}`),yield e[t];if(this.done)break;0===this.yields.length&&(e.length=0,this.yields=e,this.signal=j())}}isEncrypted(){return this.connected&&this.encrypted}send(e){if(!this.isDiscarded())try{return this.socket.send(e.buffer),void(this.options.debug&&console.info(`< ${x(e)}`))}catch(t){this.options.debug&&console.error(`!!! ${x(e)}: ${t}`)}}close(e){return this._closed(e,!1)}closed(){return this.closedNotification}isDiscarded(){return!!this.done&&(this.discard(),!0)}discard(){this.done=!0;try{this.socket?.close()}catch(e){}}}function nr(e){/^(.*:\/\/)(.*)/.test(e)||(e=`https://${e}`);let t=new URL(e);const s=t.protocol.toLowerCase();let r,i;"https:"!==s&&"http"!==s&&(e=e.replace(/^(.*:\/\/)(.*)/gm,"$2"),t=new URL(`http://${e}`));const n=t.hostname,o=t.pathname,a=t.search||"";switch(s){case"http:":case"ws:":case"nats:":i=t.port||"80",r="ws:";break;default:i=t.port||"443",r="wss:"}return`${r}//${n}:${i}${o}${a}`}e.Bench=class{nc;callbacks;msgs;size;subject;asyncRequests;pub;sub;req;rep;perf;payload;constructor(e,s={msgs:1e5,size:128,subject:"",asyncRequests:!1,pub:!1,sub:!1,req:!1,rep:!1}){if(this.nc=e,this.callbacks=s.callbacks||!1,this.msgs=s.msgs||0,this.size=s.size||0,this.subject=s.subject||h.next(),this.asyncRequests=s.asyncRequests||!1,this.pub=s.pub||!1,this.sub=s.sub||!1,this.req=s.req||!1,this.rep=s.rep||!1,this.perf=new M,this.payload=this.size?new Uint8Array(this.size):t,!(this.pub||this.sub||this.req||this.rep))throw new Error("no bench option selected")}async run(){return this.nc.closed().then((t=>{if(t)throw new m(`bench closed with an error: ${t.message}`,e.ErrorCode.Unknown,t)})),this.callbacks?await this.runCallbacks():await this.runAsync(),this.processMetrics()}processMetrics(){const e=this.nc,{lang:t,version:s}=e.protocol.transport;this.pub&&this.sub&&this.perf.measure("pubsub","pubStart","subStop"),this.req&&this.rep&&this.perf.measure("reqrep","reqStart","reqStop");const r=this.perf.getEntries(),i=r.find((e=>"pubsub"===e.name)),n=r.find((e=>"reqrep"===e.name)),o=r.find((e=>"req"===e.name)),a=r.find((e=>"rep"===e.name)),c=r.find((e=>"pub"===e.name)),h=r.find((e=>"sub"===e.name)),u=this.nc.stats(),l=[];if(i){const{name:e,duration:r}=i,n=new rr(e,r);n.msgs=2*this.msgs,n.bytes=u.inBytes+u.outBytes,n.lang=t,n.version=s,n.payload=this.payload.length,l.push(n)}if(n){const{name:e,duration:r}=n,i=new rr(e,r);i.msgs=2*this.msgs,i.bytes=u.inBytes+u.outBytes,i.lang=t,i.version=s,i.payload=this.payload.length,l.push(i)}if(c){const{name:e,duration:r}=c,i=new rr(e,r);i.msgs=this.msgs,i.bytes=u.outBytes,i.lang=t,i.version=s,i.payload=this.payload.length,l.push(i)}if(h){const{name:e,duration:r}=h,i=new rr(e,r);i.msgs=this.msgs,i.bytes=u.inBytes,i.lang=t,i.version=s,i.payload=this.payload.length,l.push(i)}if(a){const{name:e,duration:r}=a,i=new rr(e,r);i.msgs=this.msgs,i.bytes=u.inBytes+u.outBytes,i.lang=t,i.version=s,i.payload=this.payload.length,l.push(i)}if(o){const{name:e,duration:r}=o,i=new rr(e,r);i.msgs=this.msgs,i.bytes=u.inBytes+u.outBytes,i.lang=t,i.version=s,i.payload=this.payload.length,l.push(i)}return l}async runCallbacks(){const e=[];if(this.sub){const t=j();e.push(t);let s=0;this.nc.subscribe(this.subject,{max:this.msgs,callback:()=>{s++,1===s&&this.perf.mark("subStart"),s===this.msgs&&(this.perf.mark("subStop"),this.perf.measure("sub","subStart","subStop"),t.resolve())}})}if(this.rep){const t=j();e.push(t);let s=0;this.nc.subscribe(this.subject,{max:this.msgs,callback:(e,r)=>{r.respond(this.payload),s++,1===s&&this.perf.mark("repStart"),s===this.msgs&&(this.perf.mark("repStop"),this.perf.measure("rep","repStart","repStop"),t.resolve())}})}if(this.pub){const t=(async()=>{this.perf.mark("pubStart");for(let e=0;e<this.msgs;e++)this.nc.publish(this.subject,this.payload);await this.nc.flush(),this.perf.mark("pubStop"),this.perf.measure("pub","pubStart","pubStop")})();e.push(t)}if(this.req){const t=(async()=>{if(this.asyncRequests){this.perf.mark("reqStart");const e=[];for(let t=0;t<this.msgs;t++)e.push(this.nc.request(this.subject,this.payload,{timeout:2e4}));await Promise.all(e),this.perf.mark("reqStop"),this.perf.measure("req","reqStart","reqStop")}else{this.perf.mark("reqStart");for(let e=0;e<this.msgs;e++)await this.nc.request(this.subject);this.perf.mark("reqStop"),this.perf.measure("req","reqStart","reqStop")}})();e.push(t)}await Promise.all(e)}async runAsync(){const e=[];if(this.rep){let t=!1;const s=this.nc.subscribe(this.subject,{max:this.msgs}),r=(async()=>{for await(const e of s)t||(this.perf.mark("repStart"),t=!0),e.respond(this.payload);await this.nc.flush(),this.perf.mark("repStop"),this.perf.measure("rep","repStart","repStop")})();e.push(r)}if(this.sub){let t=!1;const s=this.nc.subscribe(this.subject,{max:this.msgs}),r=(async()=>{for await(const e of s)t||(this.perf.mark("subStart"),t=!0);this.perf.mark("subStop"),this.perf.measure("sub","subStart","subStop")})();e.push(r)}if(this.pub){const t=(async()=>{this.perf.mark("pubStart");for(let e=0;e<this.msgs;e++)this.nc.publish(this.subject,this.payload);await this.nc.flush(),this.perf.mark("pubStop"),this.perf.measure("pub","pubStart","pubStop")})();e.push(t)}if(this.req){const t=(async()=>{if(this.asyncRequests){this.perf.mark("reqStart");const e=[];for(let t=0;t<this.msgs;t++)e.push(this.nc.request(this.subject,this.payload,{timeout:2e4}));await Promise.all(e),this.perf.mark("reqStop"),this.perf.measure("req","reqStart","reqStop")}else{this.perf.mark("reqStart");for(let e=0;e<this.msgs;e++)await this.nc.request(this.subject);this.perf.mark("reqStop"),this.perf.measure("req","reqStart","reqStop")}})();e.push(t)}await Promise.all(e)}},e.Empty=t,e.JSONCodec=ae,e.Metric=rr,e.MsgHdrsImpl=ne,e.NatsError=m,e.Nuid=c,e.ServiceError=v,e.ServiceErrorCodeHeader=w,e.ServiceErrorHeader=_,e.StringCodec=oe,e.backoff=I,e.buildAuthenticator=Ve,e.canonicalMIMEHeaderKey=se,e.checkJsError=pt,e.connect=function(e={}){return R={defaultPort:443,urlParseFn:nr,factory:()=>new ir},tr.connect(e)},e.consumerOpts=$t,e.createInbox=S,e.credsAuthenticator=function(t){const i="function"!=typeof t?()=>t:t,n=()=>{const t=/\s*(?:(?:[-]{3,}[^\n]*[-]{3,}\n)(.+)(?:\n\s*[-]{3,}[^\n]*[-]{3,}\n))/gi,n=r.decode(i());let o=t.exec(n);if(!o)throw m.errorForCode(e.ErrorCode.BadCreds);const a=o[1].trim();if(o=t.exec(n),!o)throw m.errorForCode(e.ErrorCode.BadCreds);if(!o)throw m.errorForCode(e.ErrorCode.BadCreds);return{jwt:a,seed:s.encode(o[1].trim())}};return Ke((()=>{const{jwt:e}=n();return e}),(()=>{const{seed:e}=n();return e}))},e.deadline=function(e,t=1e3){const s=new Error("deadline exceeded"),r=j(),i=setTimeout((()=>r.reject(s)),t);return Promise.race([e,r]).finally((()=>clearTimeout(i)))},e.deferred=j,e.delay=k,e.headers=re,e.isFlowControlMsg=dt,e.isHeartbeatMsg=ft,e.jwtAuthenticator=Ke,e.millis=lt,e.nanos=ut,e.nkeyAuthenticator=Je,e.nkeys=De,e.nuid=h,e.syncIterator=function(e){const t=e[Symbol.asyncIterator]();return{async next(){const e=await t.next();return e.done?Promise.resolve(null):Promise.resolve(e.value)}}},e.tokenAuthenticator=He,e.usernamePasswordAuthenticator=Be}));
//# sourceMappingURL=nats.min.js.map

(function() {class SessionMetrics{constructor(b){try{this.storage_key_prefix="glance_",this._jc=window.GLANCE.NATS.JSONCodec(),this.nats=null,this.group_id=b.group_id||"0",this.web_server=b.web_server||"www.glance.net",this.site=b.site||"production",this.device="browser",this.localState={currentUrl:"",winDim:{},docDim:{},docshareStatus:"",visitorDeclined:!1,cobrowseCallId:"",cobrowseKey:""}}catch(a){console.error("Exception in SessionMetrics constructor",a)}}async run(){try{return this.getSettings(`https://${this.web_server}/services/authorizationservice/GetVisitorSettings3?groupid=${this.group_id}&site=${this.site}&service=cobrowse`).then(b=>
{if(b&&b.isMetricsEnabled)return this.metricsCollection({name,pass:b.metricsPassword,user:"visitor",servers:[b.metricsUrl]})})}catch(b){console.error("Exception in SessionMetrics run:",b)}}generateUUID(){return"00000000-0000-0000-0000-000000000000".replace(/[0]/g,b=>(b^crypto.getRandomValues(new Uint8Array(1))[0]&15>>b/4).toString(16))}getStorageItem(b){(b=sessionStorage.getItem(`${this.storage_key_prefix}${b}`))&&(b=JSON.parse(b));return b}setStorageItem(b,a){a=JSON.stringify(a);sessionStorage.setItem(`${this.storage_key_prefix}${b}`,
a)}removeStorageItem(b){sessionStorage.removeItem(`${this.storage_key_prefix}${b}`)}getOrCreateId(b){let a=this.getStorageItem(b);a||(a=this.generateUUID(),this.setStorageItem(b,a));return a}isNewSession(){return null===this.getStorageItem("session_id")}async getSettings(b){const a={method:"GET",headers:new Headers({Accept:"application/json","Content-type":"application/x-www-form-urlencoded"})};let d;await fetch(b,a).then(c=>c.json()).then(c=>{d=c}).catch(c=>{throw Error(`SessionMetrics: Unable to get visitor settings: ${c}`);
});return d}createEvent(b,a,d,c=this.participant_id){!d.url&&this.localState.currentUrl&&(d.url=this.localState.currentUrl);"cobrowse"==b&&(this.localState.cobrowseCallId&&(d.call_id=this.localState.cobrowseCallId),this.localState.cobrowseKey&&(d.key=this.localState.cobrowseKey));const e=`group.${this.group_id}.${this.nats_role}.${this.participant_id}.session.${this.session_id}`;c={specversion:"1.0",id:this.generateUUID(),type:"session.event",source:`${this.nats_role}.${this.participant_id}.${this.device}`,
subject:e,time:(new Date).toISOString(),data:{group_id:this.group_id,session_id:this.session_id,participant_id:c,device:this.device,touchpoint:b,event_type:a,data:JSON.stringify(d,null,0)}};c=this._jc.encode(c);this.nats.publish(e,c);this.debugLogs&&console.log({touchpoint:b,event_type:a,data:d})}};class VisitorSessionMetrics extends SessionMetrics{constructor(b){try{super(b);const a=this.isNewSession();a&&this.resetStorage();this.nats_role="visitor";this.session_status=a?"started":"restarted";this.session_id=this.getOrCreateId("session_id");this.participant_id=this.getOrCreateId("participant_id");this.name=`${this.group_id}-${this.session_id}`;this.debugLogs=!1;this.part_list=this.getStorageItem("part_list")||[]}catch(a){console.error("Exception in VisitorSessionMetrics constructor",a)}}resetStorage(){console.log("Flushing previous session metrics state");
const b=["session_id","participant_id","part_list"];for(const a of b)this.removeStorageItem(a)}async metricsCollection(b){try{this.nats=await window.GLANCE.NATS.connect(b)}catch(a){console.error(a.toString());return}this.createEvent("tracking",this.session_status,{role:"visitor",url:location.href});GLANCE.Cobrowse.Visitor.addEventListener("uploadpage",a=>{if(null==a?0:a.page)this.localState.currentUrl=a.page.pageurl,this.createEvent("cobrowse","navigation",{role:"visitor"});let d;if(null==a?0:null==
(d=a.state)?0:d.windims){let f;this.localState.winDim=null==a?void 0:null==(f=a.state)?void 0:f.windims}let c;if(null==a?0:null==(c=a.state)?0:c.docdims){let f;this.localState.docDim=null==a?void 0:null==(f=a.state)?void 0:f.docdims}let e,g,h;"joined"===(null==a?void 0:null==(e=a.callstate)?void 0:null==(g=e.ssvisitor)?void 0:null==(h=g.glance_screenshare)?void 0:h.status)&&this.createEvent("screenshare","started",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("leavesession",a=>{this.createEvent("cobrowse",
"exited",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("openconnection",a=>{const {href:d,ver:c,ssnid:e}=a;[,a]=e.split(".");d&&(this.localState.currentUrl=d);a&&(this.localState.cobrowseKey=a);this.createEvent("cobrowse","requested",{role:"visitor",url:d,version:c})});GLANCE.Cobrowse.Visitor.addEventListener("outline",a=>{if(a.gesturedone){const d=a.element?"click":"drag",c={role:a.role,agent_name:a.agentname,url:a.url,x1:a.x1,y1:a.y1,x2:a.x2,y2:a.y2,win_dim:this.localState.winDim,
doc_dim:this.localState.docDim};"click"===d&&(c.clicked_element=a.element);this.createEvent("cobrowse",`gesture_${d}`,c)}});GLANCE.Cobrowse.Visitor.addEventListener("addguestrequested",a=>{this.createEvent("add_guest","requested",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("addguestaccepted",a=>{this.createEvent("add_guest","accepted",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("addguestdeclined",a=>{this.createEvent("add_guest","declined",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("navigationassist",
a=>{this.createEvent("cobrowse","navigation_assist",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("rcenabled",a=>{this.createEvent("cobrowse",a.enabled?"remote_assist_started":"remote_assist_ended",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("rcaccepted",a=>{this.createEvent("cobrowse","remote_assist_accepted",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("rcdeclined",a=>{this.createEvent("cobrowse","remote_assist_declined",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorscreensharerequested",
a=>{this.createEvent("screenshare","requested",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorscreenshareaccepted",a=>{this.createEvent("screenshare","accepted",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorscreensharedeclined",a=>{this.createEvent("screenshare","declined",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorscreensharestarted",a=>{this.createEvent("screenshare","started",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("pausevisitorscreenshare",
a=>{this.createEvent("screenshare","paused",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorscreensharepaused",a=>{this.createEvent("screenshare","paused",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorscreenshareended",a=>{this.createEvent("screenshare","ended",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("docsharerequested",a=>{this.createEvent("docshare","requested",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("docsharestatus",
a=>{a="accepted"===this.localState.docshareStatus&&"declined"===a.status?"canceled":a.status;this.createEvent("docshare",a,{role:"agent"});this.localState.docshareStatus=a});GLANCE.Cobrowse.Visitor.addEventListener("agentdownload",a=>{this.createEvent("docshare","downloaded",{role:"agent",file:a.name})});GLANCE.Cobrowse.Visitor.addEventListener("agentdocshare",a=>{a={role:"agent",type:a.type,name:a.name,extension:a.name.split(".").pop()};this.createEvent("docshare","started",a)});GLANCE.Cobrowse.Visitor.addEventListener("navigation",
a=>{this.createEvent("cobrowse","navigation",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideorequested",a=>{this.createEvent("video","requested",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("participantvideopaused",a=>{this.createEvent("video","paused",{role:"guest"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideocreated",a=>{this.createEvent("video","started",{role:this.localState.visitorDeclined?"agent":"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideopaused",
a=>{this.createEvent("video","ended",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideoresumed",a=>{this.createEvent("video","started",{role:"visitor"});this.localState.visitorDeclined=!1});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideoended",a=>{this.createEvent("video","ended",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideoresize",a=>{this.createEvent("video",`resize_${a}`,{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("accessibility",
a=>{this.createEvent("cobrowse",`accessibility_${a?"on":"off"}`,{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("sessioncontinue",a=>{let d;this.localState.cobrowseCallId=null==(d=GLANCE.Cobrowse.Visitor.getCallId())?void 0:d.toString();this.createEvent("cobrowse","started",{})});GLANCE.Cobrowse.Visitor.addEventListener("sessionend",a=>{this.createEvent("cobrowse","ended",{});this.localState.cobrowseCallId="";this.localState.cobrowseKey="";this.part_list=[];this.removeStorageItem("part_list")});
GLANCE.Cobrowse.Visitor.addEventListener("rcevent",a=>{this.createEvent("cobrowse",`remote_assist_${a.type}`,{role:"agent",element_path:a.path})});GLANCE.Cobrowse.Visitor.addEventListener("screensharepaused",a=>{(null==a?0:a.screenshareView)?this.createEvent("glance_screenshare"===(null==a?void 0:a.screenshareView)?"screenshare":"video","ended",{role:"agent"}):this.createEvent("video","paused",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("screenshareresumed",a=>{(null==a?0:a.screenshareView)&&
this.createEvent("glance_screenshare"===(null==a?void 0:a.screenshareView)?"screenshare":"video","started",{role:"agent"})});GLANCE.Cobrowse.Visitor.addEventListener("rcrequested",()=>{this.createEvent("cobrowse","remote_assist_requested",{role:"agent"})});window.addEventListener("message",a=>{"docviewerclosed"===a.data&&this.createEvent("docshare","ended",{role:"visitor"})});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideodeclined",a=>{this.localState.visitorDeclined=!0;this.createEvent("video",
"declined",{role:"visitor",camera_status:a.camerastatus,video:a.video,video_bg_filter:a.videobgfilter,video_bg_type:a.videobgtype,video_source:a.videosource})});GLANCE.Cobrowse.Visitor.addEventListener("visitorvideoaccepted",a=>{this.createEvent("video","accepted",{role:"visitor",camera_status:a.camerastatus,video:a.video,video_bg_filter:a.videobgfilter,video_bg_type:a.videobgtype,video_source:a.videosource})});GLANCE.Cobrowse.Visitor.addEventListener("agents",a=>{a=a.agentlist;const d=this.computeRosterChanges(a);
for(const c of d)this.createEvent("cobrowse",c.joined?"joined":"exited",{role:c.data.role,name:c.data.name,agent_user_id:c.data.partneruserid,agent_username:c.data.username,agent_role:c.data.agentrole},c.data.guestid.toString());this.part_list=a;this.setStorageItem("part_list",a)})}computeRosterChanges(b){let a=[];for(var d of b){let c=!1;for(const e of this.part_list)if(d.guestid===e.guestid){c=!0;break}c||a.push({joined:!0,data:d})}for(const c of this.part_list){d=!1;for(const e of b)if(e.guestid===
c.guestid){d=!0;break}d||a.push({joined:!1,data:c})}return a}}window.GLANCE=window.GLANCE||{};window.GLANCE.VisitorSessionMetrics=VisitorSessionMetrics;}).call(window);
//# sourceMappingURL=map.js.map
